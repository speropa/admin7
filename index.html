<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Ujian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    /* General body and layout styles */
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7f6;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .sidebar {
      width: 80px;
      background-color: #2c3e50;
      color: white;
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
      flex-shrink: 0;
      z-index: 20;
    }
    .sidebar.expanded {
      width: 200px;
      padding: 20px;
    }
    .main-content {
      flex-grow: 1;
      padding: 20px;
      background-color: #f4f7f6;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      height: 100vh;
      box-sizing: border-box;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    /* Sidebar specific styles */
    .sidebar .logo-container {
      text-align: center;
      margin-bottom: 30px;
      width: 100%;
      padding: 0 10px;
      box-sizing: border-box;
    }
    .sidebar.expanded .logo-container { padding: 0; }
    .sidebar .logo {
      width: 50px; height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #3498db;
      padding: 3px;
      background-color: white;
      transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
    }
    .sidebar.expanded .logo { width: 70px; height: 70px; }
    .sidebar h2 {
      font-size: 1em;
      margin-top: 10px;
      color: #ecf0f1;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
      height: 0;
    }
    .sidebar.expanded h2 { opacity: 1; height: auto; }
    .sidebar-nav { width: 100%; flex-grow: 1; }
    .sidebar-nav button {
      background-color: transparent;
      color: white; border: none; padding: 12px 0;
      margin-bottom: 10px; width: 100%; text-align: center;
      font-size: 16px; border-radius: 8px; cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease, padding 0.3s ease-in-out;
      display: flex; align-items: center; justify-content: center; gap: 0;
    }
    .sidebar-nav button:hover { background-color: #34495e; transform: translateX(5px); }
    .sidebar-nav button.active {
      background-color: #3498db; font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .sidebar-nav button i { font-size: 18px; flex-shrink: 0; }
    .sidebar-nav button span {
      opacity: 0; transition: opacity 0.3s ease-in-out;
      white-space: nowrap; overflow: hidden; max-width: 0;
    }
    .sidebar.expanded .sidebar-nav button { justify-content: flex-start; padding-left: 20px; gap: 10px; }
    .sidebar.expanded .sidebar-nav button span { opacity: 1; max-width: 150px; }
    .sidebar .footer {
      width: 100%; padding: 20px 10px;
      box-sizing: border-box; opacity: 0;
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap; overflow: hidden; text-align: center;
    }
    .sidebar.expanded .footer { opacity: 1; }

    /* Forms and Buttons */
    input, select, textarea {
      padding: 12px; margin: 8px 0; width: 100%;
      box-sizing: border-box; font-size: 16px;
      border: 1px solid #ccc; border-radius: 6px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    button {
      padding: 12px 25px; margin: 10px auto;
      display: block; font-size: 16px; cursor: pointer;
      background-color: #3498db; color: white; border: none;
      border-radius: 6px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .text-button {
      padding: 10px 20px; margin: 0; font-size: 15px;
      cursor: pointer; border: none; border-radius: 6px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-flex; align-items: center; gap: 8px;
      text-align: center; white-space: nowrap;
    }
    .text-button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .text-button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .text-button.blue-gray { background-color: #607d8b; color: white; }
    .text-button.blue-gray:hover { background-color: #455a64; }
    .text-button.green { background-color: #4CAF50; color: white; }
    .text-button.green:hover { background-color: #43A047; }
    .text-button.red { background-color: #f44336; color: white; }
    .text-button.red:hover { background-color: #e53935; }
    .text-button.gray { background-color: #9e9e9e; color: white; }
    .text-button.gray:hover { background-color: #757575; }
    .text-button.light-blue { background-color: #2196F3; color: white; }
    .text-button.light-blue:hover { background-color: #1976D2; }
    .text-button.orange { background-color: #FF9800; color: white; }
    .text-button.orange:hover { background-color: #FB8C00; }
    .icon-button {
      background: none; border: none; cursor: pointer;
      padding: 8px; margin: 0; display: inline-flex;
      align-items: center; justify-content: center;
      width: 28px; height: 28px; border-radius: 50%;
      transition: background-color 0.2s ease, transform 0.1s ease;
      flex-shrink: 0;
    }
    .icon-button:hover { background-color: #cfe2f3; transform: translateY(-1px); }
    .icon-button:active { transform: translateY(0); }
    .icon-button i { font-size: 16px; color: #2c3e50; }
    .icon-button:hover i { color: #2c3e50; }
    .icon-button.edit i { color: #3498db; }
    .icon-button.delete i { color: #e74c3c; }
    .icon-button.reset i { color: #8e44ad; }
    .icon-button.submit i { color: #27ae60; }
    .icon-button.erase i { color: #f39c12; }
    .icon-button.pdf i { color: #c0392b; }

    /* Tables */
    .table-responsive {
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border: 1px solid #e0e0e0; padding: 10px;
      word-wrap: break-word; text-align: left;
      vertical-align: middle;
    }
    th {
      background-color: #ecf0f1; text-align: center;
      font-weight: bold; color: #2c3e50;
      white-space: nowrap;
    }
    tr:nth-child(even) { background-color: #f9f9f9; }
    #tokenTableBody td, #studentTableBody td, #scoreTableBody td {
        white-space: nowrap;
    }
    #tokenTableBody td:nth-child(2), /* MAPEL & KELAS */
    #tokenTableBody td:nth-child(5) { /* PROGRES */
        white-space: normal;
    }
    #tokenTableBody td:nth-child(4) { /* WAKTU UJIAN */
        text-align: center;
        white-space: normal;
    }
    #scoreTableBody td:nth-child(2) { /* NAMA SISWA */
        white-space: normal;
    }
    
    .token-status {
      cursor: pointer;
      font-weight: bold;
      text-decoration: underline;
    }
    .token-status.on { color: #27ae60; }
    .token-status.off { color: #e74c3c; }
    
    #locationSettingsTableBody td:nth-child(n), #lockSettingsTableBody td:nth-child(n) { text-align: center; }
    #locationSettingsTableBody td:nth-child(4) button, #lockSettingsTableBody td:nth-child(4) button { display: inline-block; margin: 0; }
    #tokenTableBody td:nth-child(1), #studentTableBody td:nth-child(1), #scoreTableBody td:nth-child(1) { text-align: center; }
    #studentTableBody td:nth-child(2), #studentTableBody td:nth-child(4), #studentTableBody td:nth-child(5), #studentTableBody td:nth-child(6), #studentTableBody td:last-child { text-align: center; }
    .action-buttons-group { display: flex; justify-content: center; gap: 5px; flex-wrap: nowrap; flex-shrink: 0; }
    
    /* Modals and Overlays */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; padding: 30px; border-radius: 10px;
      width: 90%; max-width: 450px; box-sizing: border-box;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2); text-align: center;
    }
    .modal h4 { color: #2c3e50; margin-top: 0; margin-bottom: 20px; font-size: 1.5em; }
    .modal p { margin-bottom: 20px; color: #34495e; }
    .modal button {
      margin: 8px; display: inline-block; width: auto; min-width: 100px;
      padding: 10px 20px; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .modal button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .modal button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .modal button.confirm-button { background-color: #28a745; color: white; }
    .modal button.confirm-button:hover { background-color: #218838; }
    .modal button.cancel-button { background-color: #dc3545; color: white; }
    .modal button.cancel-button:hover { background-color: #c82333; }
    .modal button.warning-button { background-color: #ffc107; color: black; }
    .modal button.warning-button:hover { background-color: #e0a800; }
    .modal button.gray { background-color: #9e9e9e; color: white; }
    .modal button.gray:hover { background-color: #757575; }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 99999;
    }
    .spinner {
      border: 5px solid rgba(0, 0, 0, 0.1);
      width: 40px; height: 40px; border-radius: 50%;
      border-left-color: #3498db;
      animation: spin 1s ease infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #notification {
      display: none; position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%); background-color: #28a745;
      color: white; padding: 15px 25px; border-radius: 8px;
      z-index: 10000; text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: bold;
    }
    
    /* Utility and other styles */
    .error { color: #e74c3c; font-size: 14px; text-align: center; margin-top: 5px; }
    .footer { text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 13px; }
    .date-time { font-size: 14px; color: #555; }
    .login-link { color: #3498db; text-decoration: underline; font-weight: bold; transition: color 0.3s ease; }
    .login-link:hover { color: #2980b9; cursor: pointer; }
    .login-link:active { color: #e74c3c; }
    .controls-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; }
    .actions-group, .filters-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filters-group input, .filters-group select { margin: 0; }
    .filters-group label { margin-right: 5px; font-weight: 500; }
    .answer-key-input-group { display: flex; gap: 10px; align-items: flex-end; margin: 8px 0; }
    .answer-key-input-group > div { display: flex; flex-direction: column; }
    .answer-key-input-group label { font-size: 0.8em; color: #555; margin-bottom: 2px; }
    .answer-key-input-group input { margin: 0; height: auto; }
    .answer-key-input-group .count-input { flex-shrink: 0; width: 80px; text-align: center; background-color: #e9ecef; cursor: default; }
    .answer-key-input-group .key-input { flex-grow: 1; }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; height: auto; position: relative; border-radius: 0; padding: 15px 10px; }
      .sidebar.expanded { width: 100%; }
      .sidebar .logo-container { padding: 0; }
      .sidebar .logo, .sidebar.expanded .logo { width: 40px; height: 40px; }
      .sidebar h2 { font-size: 0.9em; height: auto; opacity: 1; }
      .sidebar-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
      .sidebar-nav button { width: auto; padding: 10px 12px; font-size: 14px; flex-grow: 1; justify-content: center; }
      .sidebar-nav button span, .sidebar.expanded .sidebar-nav button span { display: none; }
      .sidebar-nav button i { margin-right: 0; }
      .sidebar .footer { opacity: 1; height: auto; }
      .main-content { padding: 15px; height: auto; min-height: 100vh; }
      .container { padding: 15px; }
      input, select, textarea { font-size: 14px; padding: 10px; }
      button, .text-button { font-size: 14px; padding: 10px 15px; }
      table { font-size: 11px; }
      th, td { padding: 8px; }
      .action-buttons-group { flex-wrap: wrap; justify-content: center; gap: 3px; }
      .action-buttons-group .icon-button { width: 24px; height: 24px; }
      .action-buttons-group .icon-button i { font-size: 14px; }
    }
    @media (max-width: 480px) {
      .sidebar-nav button span { display: none; }
      .sidebar-nav button { padding: 10px; }
      .controls-header { justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo SMPN 2 Pajangan" class="logo">
      <h2>SMPN 2 PAJANGAN</h2> </div>
    <nav class="sidebar-nav">
      <button id="tokenMenuBtn" data-section-id="tokenSection" onclick="handleMenuClick(this)">
        <i class="fas fa-key"></i> <span>Token</span>
      </button>
      <button id="pesertaMenuBtn" data-section-id="studentSection" onclick="handleMenuClick(this)">
        <i class="fas fa-users"></i> <span>Peserta</span>
      </button>
      <button id="scoreMenuBtn" data-section-id="scoreSection" onclick="handleMenuClick(this)">
        <i class="fas fa-chart-bar"></i> <span>Nilai Ujian</span>
      </button>
      <button id="aturanMenuBtn" data-section-id="rulesSection" onclick="handleMenuClick(this)">
        <i class="fas fa-cog"></i> <span>Aturan</span>
      </button>
      <button data-action="promptLogout" onclick="handleMenuClick(this)">
        <i class="fas fa-sign-out-alt"></i> <span>Keluar</span>
      </button>
    </nav>
    <div class="footer" style="margin-top: auto; padding-top: 20px;">
      <div>@Admin SMPN 2 Pajangan</div>
      <div id="adminDateTime" class="date-time" style="color: #bdc3c7;"></div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content" id="mainContent">
    <!-- Login Section -->
    <div class="container" id="loginSection">
      <h3 style="text-align: center; color: #2c3e50;">LOGIN ADMINISTRASI</h3>
      <p id="loginError" class="error"></p>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p style="text-align: center; font-size: 14px; margin-top: 10px;">
        Halaman login ujian siswa?
        <a href="http://smp2pajangan.github.io/loginujian" class="login-link">Loginujian</a>
      </p>
      <div class="footer">
        <div>@Admin SMPN 2 Pajangan</div>
        <div id="currentTime" class="date-time"></div>
      </div>
    </div>

    <!-- Dashboard Content (hidden by default) -->
    <div id="dashboardContent" style="display:none;">
      <!-- Token Management Section -->
      <div id="tokenSection" class="dashboard-section container">
        <h1 id="tokenSectionTitle" style="text-align: left; color: #34495e;">Manajemen Token</h1>
        <div class="controls-header">
            <div class="actions-group">
                <button onclick="openAddTokenModal()" class="text-button green">
                    <i class="fas fa-plus"></i> Tambah Token
                </button>
                <button class="text-button gray" onclick="openCopyPrintModal('tokenTable', 'Cetak Daftar Token')"><i class="fas fa-print"></i> Cetak</button>
            </div>
            <div class="filters-group">
                 <input type="text" id="tokenSearchSubject" placeholder="Cari Mapel..." />
            </div>
        </div>
        <p style="font-size: 11px; color: #555; margin-top: 10px; margin-bottom: 10px; text-align: center;">
          Token yang ditambahkan akan dihapus otomatis setelah 30 hari!
        </p>
        <div class="table-responsive">
          <table id="tokenTable">
            <thead>
              <tr>
                <th>NO</th>
                <th>MAPEL & KELAS</th>
                <th>TOKEN</th>
                <th style="text-align: center;">WAKTU UJIAN</th>
                <th style="text-align: center;">PROGRES</th>
                <th>AKSI</th>
              </tr>
            </thead>
            <tbody id="tokenTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Rules Section -->
      <div id="rulesSection" class="dashboard-section container">
        <h1 id="rulesSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Pengaturan Lokasi dan Penguncian</h1>
        
        <div style="margin-bottom: 20px;">
          <h3>ATUR AKSES LOKASI</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Aturan akses lokasi digunakan untuk mengatur akses login siswa hanya sesuai radius lokasi saja.
          </p>
          <div class="table-responsive">
            <table id="locationSettingsTable">
              <thead>
                <tr>
                  <th>KOORDINAT LOKASI</th>
                  <th>RADIUS</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="locationSettingsTableBody"></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>ATUR KUNCI</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Aturan kunci digunakan untuk mengatur kunci yang harus dimasukkan siswa ketika mereka sedang terkunci karena keluar dalam mode fullscreen dengan melebihi batas toleransi.
          </p>
          <div class="table-responsive">
            <table id="lockSettingsTable">
              <thead>
                <tr>
                  <th>KUNCI</th>
                  <th>BATAS TOLERANSI</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="lockSettingsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Student Management Section -->
      <div id="studentSection" class="dashboard-section container">
        <h1 id="studentSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Manajemen Peserta</h1>
        <div class="controls-header">
            <div class="actions-group">
                <button onclick="openAddStudentModal()" class="text-button green"><i class="fas fa-user-plus"></i> Tambah</button>
                <button class="text-button blue-gray" onclick="openImportStudentModal()"><i class="fas fa-file-csv"></i> Impor</button>
                <button class="text-button gray" onclick="showPrintInfoModal()"><i class="fas fa-print"></i> Cetak Kartu</button>
                <button class="text-button red" onclick="openEmptyStudentsModal()"><i class="fas fa-trash-alt"></i> Kosongkan</button>
            </div>
        </div>
        <div class="controls-header">
            <div class="filters-group" style="flex-grow: 1; justify-content: flex-end;">
                <input type="text" id="studentSearchId" placeholder="Cari ID..." style="max-width: 150px;"/>
                <input type="text" id="studentSearchName" placeholder="Cari Nama..." style="max-width: 200px;" />
                <input type="text" id="studentSearchClass" placeholder="Cari Kelas..." style="max-width: 150px;" />
                <select id="examStatusFilter">
                    <option value="">Semua Status</option>
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table id="studentTable">
              <thead>
                <tr>
                  <th>NO</th>
                  <th>ID SISWA</th>
                  <th>NAMA</th>
                  <th>KELAS</th>
                  <th>RUANG</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="studentTableBody"></tbody>
            </table>
        </div>
      </div>

      <!-- Score Section -->
      <div id="scoreSection" class="dashboard-section container">
        <h1 id="scoreSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Daftar Nilai Ujian</h1>
        <div class="controls-header">
            <div class="actions-group">
                <button class="text-button gray" onclick="openCopyPrintModal('scoreTable', 'Cetak Daftar Nilai')"><i class="fas fa-print"></i> Cetak</button>
            </div>
            <div class="filters-group">
                <input type="text" id="scoreSearchName" placeholder="Cari Nama Siswa" />
                <input type="text" id="scoreSearchClass" placeholder="Cari Kelas (misal: 7A)" />
            </div>
        </div>
        <div class="table-responsive">
          <table id="scoreTable">
            <thead>
              <tr id="scoreTableHeader">
                <th>NO</th>
                <th>NAMA SISWA</th>
                <th>KELAS</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody"></tbody>
          </table>
        </div>
      </div>
      </div>
  </div>

  <!-- All Modals -->
  <div id="addTokenModal" class="modal">
    <div class="modal-content">
      <h4>Tambah Token Baru</h4>
      <form id="addTokenForm">
        <label>Mata Pelajaran</label>
        <input type="text" id="addSubject" placeholder="Gunakan kapital" required />
        <label>Kelas</label>
        <input type="text" id="addKelas" placeholder="Berupa angka saja (7)" required />
        <label>Token Ujian (Base Token)</label>
        <input type="text" id="addToken" placeholder="Berupa huruf/angka (gunakan kapital)" required />
        
        <label for="addGoogleDriveUrl">Link Google Drive PDF Soal</label>
        <input type="url" id="addGoogleDriveUrl" placeholder="Contoh: https://drive.google.com/file/d/..." required />
        <p id="addGoogleDriveUrlError" class="error"></p>

        <div class="answer-key-input-group">
          <div class="count-input-container">
            <label for="addAnswerKeyCount">Jumlah Soal</label>
            <input type="text" id="addAnswerKeyCount" readonly class="count-input" value="0" />
          </div>
          <div class="key-input-container">
            <label for="addAnswerKey">Kunci Jawaban</label>
            <input type="text" id="addAnswerKey" placeholder="Contoh: A,B,C,D,D" required class="key-input" />
          </div>
        </div>
        <p id="addAnswerKeyError" class="error"></p>

        <label>Waktu Token Dibuka</label>
        <input type="datetime-local" id="addStartTime" required />
        <label>Waktu Token Ditutup</label>
        <input type="datetime-local" id="addEndTime" required />
        <p id="addErrorMsg" class="error"></p>
        <button type="submit">Tambah Token</button>
        <button type="button" onclick="closeAddTokenModal()" class="cancel-button">Batal</button>
      </form>
    </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h4>Edit Token</h4>
      <form id="modalForm">
        <label>Mata Pelajaran</label>
        <input type="text" id="editSubject" required />
        <label>Kelas</label>
        <input type="text" id="editKelas" placeholder="Berupa angka saja (7)" required />
        <label>Token Ujian</label>
        <input type="text" id="editToken" required />
        
        <label for="editGoogleDriveUrl">Link Google Drive PDF Soal</label>
        <input type="url" id="editGoogleDriveUrl" placeholder="Contoh: https://drive.google.com/file/d/FILE_ID/view?usp=sharing" required />
        <p id="editGoogleDriveUrlError" class="error"></p>

        <div class="answer-key-input-group">
          <div class="count-input-container">
            <label for="editAnswerKeyCount">Jumlah Soal</label>
            <input type="text" id="editAnswerKeyCount" readonly class="count-input" value="0" />
          </div>
          <div class="key-input-container">
            <label for="editAnswerKey">Kunci Jawaban</label>
            <input type="text" id="editAnswerKey" placeholder="Hanya A,B,C,D dipisah koma" required class="key-input" />
          </div>
        </div>
        <p id="editAnswerKeyError" class="error"></p>

        <label>Waktu Token Dibuka</label>
        <input type="datetime-local" id="editStartTime" required />
        <label>Waktu Token Ditutup</labeL>
        <input type="datetime-local" id="editEndTime" required />
        <p id="editErrorMsg" class="error"></p>
        <button type="submit">Simpan</button>
        <button type="button" onclick="closeEditModal()" class="cancel-button">Batal</button>
      </form>
    </div>
  </div>

  <div id="addStudentModal" class="modal">
      <div class="modal-content">
          <h4>Tambah Peserta Baru</h4>
          <form id="addStudentForm">
              <p id="addStudentErrorMsg" class="error"></p>
              <label for="newStudentId">ID Siswa</label>
              <input type="text" id="newStudentId" placeholder="Contoh: 001" required />
              <label for="newStudentName">Nama Siswa</label>
              <input type="text" id="newStudentName" placeholder="Nama Lengkap Siswa" required />
              <label for="newStudentClass">Kelas</label>
              <input type="text" id="newStudentClass" placeholder="Contoh: 7A, 7B, 7C" required />
              <label for="newStudentRoom">Ruang</label>
              <input type="text" id="newStudentRoom" placeholder="Contoh: 01, 02, dsb" required />
              <button type="submit">Tambah Peserta</button>
              <button type="button" onclick="closeAddStudentModal()" class="cancel-button">Batal</button>
          </form>
      </div>
  </div>


  <div id="deleteModal" class="modal"><div class="modal-content"><p>Yakin ingin menghapus token ini?</p><button onclick="confirmDelete()" class="confirm-button">Hapus</button><button onclick="closeDeleteModal()" class="cancel-button">Batal</button></div></div>
  <div id="forceActiveModal" class="modal"><div class="modal-content"><h4>Aktifkan Token Secara Paksa?</h4><p>Token ini akan dapat diakses kapanpun, mengabaikan jadwal yang ada.</p><div><label for="forceActivePassword">Password Admin:</label><input type="password" id="forceActivePassword"><p id="forceActivePasswordError" class="error"></p></div><button onclick="confirmForceActive()" class="confirm-button">Ya, Aktifkan</button><button onclick="closeForceActiveModal()" class="cancel-button">Batal</button></div></div>
  <div id="forceInactiveModal" class="modal"><div class="modal-content"><h4>Nonaktifkan Mode Paksa?</h4><p>Token akan kembali ke pengaturan jadwal semula.</p><button onclick="confirmForceInactive()" class="confirm-button">Ya, Nonaktifkan</button><button onclick="closeForceInactiveModal()" class="cancel-button">Batal</button></div></div>
  <div id="notification"><span id="notificationMessage"></span></div>
  <div id="copyPrintModal" class="modal"><div class="modal-content"><h4 id="copyPrintModalTitle"></h4><button onclick="copyTableToClipboard()" class="confirm-button">Salin Tabel</button><p style="font-size: 0.9em; color: #555; margin-top: 15px;">Salin tabel kemudian paste ke word atau excel.</p><button onclick="closeCopyPrintModal()" class="cancel-button">Batal</button></div></div>
  <div id="printInfoModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closePrintInfoModal()">Ã—</span><p style="margin-bottom: 20px;">Maaf, sementara cetak kartu belum bisa. Silahkan download 2 file excel dan word dibawah ini:</p><p style="margin-bottom: 10px;"><a href="https://drive.google.com/uc?export=download&id=1rLFyKUzQloJi7LAnO-x7Q-lK0BzdxQv3" target="_blank">File Word (disini)</a></p><p style="margin-bottom: 20px;"><a href="https://drive.google.com/uc?export=download&id=14uoOXQScECxd9hXD4AIMJjFBlmbSAgxS" target="_blank">File Excel (disini)</a></p><p style="font-size: 14px; color: #555;">**Catatan:** ISI ID_SISWA SESUAI DENGAN TEMPLATE CSV!</p></div></div>
  <div id="setlokasiModal" class="modal"><div class="modal-content" style="text-align: center;"><h4>Pengaturan Lokasi</h4><button onclick="aktifkanLokasi()" class="confirm-button">Aktifkan</button><button onclick="openGantiRadiusModal()" class="warning-button">Ganti Radius</button><button onclick="nonaktifkanLokasi()" class="cancel-button">Nonaktifkan</button><button onclick="closeSetlokasiModal()" class="gray text-button" style="margin-top: 10px;">Batal</button></div></div>
  <div id="gantiRadiusModal" class="modal"><div class="modal-content"><h4>Ganti Radius Lokasi (meter)</h4><label for="radiusMeter">Radius (meter):</label><input type="number" id="radiusMeter" placeholder="Contoh: 75" required /><div style="text-align: center; margin-top: 10px;"><button onclick="gantiRadiusDanAktifkan()" class="confirm-button">Ganti & Aktifkan</button><button onclick="closeGantiRadiusModal()" class="cancel-button">Batal</button></div></div></div>
  <div id="setLockModal" class="modal"><div class="modal-content" style="text-align: center;"><h4>Pengaturan Kunci</h4><button onclick="aktifkanKunci()" class="confirm-button">Aktifkan</button><button onclick="openGantiKunciBatasModal()" class="warning-button">Ganti Kunci/Batas</button><button onclick="nonaktifkanKunci()" class="cancel-button">Nonaktifkan</button><button onclick="closeSetLockModal()" class="gray text-button" style="margin-top: 10px;">Batal</button></div></div>
  <div id="gantiKunciBatasModal" class="modal"><div class="modal-content"><h4>Ganti Kunci dan Batas Toleransi</h4><label for="lockKeyInput">Kunci:</label><input type="text" id="lockKeyInput" placeholder="Contoh: KUNCIAMAN" required /><label for="toleranceLimitInput">Batas Toleransi:</label><input type="number" id="toleranceLimitInput" placeholder="Contoh: 3" required /><p id="lockSettingsError" class="error"></p><div style="text-align: center; margin-top: 10px;"><button onclick="gantiKunciDanBatas()" class="confirm-button">Ganti & Aktifkan</button><button onclick="closeGantiKunciBatasModal()" class="cancel-button">Batal</button></div></div></div>
  <div id="accessDetailModal" class="modal"><div class="modal-content" style="max-width: 700px;"><h4 id="accessDetailTokenTitle">Detail Akses Token: [Token]</h4><div class="table-responsive"><table id="accessDetailTable"><thead><tr><th>NO</th><th>ID SISWA</th><th>NAMA SISWA</th><th>KELAS</th><th>STATUS AKSES</th><th>WAKTU AKSES PERTAMA</th></tr></thead><tbody id="accessDetailTableBody"></tbody></table></div><button onclick="closeAccessDetailModal()" style="margin-top: 20px;">Tutup</button></div></div>
  <div id="editStudentModal" class="modal"><div class="modal-content"><h4>Edit Data Siswa</h4><p id="editStudentErrorMsg" class="error"></p><label for="modalStudentId">ID Siswa</label><input type="text" id="modalStudentId" required /><label for="modalStudentName">Nama Siswa</label><input type="text" id="modalStudentName" required /><label for="modalStudentClass">Kelas</label><input type="text" id="modalStudentClass" placeholder="Contoh: 7A, 7B, 7C" required /><label for="modalStudentRoom">Ruang</label><input type="text" id="modalStudentRoom" placeholder="Contoh: 01, 02, dsb" required /> <button onclick="confirmEditStudent()">Simpan</button><button type="button" onclick="closeEditStudentModal()" class="cancel-button">Batal</button></div></div>
  <div id="deleteStudentConfirmModal" class="modal"><div class="modal-content"><p>Yakin ingin menghapus siswa ini?</p><button onclick="confirmDeleteStudent()" class="confirm-button">Hapus</button><button onclick="closeDeleteStudentConfirmModal()" class="cancel-button">Batal</button></div></div>
  <div id="importStudentModal" class="modal"><div class="modal-content"><h4>Import Data Peserta dari CSV</h4><p style="font-size: 0.9em; color: #555; text-align: left;">Perhatikan hal-hal berikut!<br>1. Siapkan data peserta dengan 4 kolom: ID Peserta (angka), Nama Lengkap, Kelas, dan Ruang<br>2. Simpan file dengan format *.csv (comma delimited)<br>3. Pastikan tidak ada kolom tambahan</p><a href="https://drive.google.com/uc?export=download&id=16rzsLjQ3AVm0wIPqWnzsauzbrwGfO7An" target="_blank" style="display: block; text-align: center; margin: 15px 0; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">Unduh Template CSV</a> <input type="file" id="csvFileInput" accept=".csv" style="margin-top: 15px; margin-bottom: 10px;" /><p id="importFileError" class="error"></p><button onclick="processCsvFile()">Mulai Impor</button><button onclick="closeImportStudentModal()" class="cancel-button">Batal</button></div></div>
  <div id="importResultModal" class="modal"><div class="modal-content"><h4>Hasil Impor Data Siswa</h4><p id="importResultSummary"></p><ul id="importResultDetails" style="text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px;"></ul><button onclick="closeImportResultModal()">Tutup</button></div></div>
  <div id="emptyStudentsModal" class="modal"><div class="modal-content"><h4>Kosongkan Daftar Peserta</h4><p>Anda yakin ingin menghapus <b>SEMUA</b> data peserta? Tindakan ini tidak dapat dibatalkan.</p><div><label for="emptyStudentsPassword">Password Admin:</label><input type="password" id="emptyStudentsPassword"><p id="emptyStudentsPasswordError" class="error"></p></div><button onclick="confirmEmptyStudents()" class="confirm-button">Konfirmasi Hapus Semua</button><button onclick="closeEmptyStudentsModal()" class="cancel-button">Batal</button></div></div>
  <div id="logoutConfirmModal" class="modal"><div class="modal-content"><h4>Konfirmasi Logout</h4><p>Anda yakin ingin keluar dari panel admin?</p><button onclick="confirmLogout()" class="confirm-button">Ya, Keluar</button><button onclick="closeLogoutModal()" class="cancel-button">Batal</button></div></div>
  <div id="resetStudentModal" class="modal"><div class="modal-content"><h4>Reset Status Login Siswa</h4><p>Anda yakin ingin mereset status login siswa <b id="resetStudentNameDisplay"></b> (ID: <b id="resetStudentIdDisplay"></b>)?</p><p style="font-size: 0.9em; color: #555;">Ini akan memaksa siswa untuk login ulang jika mereka sedang dalam sesi.</p><button onclick="confirmResetStudent()" class="confirm-button">Reset</button><button onclick="closeResetStudentModal()" class="cancel-button">Batal</button></div></div>
  <div id="submitAnswerModal" class="modal"><div class="modal-content"><h4>Kirim Jawaban Siswa (Manual)</h4><p>Anda yakin ingin menandai semua ujian yang sedang dikerjakan siswa <b id="submitStudentNameDisplay"></b> (ID: <b id="submitStudentIdDisplay"></b>) sebagai 'Sudah submit'?</p><p style="font-size: 0.9em; color: #555;">Tindakan ini akan mengunci jawaban siswa untuk ujian yang relevan.</p><button onclick="confirmSubmitAnswer()" class="confirm-button">Kirim Jawaban</button><button onclick="closeSubmitAnswerModal()" class="cancel-button">Batal</button></div></div>
  <div id="deleteAnswerModal" class="modal"><div class="modal-content"><h4>Hapus Semua Jawaban Siswa</h4><p>Anda yakin ingin menghapus <b>SEMUA</b> jawaban dan status submit untuk siswa <b id="deleteAnswerStudentNameDisplay"></b> (ID: <b id="deleteAnswerStudentIdDisplay"></b>)?</p><p style="font-size: 0.9em; color: #e74c3c; font-weight: bold;">Tindakan ini tidak dapat dibatalkan!</p><div><label for="deleteAnswerPassword">Password Admin:</label><input type="password" id="deleteAnswerPassword"><p id="deleteAnswerPasswordError" class="error"></p></div><button onclick="confirmDeleteAnswer()" class="confirm-button">Hapus Jawaban</button><button onclick="closeDeleteAnswerModal()" class="cancel-button">Batal</button></div></div>
  <div id="loadingOverlay" class="loading-overlay" style="display: none;"><div class="spinner"></div></div>

  <!-- JavaScript Module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const allFirebaseConfigs = {
        '7ABC': { 
            apiKey: "AIzaSyBJBl_HWsOsnBBI1EPs1yQlJd0Hso8HcSo", 
            authDomain: "ujianpdf-7abc.firebaseapp.com", 
            databaseURL: "https://ujianpdf-7abc-default-rtdb.firebaseio.com",
            projectId: "ujianpdf-7abc", 
            storageBucket: "ujianpdf-7abc.firebasestorage.app", 
            messagingSenderId: "1035978389542", 
            appId: "1:1035978389542:web:413eb32b04c0d09bc48ee7" 
        },
        '7DEF': { 
            apiKey: "AIzaSyDQKdbwaG0Tg7_tfHs0hCbNR3xlqT3vWLA", 
            authDomain: "ujianpdf-7def.firebaseapp.com", 
            databaseURL: "https://ujianpdf-7def-default-rtdb.firebaseio.com",
            projectId: "ujianpdf-7def", 
            storageBucket: "ujianpdf-7def.firebasestorage.app", 
            messagingSenderId: "210211262444", 
            appId: "1:210211262444:web:a06a988913ede65369bac9" 
        }
    };
    
    const dbInstances = {};
    for (const groupKey in allFirebaseConfigs) {
        if (allFirebaseConfigs.hasOwnProperty(groupKey)) {
            const config = allFirebaseConfigs[groupKey];
            const appInstance = initializeApp(config, groupKey); 
            dbInstances[groupKey] = getDatabase(appInstance);
        }
    }
    
    const gradeToDbGroupMap = { '7': ['7ABC', '7DEF'] };
    const rombelToDbMap = { '7A': '7ABC', '7B': '7ABC', '7C': '7ABC', '7D': '7DEF', '7E': '7DEF', '7F': '7DEF' };

    const ADMIN_USER = "admin";
    const ADMIN_PASS = "12345678";
    const THIRTY_DAYS_IN_MS = 30 * 24 * 60 * 60 * 1000;
    const INACTIVITY_TIMEOUT = 60 * 60 * 1000;
    const VALID_ROMBELS = ['7A', '7B', '7C', '7D', '7E', '7F'];
    const defaultLocationCoordinate = "-7.8589546,110.2655596";
    
    let inactivityTimer;
    let isSidebarExpanded = false;
    let isImporting = false;
    
    let tokenCache = [];
    let studentCache = [];
    let tokenAccessStatus = {};
    let submittedExamsCache = {};
    let studentAnswersCache = {};
    let consolidatedTokensMap = new Map();

    let currentConsolidatedTokenInfo = null;
    let currentStudentKey = null;
    let deleteStudentKey = null;
    let studentKeyForAction = null;
    let studentIdForAction = null;
    let studentNameForAction = null;
    let studentClassForAction = null;
    let currentTableIdToCopy = '';
    
    let isLocationEnabledAdmin = false;
    let allowedRadiusMeterAdmin = 75;
    let isLockEnabledAdmin = false;
    let currentLockKeyAdmin = "KUNCI";
    let toleranceLimitAdmin = 3;
    const allSetlokasiRefs = Object.values(dbInstances).map(db => ref(db, 'setlokasi'));
    const allLockSettingsRefs = Object.values(dbInstances).map(db => ref(db, 'lock_settings'));
    
    const sidebar = document.getElementById('sidebar');
    const loginSection = document.getElementById('loginSection');
    const dashboardContent = document.getElementById('dashboardContent');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const tokenTableBody = document.getElementById('tokenTableBody');
    const studentTableBody = document.getElementById('studentTableBody');
    const examStatusFilterDropdown = document.getElementById('examStatusFilter');
    const scoreTableHeader = document.getElementById('scoreTableHeader');
    const scoreTableBody = document.getElementById('scoreTableBody');
    const locationSettingsTableBody = document.getElementById('locationSettingsTableBody');
    const lockSettingsTableBody = document.getElementById('lockSettingsTableBody');

    const padStudentId = (id) => String(id).padStart(3, '0');
    const padRoomNumber = (room) => {
        if (!room) return '-';
        const numRoom = parseInt(room, 10);
        return !isNaN(numRoom) ? String(numRoom).padStart(2, '0') : String(room).toUpperCase();
    };
    const formatLocalDateTime = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    };
    const getNumericClass = (classString) => String(classString || '').match(/^(\d+)/)?.[1] || null;
    const getDbForClass = (classIdentifier) => {
        const numericClass = getNumericClass(classIdentifier);
        if (rombelToDbMap[classIdentifier]) {
            return dbInstances[rombelToDbMap[classIdentifier]];
        }
        if (gradeToDbGroupMap[numericClass]) {
            return gradeToDbGroupMap[numericClass].map(dbName => dbInstances[dbName]);
        }
        console.error(`Instance database tidak ditemukan untuk identifier: ${classIdentifier}`);
        return null;
    };
    const escapeHtmlAttributeForJsString = (s) => String(s).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const convertToPreviewLink = (url) => (!url || typeof url !== 'string') ? url : url.replace(/\/view(\?usp=sharing)?$/, '/preview');
    const showNotification = (message) => {
        const n = document.getElementById('notification');
        n.innerText = message;
        n.style.display = 'block';
        setTimeout(() => { n.style.display = 'none'; }, 3000);
    };

    function initializeAppState() {
        loginSection.style.display = 'none';
        sidebar.style.display = 'flex';
        dashboardContent.style.display = 'flex';
        loadTokens();
        loadStudents();
        loadTokenAccessStatus();
        loadSubmittedExamsStatus();
        loadSetlokasiSettings();
        loadStudentAnswers();
        loadLockSettings();
        showSection('tokenSection');
        resetInactivityTimer();
        collapseSidebar();
    }
    
    window.login = () => {
        const u = document.getElementById("username").value.trim();
        const p = document.getElementById("password").value.trim();
        if (u === ADMIN_USER && p === ADMIN_PASS) {
            localStorage.setItem('isAdminLoggedIn', 'true');
            initializeAppState();
        } else {
            document.getElementById("loginError").innerText = "Username atau password salah.";
        }
    };

    function attachEventListeners() {
        // Search/Filter Listeners
        document.getElementById('tokenSearchSubject').addEventListener('keyup', renderTokenTable);
        document.getElementById('scoreSearchName').addEventListener('keyup', renderScoreTable);
        document.getElementById('scoreSearchClass').addEventListener('keyup', renderScoreTable);
        document.getElementById('studentSearchId').addEventListener('keyup', renderStudentTable);
        document.getElementById('studentSearchName').addEventListener('keyup', renderStudentTable);
        document.getElementById('studentSearchClass').addEventListener('keyup', renderStudentTable);
        document.getElementById('examStatusFilter').addEventListener('change', renderStudentTable);

        // Form Listeners
        document.getElementById('addTokenForm').addEventListener('submit', handleAddToken);
        document.getElementById('modalForm').addEventListener('submit', handleEditToken);
        document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);

        // Answer Key Count Listeners
        document.getElementById('addAnswerKey').addEventListener('input', () => updateAnswerKeyCount(document.getElementById('addAnswerKey'), document.getElementById('addAnswerKeyCount')));
        document.getElementById('editAnswerKey').addEventListener('input', () => updateAnswerKeyCount(document.getElementById('editAnswerKey'), document.getElementById('editAnswerKeyCount')));
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('isAdminLoggedIn') === 'true') {
          initializeAppState();
      } else {
          loginSection.style.display = 'block';
          sidebar.style.display = 'none';
          dashboardContent.style.display = 'none';
          collapseSidebar();
      }
      attachEventListeners();
    });


    window.expandSidebar = () => { sidebar.classList.add('expanded'); isSidebarExpanded = true; };
    window.collapseSidebar = () => { sidebar.classList.remove('expanded'); isSidebarExpanded = false; };
    
    window.showSection = (sectionId) => {
        document.querySelectorAll('.dashboard-section').forEach(section => section.style.display = 'none');
        document.getElementById(sectionId).style.display = 'block';

        document.querySelectorAll('.sidebar-nav button').forEach(button => button.classList.remove('active'));
        const activeBtn = document.querySelector(`.sidebar-nav button[data-section-id="${sectionId}"]`);
        if (activeBtn) activeBtn.classList.add('active');
        
        if (sectionId === 'tokenSection') renderTokenTable();
        else if (sectionId === 'rulesSection') { updateSetlokasiStatusDisplay(); renderLockSettingsTable(); }
        else if (sectionId === 'studentSection') { populateExamStatusFilter(); renderStudentTable(); }
        else if (sectionId === 'scoreSection') renderScoreTable();
    };

    window.handleMenuClick = (buttonElement) => {
        const sectionId = buttonElement.dataset.sectionId;
        const action = buttonElement.dataset.action;

        const performAction = () => {
            if (action === 'promptLogout') window.promptLogout();
            else window.showSection(sectionId);
        };

        if (!isSidebarExpanded) {
            expandSidebar();
            setTimeout(performAction, 100);
        } else {
            const currentActiveSectionId = document.querySelector('.dashboard-section[style*="display: block"]')?.id;
            if (action === 'promptLogout' || sectionId !== currentActiveSectionId) {
                performAction();
            }
        }
    };
    
    document.addEventListener('click', (event) => {
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickInsideModal = event.target.closest('.modal');
        if (isSidebarExpanded && !isClickInsideSidebar && !isClickInsideModal) {
            collapseSidebar();
        }
    });

    function renderTokenTable() {
        tokenTableBody.innerHTML = '';
        consolidatedTokensMap.clear();

        tokenCache.forEach(tokenData => {
            const consolidatedKey = `${tokenData.token}_${tokenData.kelas}`;
            if (!consolidatedTokensMap.has(consolidatedKey)) {
                consolidatedTokensMap.set(consolidatedKey, { ...tokenData, firebaseKeys: new Set([tokenData.key]), firebaseGroups: new Set([tokenData.firebaseGroup]) });
            } else {
                const existing = consolidatedTokensMap.get(consolidatedKey);
                existing.firebaseKeys.add(tokenData.key);
                existing.firebaseGroups.add(tokenData.firebaseGroup);
                existing.isForceActive = existing.isForceActive || tokenData.isForceActive;
                existing.isActive = existing.isActive || tokenData.isActive;
            }
        });

        let consolidatedTokens = Array.from(consolidatedTokensMap.values());
        
        const searchSubject = document.getElementById('tokenSearchSubject').value.trim().toUpperCase();
        if (searchSubject) {
            consolidatedTokens = consolidatedTokens.filter(token => token.subject.toUpperCase().includes(searchSubject));
        }

        consolidatedTokens.sort((a, b) => new Date(a.startTime).getTime() - new Date(b.startTime).getTime() || String(a.kelas || '').localeCompare(String(b.kelas || '')));

        consolidatedTokens.forEach((data, index) => {
            const row = document.createElement('tr');
            
            // Progress Calculation
            const studentsInClass = studentCache.filter(s => getNumericClass(s.class) === getNumericClass(data.kelas));
            let sudahSubmitCount = 0;
            let sudahAksesCount = 0;

            studentsInClass.forEach(student => {
                let hasAccessed = false;
                for (const fbKey of data.firebaseKeys) {
                    if (tokenAccessStatus[fbKey]?.[student.id]) hasAccessed = true;
                    if (submittedExamsCache[fbKey]?.[student.id]?.isSubmitted) {
                        sudahSubmitCount++;
                        break; 
                    }
                }
                if (hasAccessed) sudahAksesCount++;
            });
            const belumLoginCount = studentsInClass.length - sudahAksesCount;

            const progresHtml = `
                <div style="text-align: left; line-height: 1.5; font-size: 13px;">
                   Status Submit: <b>${sudahSubmitCount}/${sudahAksesCount}</b><br>
                   Belum Login: <b>${belumLoginCount}</b>
                </div>`;

            // Time and Duration Display
            const startTimeFormatted = data.startTime ? new Date(data.startTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) : '-';
            const endTimeFormatted = data.endTime ? new Date(data.endTime).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' }) : '-';
            const waktuUjianHtml = `<small>Buka: ${startTimeFormatted}<br>Tutup: ${endTimeFormatted}<br>Durasi: ${data.durationMinutes ?? '-'} menit</small>`;
            
            // Mapel & Kelas Display
            const mapelKelasHtml = `<b>${escapeHtmlAttributeForJsString(data.subject)}</b><br>
                                  <small>Kls: ${escapeHtmlAttributeForJsString(data.kelas)} / <a href="${escapeHtmlAttributeForJsString(data.googleDriveUrl)}" target="_blank" class="login-link">Link Soal</a></small>`;
            
            // Token Status Toggle
            const isCurrentlyActive = data.isForceActive || data.isActive;
            const statusClass = isCurrentlyActive ? 'on' : 'off';
            const statusText = isCurrentlyActive ? 'ON' : 'OFF';
            
            const tokenDisplayHtml = `${data.token} <span class="token-status ${statusClass}" onclick="promptToggleForceActive('${escapeHtmlAttributeForJsString(data.token)}', '${escapeHtmlAttributeForJsString(data.kelas)}', ${isCurrentlyActive})">(${statusText})</span>`;
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${mapelKelasHtml}</td>
                <td>${tokenDisplayHtml}</td>
                <td>${waktuUjianHtml}</td>
                <td>${progresHtml}</td>
                <td>
                    <div class="action-buttons-group">
                        <button class="icon-button edit" onclick="editTokenConsolidated('${escapeHtmlAttributeForJsString(data.token)}', '${escapeHtmlAttributeForJsString(data.kelas)}')" title="Edit Token"><i class="fas fa-edit"></i></button>
                        <button class="icon-button delete" onclick="promptDeleteConsolidated('${escapeHtmlAttributeForJsString(data.token)}', '${escapeHtmlAttributeForJsString(data.kelas)}')" title="Hapus Token"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </td>`;
            tokenTableBody.appendChild(row);
        });
        populateExamStatusFilter();
    }
    
    window.promptToggleForceActive = (token, kelas, isCurrentlyActive) => {
        const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === token && t.kelas === kelas);
        if (!consolidatedToken) return;
        currentConsolidatedTokenInfo = consolidatedToken;

        if (isCurrentlyActive) {
            document.getElementById('forceInactiveModal').style.display = 'flex';
        } else {
            document.getElementById('forceActivePassword').value = '';
            document.getElementById('forceActivePasswordError').innerText = '';
            document.getElementById('forceActiveModal').style.display = 'flex';
        }
    };
    
    window.confirmForceActive = async () => {
        if (document.getElementById('forceActivePassword').value !== ADMIN_PASS) {
            return document.getElementById('forceActivePasswordError').innerText = "Password Admin salah.";
        }
        if (!currentConsolidatedTokenInfo) return;
        
        const updates = {};
        currentConsolidatedTokenInfo.firebaseKeys.forEach(fbKey => {
            updates[fbKey] = { isForceActive: true, isActive: true };
        });
        
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = Object.entries(updates).map(([key, value]) => {
                const token = tokenCache.find(t => t.key === key);
                if (token && dbInstances[token.firebaseGroup]) {
                    return update(ref(dbInstances[token.firebaseGroup], `tokens/${key}`), value);
                }
            });
            await Promise.all(updatePromises);
            showNotification('Token berhasil diaktifkan secara paksa.');
        } catch(e) {
            showNotification('Gagal mengaktifkan token: ' + e.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeForceActiveModal();
            currentConsolidatedTokenInfo = null;
        }
    };

    window.confirmForceInactive = async () => {
        if (!currentConsolidatedTokenInfo) return;
        
        const updates = {};
        currentConsolidatedTokenInfo.firebaseKeys.forEach(fbKey => {
            updates[fbKey] = { isForceActive: false };
        });
        
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = Object.entries(updates).map(([key, value]) => {
                const token = tokenCache.find(t => t.key === key);
                if (token && dbInstances[token.firebaseGroup]) {
                    return update(ref(dbInstances[token.firebaseGroup], `tokens/${key}`), value);
                }
            });
            await Promise.all(updatePromises);
            showNotification('Mode paksa dinonaktifkan. Status kembali ke jadwal.');
            periksaAndUpdateStatusToken(); // Re-check status based on time
        } catch(e) {
            showNotification('Gagal menonaktifkan token: ' + e.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeForceInactiveModal();
            currentConsolidatedTokenInfo = null;
        }
    };


    function loadTokens() {
      tokenCache = [];
      Object.keys(gradeToDbGroupMap).forEach(gradeNum => {
          const dbNames = gradeToDbGroupMap[gradeNum];
          dbNames.forEach(dbName => {
              const dbInstance = dbInstances[dbName];
              if (dbInstance) {
                  onValue(ref(dbInstance, 'tokens'), (snapshot) => {
                      const groupTokens = [];
                      snapshot.forEach(child => {
                          const data = child.val();
                          data.key = child.key;
                          data.firebaseGrade = gradeNum;
                          data.firebaseGroup = dbName;
                          if (data.createdAt && (Date.now() - data.createdAt) > THIRTY_DAYS_IN_MS) {
                              remove(ref(dbInstance, 'tokens/' + data.key));
                              return;
                          }
                          groupTokens.push(data);
                      });
                      tokenCache = tokenCache.filter(t => t.firebaseGroup !== dbName).concat(groupTokens);
                      renderTokenTable();
                      periksaAndUpdateStatusToken();
                  }, (error) => console.error(`Error memuat token dari grup ${dbName}:`, error));
              }
          });
      });
    }
    
    async function handleAddToken(e) {
      e.preventDefault();
      const s = document.getElementById('addSubject').value.trim().toUpperCase();
      const k = document.getElementById('addKelas').value.trim();
      const t = document.getElementById('addToken').value.trim().toUpperCase();
      const originalGoogleDriveUrl = document.getElementById('addGoogleDriveUrl').value.trim();
      const googleDriveUrlPreview = convertToPreviewLink(originalGoogleDriveUrl);
      const answerKey = document.getElementById('addAnswerKey').value.trim().toUpperCase();
      const startTimeInput = document.getElementById('addStartTime').value;
      const endTimeInput = document.getElementById('addEndTime').value;
      const em = document.getElementById('addErrorMsg');
      em.innerText = "";
      document.getElementById('addGoogleDriveUrlError').innerText = "";
      document.getElementById('addAnswerKeyError').innerText = "";

      if (!['7'].includes(k)) return em.innerText = "Kelas harus berupa 7.";
      const targetDbs = getDbForClass(k);
      if (!targetDbs || !Array.isArray(targetDbs) || targetDbs.length === 0) return em.innerText = "Kelas tidak valid atau konfigurasi Firebase belum lengkap.";
      if (!s || !k || !t || !originalGoogleDriveUrl || !answerKey || !startTimeInput || !endTimeInput) return em.innerText = "Semua field harus diisi!";

      const originalStartTime = new Date(startTimeInput);
      const originalEndTime = new Date(endTimeInput);
      if (originalStartTime >= originalEndTime) return em.innerText = "Waktu token dibuka harus sebelum waktu token ditutup!";
      if (!/^[A-D](,[A-D])*$/.test(answerKey) && answerKey) return document.getElementById('addAnswerKeyError').innerText = "Format kunci jawaban tidak valid.";
      if (!originalGoogleDriveUrl.startsWith('http')) return document.getElementById('addGoogleDriveUrlError').innerText = "URL Google Drive tidak valid.";
      if (tokenCache.some(item => item.token === t && getNumericClass(item.kelas) === getNumericClass(k))) return em.innerText = "Token (Base Token) sudah ada untuk kelas ini!";

      loadingOverlay.style.display = 'flex';
      const adjustedStartTime = new Date(originalStartTime.getTime() + (k === '7' ? 30000 : 0)); 
      const durationMinutes = Math.round((originalEndTime.getTime() - adjustedStartTime.getTime()) / 60000);
      const data = { subject: s, kelas: k, token: t, googleDriveUrl: googleDriveUrlPreview, originalGoogleDriveUrl, answerKey, startTime: formatLocalDateTime(adjustedStartTime), endTime: endTimeInput, durationMinutes, createdAt: Date.now(), isActive: false, isForceActive: false };

      try {
          await Promise.all(targetDbs.map(db => push(ref(db, 'tokens'), data)));
          showNotification('Token berhasil ditambahkan!');
          closeAddTokenModal();
      } catch (err) {
          em.innerText = "Gagal menyimpan token: " + err.message;
      } finally {
          loadingOverlay.style.display = 'none';
      }
    }
    
    window.editTokenConsolidated = (baseToken, kelas) => {
        const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === baseToken && t.kelas === kelas);
        if (!consolidatedToken) return;
        currentConsolidatedTokenInfo = consolidatedToken;
        document.getElementById('editSubject').value = consolidatedToken.subject;
        document.getElementById('editKelas').value = consolidatedToken.kelas;
        document.getElementById('editToken').value = consolidatedToken.token;
        document.getElementById('editGoogleDriveUrl').value = consolidatedToken.originalGoogleDriveUrl || consolidatedToken.googleDriveUrl || '';
        document.getElementById('editAnswerKey').value = consolidatedToken.answerKey || '';
        updateAnswerKeyCount(document.getElementById('editAnswerKey'), document.getElementById('editAnswerKeyCount'));
        document.getElementById('editStartTime').value = consolidatedToken.startTime;
        document.getElementById('editEndTime').value = consolidatedToken.endTime;
        document.getElementById('editErrorMsg').innerText = "";
        document.getElementById('editGoogleDriveUrlError').innerText = "";
        document.getElementById('editAnswerKeyError').innerText = "";
        document.getElementById('editModal').style.display = 'flex';
    };

    async function handleEditToken(e) {
      e.preventDefault();
      const s = document.getElementById('editSubject').value.trim().toUpperCase();
      const newKelas = document.getElementById('editKelas').value.trim();
      const t = document.getElementById('editToken').value.trim().toUpperCase();
      const originalGoogleDriveUrl = document.getElementById('editGoogleDriveUrl').value.trim();
      const googleDriveUrlPreview = convertToPreviewLink(originalGoogleDriveUrl);
      const answerKey = document.getElementById('editAnswerKey').value.trim().toUpperCase();
      const startTimeInput = document.getElementById('editStartTime').value;
      const endTimeInput = document.getElementById('editEndTime').value;
      const em = document.getElementById('editErrorMsg');
      em.innerText = ""; document.getElementById('editGoogleDriveUrlError').innerText = ""; document.getElementById('editAnswerKeyError').innerText = "";

      if (!['7'].includes(newKelas)) return em.innerText = "Kelas harus berupa 7.";
      if (!currentConsolidatedTokenInfo) return em.innerText = "Error: Informasi token tidak ditemukan.";
      
      const oldKelas = currentConsolidatedTokenInfo.kelas;
      const oldBaseToken = currentConsolidatedTokenInfo.token;
      const oldFirebaseKeys = Array.from(currentConsolidatedTokenInfo.firebaseKeys);
      
      if (!s || !newKelas || !t || !originalGoogleDriveUrl || !answerKey || !startTimeInput || !endTimeInput) return em.innerText = "Semua field harus diisi!";

      const originalStartTime = new Date(startTimeInput);
      const originalEndTime = new Date(endTimeInput);
      if (originalStartTime >= originalEndTime) return em.innerText = "Waktu token dibuka harus sebelum waktu token ditutup!";
      if (!/^[A-D](,[A-D])*$/.test(answerKey) && answerKey) return document.getElementById('editAnswerKeyError').innerText = "Format kunci jawaban tidak valid.";
      if (!originalGoogleDriveUrl.startsWith('http')) return document.getElementById('editGoogleDriveUrlError').innerText = "URL Google Drive tidak valid.";
      if (Array.from(consolidatedTokensMap.values()).some(item => item.token === t && item.kelas === newKelas && !(item.token === oldBaseToken && item.kelas === oldKelas))) return em.innerText = "Token (Base Token) sudah ada untuk kelas ini!";

      loadingOverlay.style.display = 'flex';
      const adjustedStartTime = new Date(originalStartTime.getTime() + (newKelas === '7' ? 30000 : 0));
      const durationMinutes = Math.round((originalEndTime.getTime() - adjustedStartTime.getTime()) / 60000);
      const updatedData = { subject: s, kelas: newKelas, token: t, googleDriveUrl: googleDriveUrlPreview, originalGoogleDriveUrl, answerKey, startTime: formatLocalDateTime(adjustedStartTime), endTime: endTimeInput, durationMinutes, createdAt: currentConsolidatedTokenInfo.createdAt, isForceActive: currentConsolidatedTokenInfo.isForceActive, isActive: currentConsolidatedTokenInfo.isActive };

      try {
          if (getNumericClass(oldKelas) !== getNumericClass(newKelas) || oldBaseToken !== t) {
              const deletePromises = oldFirebaseKeys.flatMap(fbKey => {
                  const token = tokenCache.find(tok => tok.key === fbKey);
                  const db = token ? dbInstances[token.firebaseGroup] : null;
                  return db ? [remove(ref(db, `tokens/${fbKey}`)), remove(ref(db, `exam_access_status/${fbKey}`)), remove(ref(db, `submitted_exams/${fbKey}`)), remove(ref(db, `student_answers/${fbKey}`))] : [];
              });
              await Promise.all(deletePromises);
              const newTargetDbs = getDbForClass(newKelas);
              await Promise.all(newTargetDbs.map(db => push(ref(db, 'tokens'), updatedData)));
              showNotification(`Token berhasil dipindahkan ke kelas ${newKelas}!`);
          } else {
              const updatePromises = oldFirebaseKeys.map(fbKey => {
                  const token = tokenCache.find(tok => tok.key === fbKey);
                  const db = token ? dbInstances[token.firebaseGroup] : null;
                  return db ? update(ref(db, `tokens/${fbKey}`), updatedData) : Promise.resolve();
              });
              await Promise.all(updatePromises);
              showNotification('Token berhasil diedit!');
          }
          closeEditModal();
      } catch (err) {
          em.innerText = "Gagal menyimpan perubahan: " + err.message;
      } finally {
          loadingOverlay.style.display = 'none';
          currentConsolidatedTokenInfo = null;
      }
    }

    window.promptDeleteConsolidated = (baseToken, kelas) => {
        const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === baseToken && t.kelas === kelas);
        if (!consolidatedToken) return;
        currentConsolidatedTokenInfo = consolidatedToken;
        document.getElementById('deleteModal').style.display = 'flex';
    };

    window.confirmDelete = async () => {
        if (!currentConsolidatedTokenInfo) return;
        loadingOverlay.style.display = 'flex';
        try {
            const deletePromises = Array.from(currentConsolidatedTokenInfo.firebaseKeys).flatMap(fbKey => {
                const token = tokenCache.find(tok => tok.key === fbKey);
                const db = token ? dbInstances[token.firebaseGroup] : null;
                return db ? [remove(ref(db, `tokens/${fbKey}`)), remove(ref(db, `exam_access_status/${fbKey}`)), remove(ref(db, `submitted_exams/${fbKey}`)), remove(ref(db, `student_answers/${fbKey}`))] : [];
            });
            await Promise.all(deletePromises);
            showNotification('Token berhasil dihapus!');
        } catch (err) {
            showNotification("Gagal menghapus token: " + err.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeDeleteModal();
            currentConsolidatedTokenInfo = null;
        }
    };
    
    function loadStudents() {
        studentCache = [];
        Object.keys(dbInstances).forEach(dbName => {
            const dbInstance = dbInstances[dbName];
            if (dbInstance) {
                onValue(ref(dbInstance, 'students'), (snapshot) => {
                    const groupStudents = [];
                    snapshot.forEach(child => {
                        const data = child.val(); data.key = child.key; data.firebaseGroup = dbName; groupStudents.push(data);
                    });
                    studentCache = studentCache.filter(s => s.firebaseGroup !== dbName);
                    studentCache.push(...groupStudents);
                    studentCache.sort((a, b) => {
                        const classA = String(a.class || ''), classB = String(b.class || '');
                        if(classA !== classB) return classA.localeCompare(classB);
                        return String(a.name || '').localeCompare(String(b.name || ''));
                    });
                    renderStudentTable();
                    renderScoreTable();
                }, (error) => console.error(`Error memuat siswa dari grup ${dbName}:`, error));
            }
        });
    }

    function renderStudentTable() {
        studentTableBody.innerHTML = '';
        let studentsToDisplay = studentCache;

        const searchId = document.getElementById('studentSearchId').value.trim();
        if (searchId) {
            studentsToDisplay = studentsToDisplay.filter(student => student.id.includes(searchId));
        }

        const searchName = document.getElementById('studentSearchName').value.trim().toUpperCase();
        if (searchName) {
            studentsToDisplay = studentsToDisplay.filter(student => student.name.toUpperCase().includes(searchName));
        }
        
        const searchClass = document.getElementById('studentSearchClass').value.trim().toUpperCase();
        if (searchClass) {
            studentsToDisplay = studentsToDisplay.filter(student => student.class.toUpperCase().includes(searchClass));
        }
        
        const examStatusFilterToken = examStatusFilterDropdown.value;
        if (examStatusFilterToken) {
            const selectedTokenForStatus = tokenCache.find(t => t.key === examStatusFilterToken);
            if (selectedTokenForStatus) {
                const tokenClassNumeric = getNumericClass(selectedTokenForStatus.kelas);
                studentsToDisplay = studentsToDisplay.filter(student => getNumericClass(student.class) === tokenClassNumeric);
            }
        }
        
        studentsToDisplay.forEach((student, index) => {
            const row = document.createElement('tr');
            let studentStatus = '-', statusColor = 'black';
            const studentNumericClass = getNumericClass(student.class);
            const relevantTokensForStudent = tokenCache.filter(token => getNumericClass(token.kelas) === studentNumericClass);
            
            let hasSubmittedAny = false, isLoggedInForAny = false, hasAccessedAny = false;

            for (const token of relevantTokensForStudent) {
                const accessData = tokenAccessStatus[token.key] && tokenAccessStatus[token.key][student.id];
                const submissionData = submittedExamsCache[token.key] && submittedExamsCache[token.key][student.id];

                if (submissionData?.isSubmitted) hasSubmittedAny = true;
                if (accessData?.isLoggedIn) isLoggedInForAny = true;
                if (accessData?.accessCount > 0) hasAccessedAny = true;
            }

            if(hasSubmittedAny) { studentStatus = 'Sudah submit'; statusColor = 'green'; }
            else if(isLoggedInForAny) { studentStatus = 'Sedang mengerjakan'; statusColor = 'orange'; }
            else if(hasAccessedAny) { studentStatus = 'Belum login (reset)'; statusColor = 'purple';}
            else { studentStatus = 'Belum login'; statusColor = 'red'; }

            row.innerHTML = `
                <td>${index + 1}</td><td>${escapeHtmlAttributeForJsString(student.id)}</td><td>${escapeHtmlAttributeForJsString(student.name)}</td><td>${escapeHtmlAttributeForJsString(student.class)}</td><td>${padRoomNumber(student.room)}</td>
                <td style="color: ${statusColor}; font-weight: bold;">${studentStatus}</td>
                <td><div class="action-buttons-group">
                    <button class="icon-button edit" onclick="openEditStudentModal('${escapeHtmlAttributeForJsString(student.key)}')" title="Edit Data Siswa"><i class="fas fa-edit"></i></button>
                    <button class="icon-button delete" onclick="openDeleteStudentConfirmModal('${escapeHtmlAttributeForJsString(student.key)}')" title="Hapus Siswa"><i class="fas fa-trash-alt"></i></button>
                    <button class="icon-button reset" onclick="promptResetStudent('${escapeHtmlAttributeForJsString(student.key)}', '${escapeHtmlAttributeForJsString(student.id)}', '${escapeHtmlAttributeForJsString(student.name)}', '${escapeHtmlAttributeForJsString(student.class)}')" title="Reset Status Login"><i class="fas fa-redo"></i></button>
                    <button class="icon-button submit" onclick="promptSubmitAnswer('${escapeHtmlAttributeForJsString(student.key)}', '${escapeHtmlAttributeForJsString(student.id)}', '${escapeHtmlAttributeForJsString(student.name)}', '${escapeHtmlAttributeForJsString(student.class)}')" title="Kirim Jawaban Manual"><i class="fas fa-paper-plane"></i></button>
                    <button class="icon-button erase" onclick="promptDeleteAnswer('${escapeHtmlAttributeForJsString(student.key)}', '${escapeHtmlAttributeForJsString(student.id)}', '${escapeHtmlAttributeForJsString(student.name)}', '${escapeHtmlAttributeForJsString(student.class)}')" title="Hapus Semua Jawaban"><i class="fas fa-eraser"></i></button>
                </div></td>`;
            studentTableBody.appendChild(row);
        });
    }

    async function handleAddStudent(e) {
        e.preventDefault();
        const studentId = padStudentId(document.getElementById('newStudentId').value.trim());
        const studentName = document.getElementById('newStudentName').value.trim().toUpperCase().replace(/'/g, '');
        const studentClass = document.getElementById('newStudentClass').value.trim().toUpperCase();
        const studentRoom = padRoomNumber(document.getElementById('newStudentRoom').value.trim());
        const studentErrorMsg = document.getElementById('addStudentErrorMsg');
        studentErrorMsg.innerText = "";
        
        if (!VALID_ROMBELS.includes(studentClass)) return studentErrorMsg.innerText = "Kelas siswa tidak valid. Gunakan format seperti 7A, 7B, dll.";
        const targetDb = getDbForClass(studentClass);
        if (!targetDb || Array.isArray(targetDb)) return studentErrorMsg.innerText = "Konfigurasi Firebase belum lengkap untuk rombel ini.";
        if (!/^\d{3,}$/.test(studentId)) return studentErrorMsg.innerText = "ID Siswa harus berupa angka!";
        if (studentCache.some(s => s.id === studentId && s.firebaseGroup === rombelToDbMap[studentClass])) return studentErrorMsg.innerText = "ID Siswa sudah ada di kelas tersebut.";
        
        try {
            await push(ref(targetDb, 'students'), { id: studentId, name: studentName, class: studentClass, room: studentRoom, isLoggedIn: false });
            showNotification('Siswa berhasil ditambahkan.');
            closeAddStudentModal();
        } catch (error) {
            studentErrorMsg.innerText = "Gagal menambahkan siswa: " + error.message;
        }
    }

    window.openEditStudentModal = (key) => {
        const student = studentCache.find(s => s.key === key);
        if (!student) return;
        currentStudentKey = key;
        document.getElementById('modalStudentId').value = student.id;
        document.getElementById('modalStudentName').value = student.name;
        document.getElementById('modalStudentClass').value = student.class;
        document.getElementById('modalStudentRoom').value = student.room || '';
        document.getElementById('editStudentErrorMsg').innerText = "";
        document.getElementById('editStudentModal').style.display = 'flex';
    };

    window.confirmEditStudent = async () => {
        const studentId = padStudentId(document.getElementById('modalStudentId').value.trim());
        const studentName = document.getElementById('modalStudentName').value.trim().toUpperCase().replace(/'/g, '');
        const newStudentClass = document.getElementById('modalStudentClass').value.trim().toUpperCase();
        const studentRoom = padRoomNumber(document.getElementById('modalStudentRoom').value.trim());
        const editStudentErrorMsg = document.getElementById('editStudentErrorMsg');
        editStudentErrorMsg.innerText = "";

        if (!VALID_ROMBELS.includes(newStudentClass)) return editStudentErrorMsg.innerText = "Kelas siswa tidak valid.";
        const originalStudentData = studentCache.find(s => s.key === currentStudentKey);
        if (!originalStudentData) return editStudentErrorMsg.innerText = "Data siswa asli tidak ditemukan.";
        
        const oldStudentClass = originalStudentData.class;
        const oldDb = getDbForClass(oldStudentClass), newDb = getDbForClass(newStudentClass);
        if (!oldDb || Array.isArray(oldDb) || !newDb || Array.isArray(newDb)) return editStudentErrorMsg.innerText = "Konfigurasi Firebase belum lengkap.";
        if (!studentId || !studentName || !newStudentClass || !studentRoom) return editStudentErrorMsg.innerText = "Semua field harus diisi!";
        if (!/^\d+$/.test(studentId)) return editStudentErrorMsg.innerText = "ID Siswa harus berupa angka!";
        if (studentCache.some(s => s.id === studentId && s.key !== currentStudentKey && s.firebaseGroup === rombelToDbMap[newStudentClass])) return editStudentErrorMsg.innerText = "ID Siswa sudah ada.";
        
        loadingOverlay.style.display = 'flex';
        const updatedStudentData = { id: studentId, name: studentName, class: newStudentClass, room: studentRoom, isLoggedIn: originalStudentData.isLoggedIn || false };
        
        try {
            if (oldDb.app.name !== newDb.app.name) {
                await remove(ref(oldDb, 'students/' + currentStudentKey));
                await push(ref(newDb, 'students'), updatedStudentData);
                showNotification(`Siswa berhasil dipindahkan ke kelas ${newStudentClass}!`);
            } else {
                await update(ref(newDb, 'students/' + currentStudentKey), updatedStudentData);
                showNotification('Data siswa berhasil diperbarui.');
            }
            closeEditStudentModal();
        } catch (error) {
            editStudentErrorMsg.innerText = "Gagal memperbarui siswa: " + error.message;
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };
    
    // The rest of the JS functions are restored here to ensure full functionality.
    
    window.onclick = (event) => { if (event.target.classList.contains('modal')) event.target.style.display = 'none'; };
    window.openAddTokenModal = () => {
        document.getElementById('addTokenForm').reset();
        document.getElementById('addAnswerKeyCount').value = '0';
        document.getElementById('addTokenModal').style.display = 'flex';
    };
    window.closeAddTokenModal = () => document.getElementById('addTokenModal').style.display = 'none';
    window.openAddStudentModal = () => {
        document.getElementById('addStudentForm').reset();
        document.getElementById('addStudentModal').style.display = 'flex';
    };
    window.closeAddStudentModal = () => document.getElementById('addStudentModal').style.display = 'none';
    window.closeEditModal = () => document.getElementById('editModal').style.display = 'none';
    window.closeDeleteModal = () => document.getElementById('deleteModal').style.display = 'none';
    window.closeForceActiveModal = () => document.getElementById('forceActiveModal').style.display = 'none';
    window.closeForceInactiveModal = () => document.getElementById('forceInactiveModal').style.display = 'none';
    window.closeAccessDetailModal = () => document.getElementById('accessDetailModal').style.display = 'none';
    window.closeEditStudentModal = () => { document.getElementById('editStudentModal').style.display = 'none'; currentStudentKey = null; };
    window.closeDeleteStudentConfirmModal = () => { document.getElementById('deleteStudentConfirmModal').style.display = 'none'; deleteStudentKey = null; };
    window.openImportStudentModal = () => { document.getElementById('importStudentModal').style.display = 'flex'; document.getElementById('csvFileInput').value = ''; document.getElementById('importFileError').innerText = ''; };
    window.closeImportStudentModal = () => document.getElementById('importStudentModal').style.display = 'none';
    window.closeImportResultModal = () => document.getElementById('importResultModal').style.display = 'none';
    window.openEmptyStudentsModal = () => { document.getElementById('emptyStudentsModal').style.display = 'flex'; document.getElementById('emptyStudentsPassword').value = ''; document.getElementById('emptyStudentsPasswordError').innerText = ''; };
    window.closeEmptyStudentsModal = () => document.getElementById('emptyStudentsModal').style.display = 'none';
    window.promptLogout = () => document.getElementById('logoutConfirmModal').style.display = 'flex';
    window.closeLogoutModal = () => document.getElementById('logoutConfirmModal').style.display = 'none';
    window.confirmLogout = () => { localStorage.removeItem('isAdminLoggedIn'); location.reload(); };
    window.closeResetStudentModal = () => { document.getElementById('resetStudentModal').style.display = 'none'; studentKeyForAction = null; };
    window.closeSubmitAnswerModal = () => { document.getElementById('submitAnswerModal').style.display = 'none'; studentKeyForAction = null; };
    window.closeDeleteAnswerModal = () => { document.getElementById('deleteAnswerModal').style.display = 'none'; studentKeyForAction = null; };
    window.showPrintInfoModal = () => { document.getElementById('printInfoModal').style.display = 'flex'; };
    window.closePrintInfoModal = () => { document.getElementById('printInfoModal').style.display = 'none'; };
    window.openCopyPrintModal = (tableId, modalTitle) => {
        currentTableIdToCopy = tableId;
        document.getElementById('copyPrintModalTitle').innerText = modalTitle;
        document.getElementById('copyPrintModal').style.display = 'flex';
    };
    window.closeCopyPrintModal = () => { document.getElementById('copyPrintModal').style.display = 'none'; };
    window.copyTableToClipboard = () => {
        const table = document.getElementById(currentTableIdToCopy);
        if (!table) return showNotification('Tabel tidak ditemukan.');
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute'; tempDiv.style.left = '-9999px';
        tempDiv.innerHTML = table.outerHTML;
        document.body.appendChild(tempDiv);
        const range = document.createRange();
        range.selectNode(tempDiv);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            document.execCommand('copy');
            showNotification('Tabel berhasil disalin.');
        } catch (err) {
            showNotification('Gagal menyalin tabel.');
        }
        window.getSelection().removeAllRanges();
        document.body.removeChild(tempDiv);
        closeCopyPrintModal();
    };

    function updateTime() {
      const now = new Date();
      const options = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const display = now.toLocaleString('id-ID', options).replace(/\./g, ':');
      document.getElementById("currentTime").innerText = display;
      const adminTimeEl = document.getElementById("adminDateTime");
      if(adminTimeEl) adminTimeEl.innerText = display;
    }
    
    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => { if(localStorage.getItem('isAdminLoggedIn')) { showNotification('Anda telah logout karena tidak ada aktivitas.'); confirmLogout(); } }, INACTIVITY_TIMEOUT);
    }

    function updateAnswerKeyCount(answerKeyInputElem, countInputElem) {
        const key = answerKeyInputElem.value.trim();
        countInputElem.value = key === '' ? 0 : key.split(',').filter(v => v.trim() !== '').length;
    }

    setInterval(updateTime, 1000);
    updateTime();
    ['mousemove', 'keypress', 'scroll', 'click'].forEach(evt => window.addEventListener(evt, resetInactivityTimer));
    setInterval(() => { if (localStorage.getItem('isAdminLoggedIn')) periksaAndUpdateStatusToken(); }, 10000);
    
    // --- Full function implementations ---
    
    window.openDeleteStudentConfirmModal = (key) => {
        deleteStudentKey = key;
        document.getElementById('deleteStudentConfirmModal').style.display = 'flex';
    };
    
    window.confirmDeleteStudent = async () => {
        if (!deleteStudentKey) return;
        const studentToDelete = studentCache.find(s => s.key === deleteStudentKey);
        if (!studentToDelete) return showNotification("Siswa tidak ditemukan.");
        const targetDb = getDbForClass(studentToDelete.class);
        if (!targetDb || Array.isArray(targetDb)) return showNotification("Gagal menghapus: Database tidak ditemukan.");

        loadingOverlay.style.display = 'flex';
        try {
            await remove(ref(targetDb, 'students/' + deleteStudentKey));
            showNotification('Siswa berhasil dihapus.');
        } catch (error) {
            showNotification("Gagal menghapus siswa: " + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeDeleteStudentConfirmModal();
        }
    };

    window.processCsvFile = async () => {
        if (isImporting) return showNotification('Proses impor sedang berjalan.');
        const file = document.getElementById('csvFileInput').files[0];
        const importFileError = document.getElementById('importFileError');
        if (!file) return importFileError.innerText = 'Pilih file CSV.';
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) return importFileError.innerText = 'File harus berformat CSV.';

        isImporting = true;
        loadingOverlay.style.display = 'flex';
        const reader = new FileReader();
        reader.onload = async (e) => {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');
            let importedCount = 0, skippedCount = 0, errorDetails = [];
            const batchUpdateMap = { '7ABC': {}, '7DEF': {} };

            for (let i = 1; i < lines.length; i++) {
                const parts = lines[i].split(',').map(p => p.trim());
                if (parts.length !== 4) {
                    skippedCount++;
                    errorDetails.push(`Baris ${i + 1}: Format tidak valid.`);
                    continue;
                }
                const [id, name, studentClass, studentRoom] = parts;
                const paddedId = padStudentId(id);
                
                if (!VALID_ROMBELS.includes(studentClass.toUpperCase())) {
                    skippedCount++; errorDetails.push(`Baris ${i + 1}: Kelas '${studentClass}' tidak valid.`); continue;
                }
                const targetDbName = rombelToDbMap[studentClass.toUpperCase()];
                if (studentCache.some(s => s.id === paddedId && s.firebaseGroup === targetDbName)) {
                    skippedCount++; errorDetails.push(`Baris ${i + 1}: ID '${id}' sudah ada.`); continue;
                }
                
                const newRef = push(ref(dbInstances[targetDbName], 'students'));
                batchUpdateMap[targetDbName][newRef.key] = { id: paddedId, name: name.toUpperCase(), class: studentClass.toUpperCase(), room: padRoomNumber(studentRoom), isLoggedIn: false };
                importedCount++;
            }
            
            try {
                const batchPromises = Object.keys(batchUpdateMap).map(dbName => {
                    if (Object.keys(batchUpdateMap[dbName]).length > 0) return update(ref(dbInstances[dbName], 'students'), batchUpdateMap[dbName]);
                }).filter(Boolean);
                await Promise.all(batchPromises);
                showNotification(`${importedCount} siswa berhasil diimpor!`);
            } catch (error) {
                showNotification(`Gagal mengimpor data: ${error.message}`);
            } finally {
                isImporting = false;
                loadingOverlay.style.display = 'none';
                closeImportStudentModal();
                document.getElementById('importResultSummary').innerHTML = `Berhasil: <b style="color:green;">${importedCount}</b>, Gagal: <b style="color:orange;">${skippedCount}</b>`;
                document.getElementById('importResultDetails').innerHTML = errorDetails.map(d => `<li style="color:red;">${d}</li>`).join('');
                document.getElementById('importResultModal').style.display = 'flex';
            }
        };
        reader.readAsText(file);
    };
    
    window.confirmEmptyStudents = async () => {
        if (document.getElementById('emptyStudentsPassword').value !== ADMIN_PASS) {
            return document.getElementById('emptyStudentsPasswordError').innerText = "Password salah!";
        }
        loadingOverlay.style.display = 'flex';
        try {
            const deletePromises = Object.values(dbInstances).flatMap(db => [
                remove(ref(db, 'students')), remove(ref(db, 'exam_access_status')),
                remove(ref(db, 'submitted_exams')), remove(ref(db, 'student_answers'))
            ]);
            await Promise.all(deletePromises);
            showNotification('Semua data peserta berhasil dikosongkan!');
        } catch (error) {
            showNotification('Gagal mengosongkan data peserta: ' + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeEmptyStudentsModal();
        }
    };
    
    function populateExamStatusFilter() {
        examStatusFilterDropdown.innerHTML = '<option value="">PILIH TOKEN UJIAN</option>';
        Array.from(consolidatedTokensMap.values()).forEach(token => {
            const option = document.createElement('option');
            option.value = Array.from(token.firebaseKeys)[0];
            option.innerText = `${token.token} (${token.subject} Kls ${token.kelas})`;
            examStatusFilterDropdown.appendChild(option);
        });
        if (examStatusFilterDropdown.value) renderStudentTable();
    }
    
    function renderScoreTable() {
        scoreTableHeader.innerHTML = '<th>NO</th><th>NAMA SISWA</th><th>KELAS</th>';
        scoreTableBody.innerHTML = '';
        const subjects = new Set();
        Array.from(consolidatedTokensMap.values()).forEach(token => {
            if (Array.from(token.firebaseKeys).some(fbKey => studentAnswersCache[fbKey])) {
                subjects.add(token.subject);
            }
        });
        const sortedSubjects = Array.from(subjects).sort();
        sortedSubjects.forEach(subject => scoreTableHeader.innerHTML += `<th>${subject.substring(0, 5)}</th>`);
        
        let studentsToDisplay = studentCache;
        
        const searchName = document.getElementById('scoreSearchName').value.trim().toUpperCase();
        if (searchName) studentsToDisplay = studentsToDisplay.filter(student => student.name.toUpperCase().includes(searchName));
        
        const searchClass = document.getElementById('scoreSearchClass').value.trim().toUpperCase();
        if (searchClass) studentsToDisplay = studentsToDisplay.filter(student => student.class.toUpperCase().includes(searchClass));

        studentsToDisplay.forEach((student, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${index + 1}</td><td>${student.name}</td><td>${student.class}</td>`;
            sortedSubjects.forEach(subject => {
                let score = '-';
                const tokenInfo = Array.from(consolidatedTokensMap.values()).find(t => t.subject === subject && getNumericClass(t.kelas) === getNumericClass(student.class));
                if(tokenInfo){
                    for(const fbKey of Array.from(tokenInfo.firebaseKeys)){
                         const answerData = studentAnswersCache[fbKey] && studentAnswersCache[fbKey][student.id];
                         if (answerData) {
                             score = calculateScore(answerData.answers, tokenInfo.answerKey);
                             break;
                         }
                    }
                }
                row.innerHTML += `<td>${score}</td>`;
            });
            scoreTableBody.appendChild(row);
        });
    }

    function calculateScore(studentAnswersString, answerKeyString) {
        if (!answerKeyString || !studentAnswersString) return 0;
        const correctAnswers = answerKeyString.split(','), studentAnswers = studentAnswersString.split(',');
        const totalQuestions = correctAnswers.length;
        if (totalQuestions === 0) return 0;
        let correctCount = 0;
        for (let i = 0; i < totalQuestions; i++) {
            if (i < studentAnswers.length && studentAnswers[i] && correctAnswers[i] && studentAnswers[i].trim().toUpperCase() === correctAnswers[i].trim().toUpperCase()) {
                correctCount++;
            }
        }
        return parseFloat(((correctCount / totalQuestions) * 100).toFixed(2));
    }

    function filterScoresByGrade(grade) { 
        document.getElementById('filterClass7').classList.toggle('active');
        renderScoreTable(); 
    };

    window.promptResetStudent = (key, id, name, studentClass) => {
        studentKeyForAction = key; studentIdForAction = id; studentNameForAction = name; studentClassForAction = studentClass;
        document.getElementById('resetStudentNameDisplay').innerText = name; 
        document.getElementById('resetStudentIdDisplay').innerText = id; 
        document.getElementById('resetStudentModal').style.display = 'flex';
    };

    window.confirmResetStudent = async () => {
        if (!studentIdForAction || !studentClassForAction) return;
        const targetDb = getDbForClass(studentClassForAction);
        if (!targetDb || Array.isArray(targetDb)) return showNotification("Gagal: Database tidak ditemukan.");
        loadingOverlay.style.display = 'flex';
        try {
            const updates = {};
            updates[`students/${studentKeyForAction}/isLoggedIn`] = false;
            
            const relevantTokens = tokenCache.filter(token => getNumericClass(token.kelas) === getNumericClass(studentClassForAction) && token.firebaseGroup === targetDb.app.name);
            for (const token of relevantTokens) {
                updates[`exam_access_status/${token.key}/${studentIdForAction}/isLoggedIn`] = false;
            }
            await update(ref(targetDb, '/'), updates);
            showNotification(`Status login siswa ${studentIdForAction} berhasil direset.`);
        } catch (error) {
            showNotification("Gagal mereset status login: " + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeResetStudentModal();
        }
    };

    window.promptSubmitAnswer = (key, id, name, studentClass) => {
        studentKeyForAction = key; studentIdForAction = id; studentNameForAction = name; studentClassForAction = studentClass;
        document.getElementById('submitStudentNameDisplay').innerText = name; 
        document.getElementById('submitStudentIdDisplay').innerText = id; 
        document.getElementById('submitAnswerModal').style.display = 'flex';
    };

    window.confirmSubmitAnswer = async () => {
        if (!studentIdForAction || !studentClassForAction) return;
        const targetDb = getDbForClass(studentClassForAction);
        if (!targetDb || Array.isArray(targetDb)) return showNotification("Gagal: Database tidak ditemukan.");
        loadingOverlay.style.display = 'flex';
        try {
            const updates = {};
            const relevantTokens = tokenCache.filter(token => getNumericClass(token.kelas) === getNumericClass(studentClassForAction) && token.firebaseGroup === targetDb.app.name);
            for (const token of relevantTokens) {
                 updates[`submitted_exams/${token.key}/${studentIdForAction}/isSubmitted`] = true;
                 updates[`submitted_exams/${token.key}/${studentIdForAction}/timestamp`] = Date.now();
            }
            if(Object.keys(updates).length > 0){
                await update(ref(targetDb, '/'), updates);
                showNotification(`Jawaban siswa ${studentIdForAction} berhasil disubmit.`);
            } else {
                showNotification('Tidak ada ujian aktif untuk disubmit.');
            }
        } catch (error) {
            showNotification("Gagal mengirim jawaban: " + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeSubmitAnswerModal();
        }
    };

    window.promptDeleteAnswer = (key, id, name, studentClass) => {
        studentKeyForAction = key; studentIdForAction = id; studentNameForAction = name; studentClassForAction = studentClass;
        document.getElementById('deleteAnswerStudentNameDisplay').innerText = name;
        document.getElementById('deleteAnswerStudentIdDisplay').innerText = id;
        document.getElementById('deleteAnswerPassword').value = '';
        document.getElementById('deleteAnswerPasswordError').innerText = '';
        document.getElementById('deleteAnswerModal').style.display = 'flex';
    };

    window.confirmDeleteAnswer = async () => {
        if (document.getElementById('deleteAnswerPassword').value !== ADMIN_PASS) {
            return document.getElementById('deleteAnswerPasswordError').innerText = "Password salah!";
        }
        if (!studentIdForAction || !studentClassForAction) return;
        const targetDb = getDbForClass(studentClassForAction);
        if (!targetDb || Array.isArray(targetDb)) return showNotification("Gagal: Database tidak ditemukan.");
        
        loadingOverlay.style.display = 'flex';
        try {
            const updates = {};
            const relevantTokens = tokenCache.filter(token => getNumericClass(token.kelas) === getNumericClass(studentClassForAction) && token.firebaseGroup === targetDb.app.name);
            for (const token of relevantTokens) {
                updates[`submitted_exams/${token.key}/${studentIdForAction}`] = null;
                updates[`student_answers/${token.key}/${studentIdForAction}`] = null;
                updates[`exam_access_status/${token.key}/${studentIdForAction}`] = null;
            }
            await update(ref(targetDb, '/'), updates);
            showNotification(`Semua jawaban siswa ${studentIdForAction} berhasil dihapus.`);
        } catch (error) {
            showNotification("Gagal menghapus jawaban: " + error.message);
        } finally {
            loadingOverlay.style.display = 'none';
            closeDeleteAnswerModal();
        }
    };

    function loadSetlokasiSettings() {
        onValue(ref(dbInstances['7ABC'], 'setlokasi'), (snapshot) => {
            const settings = snapshot.val();
            if (settings) {
                isLocationEnabledAdmin = settings.isLocationEnabled || false;
                allowedRadiusMeterAdmin = (settings.allowedRadiusKm || 0.075) * 1000;
            }
            updateSetlokasiStatusDisplay();
        }, (error) => console.error("Error memuat pengaturan lokasi:", error));
    }
    
    function loadLockSettings() {
        onValue(ref(dbInstances['7ABC'], 'lock_settings'), (snapshot) => {
            const settings = snapshot.val();
            if (settings) {
                isLockEnabledAdmin = settings.isLockEnabled || false;
                currentLockKeyAdmin = settings.lockKey || "KUNCI";
                toleranceLimitAdmin = settings.toleranceLimit || 3;
            }
            renderLockSettingsTable();
        }, (error) => console.error("Error memuat pengaturan kunci:", error));
    }
    
    function periksaAndUpdateStatusToken() {
        const now = new Date();
        tokenCache.forEach(tokenData => {
            const newIsActive = tokenData.isForceActive ? true : (now >= new Date(tokenData.startTime) && now < new Date(tokenData.endTime));
            if (tokenData.isActive !== newIsActive) {
                const targetDb = dbInstances[tokenData.firebaseGroup];
                if (targetDb) {
                    update(ref(targetDb, 'tokens/' + tokenData.key), { isActive: newIsActive }).catch(e => console.error(e));
                }
            }
        });
    }

    function loadTokenAccessStatus() {
        tokenAccessStatus = {};
        Object.keys(dbInstances).forEach(dbName => {
            onValue(ref(dbInstances[dbName], 'exam_access_status'), (snapshot) => {
                Object.assign(tokenAccessStatus, snapshot.val() || {});
                renderTokenTable();
                renderStudentTable();
            });
        });
    }

    function loadSubmittedExamsStatus() {
        submittedExamsCache = {};
        Object.keys(dbInstances).forEach(dbName => {
            onValue(ref(dbInstances[dbName], 'submitted_exams'), (snapshot) => {
                Object.assign(submittedExamsCache, snapshot.val() || {});
                renderTokenTable();
                renderStudentTable();
                renderScoreTable();
            });
        });
    }

    function loadStudentAnswers() {
        studentAnswersCache = {};
        Object.keys(dbInstances).forEach(dbName => {
            onValue(ref(dbInstances[dbName], 'student_answers'), (snapshot) => {
                Object.assign(studentAnswersCache, snapshot.val() || {});
                renderScoreTable();
            });
        });
    }
    
    function updateSetlokasiStatusDisplay() {
        locationSettingsTableBody.innerHTML = '';
        const row = document.createElement('tr');
        const statusText = isLocationEnabledAdmin ? 'ON' : 'OFF';
        const statusColor = isLocationEnabledAdmin ? 'green' : 'red';
        row.innerHTML = `
            <td><a href="http://maps.google.com/maps?q=${escapeHtmlAttributeForJsString(defaultLocationCoordinate)}" target="_blank">${defaultLocationCoordinate}</a></td>
            <td>${allowedRadiusMeterAdmin}m</td>
            <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
            <td><button class="icon-button" onclick="openSetlokasiModal()" title="Atur Lokasi"><i class="fas fa-map-marker-alt"></i></button></td>`;
        locationSettingsTableBody.appendChild(row);
    }

    function renderLockSettingsTable() {
        lockSettingsTableBody.innerHTML = '';
        const row = document.createElement('tr');
        const statusText = isLockEnabledAdmin ? 'ON' : 'OFF';
        const statusColor = isLockEnabledAdmin ? 'green' : 'red';
        row.innerHTML = `
            <td>${escapeHtmlAttributeForJsString(currentLockKeyAdmin)}</td>
            <td>${toleranceLimitAdmin}</td>
            <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
            <td><button class="icon-button edit" onclick="openSetLockModal()" title="Atur Kunci"><i class="fas fa-edit"></i></button></td>`;
        lockSettingsTableBody.appendChild(row);
    }
    
    window.openSetlokasiModal = () => document.getElementById('setlokasiModal').style.display = 'flex';
    window.closeSetlokasiModal = () => document.getElementById('setlokasiModal').style.display = 'none';
    window.openGantiRadiusModal = () => {
      document.getElementById('gantiRadiusModal').style.display = 'flex';
      document.getElementById('radiusMeter').value = allowedRadiusMeterAdmin;
      closeSetlokasiModal();
    };
    window.closeGantiRadiusModal = () => document.getElementById('gantiRadiusModal').style.display = 'none';
    
    window.aktifkanLokasi = async () => {
        await Promise.all(allSetlokasiRefs.map(dbRef => update(dbRef, { isLocationEnabled: true })));
        showNotification('Fitur lokasi berhasil diaktifkan.');
        closeSetlokasiModal();
    };
    window.nonaktifkanLokasi = async () => {
        await Promise.all(allSetlokasiRefs.map(dbRef => update(dbRef, { isLocationEnabled: false })));
        showNotification('Fitur lokasi berhasil dinonaktifkan.');
        closeSetlokasiModal();
    };
    window.gantiRadiusDanAktifkan = async () => {
        const radiusMeter = parseInt(document.getElementById('radiusMeter').value);
        if (isNaN(radiusMeter) || radiusMeter <= 0) return showNotification('Masukkan radius yang valid.');
        await Promise.all(allSetlokasiRefs.map(dbRef => update(dbRef, { allowedRadiusKm: radiusMeter / 1000, isLocationEnabled: true })));
        showNotification(`Radius lokasi diubah menjadi ${radiusMeter} meter dan diaktifkan.`);
        closeGantiRadiusModal();
    };
    
    window.openSetLockModal = () => document.getElementById('setLockModal').style.display = 'flex';
    window.closeSetLockModal = () => document.getElementById('setLockModal').style.display = 'none';
    window.openGantiKunciBatasModal = () => {
      document.getElementById('gantiKunciBatasModal').style.display = 'flex';
      document.getElementById('lockKeyInput').value = currentLockKeyAdmin;
      document.getElementById('toleranceLimitInput').value = toleranceLimitAdmin;
      closeSetLockModal();
    };
    window.closeGantiKunciBatasModal = () => document.getElementById('gantiKunciBatasModal').style.display = 'none';

    window.aktifkanKunci = async () => {
        await Promise.all(allLockSettingsRefs.map(dbRef => update(dbRef, { isLockEnabled: true })));
        showNotification('Fitur kunci berhasil diaktifkan.');
        closeSetLockModal();
    };
    window.nonaktifkanKunci = async () => {
        await Promise.all(allLockSettingsRefs.map(dbRef => update(dbRef, { isLocationEnabled: false })));
        showNotification('Fitur kunci berhasil dinonaktifkan.');
        closeSetLockModal();
    };
    window.gantiKunciDanBatas = async () => {
        const newLockKey = document.getElementById('lockKeyInput').value.trim().toUpperCase();
        const newToleranceLimit = parseInt(document.getElementById('toleranceLimitInput').value);
        if (!newLockKey || isNaN(newToleranceLimit) || newToleranceLimit < 0) return showNotification('Data tidak valid');
        await Promise.all(allLockSettingsRefs.map(dbRef => update(dbRef, { lockKey: newLockKey, toleranceLimit: newToleranceLimit, isLockEnabled: true })));
        showNotification(`Kunci diubah menjadi '${newLockKey}' dan batas toleransi menjadi ${newToleranceLimit}.`);
        closeGantiKunciBatasModal();
    };
    
  </script>
</body>
</html>
