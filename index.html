<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Ujian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    /* Gaya dasar body */
    body {
      font-family: 'Inter', sans-serif; /* Menggunakan font Inter */
      margin: 0;
      padding: 0;
      background-color: #f4f7f6; /* Warna latar belakang yang lebih terang */
      display: flex; /* Menggunakan flexbox untuk layout utama */
      min-height: 100vh; /* Memastikan body mengisi seluruh tinggi viewport */
      overflow-x: hidden; /* Mencegah scroll horizontal yang tidak diinginkan pada body */
    }

    /* Gaya sidebar */
    .sidebar {
      width: 80px; /* Lebar default (collapsed) */
      background-color: #2c3e50; /* Warna gelap untuk sidebar */
      color: white;
      padding: 20px 0; /* Padding vertikal saja */
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: sticky; /* Sidebar tetap di tempatnya saat scroll */
      top: 0;
      height: 100vh; /* Mengisi seluruh tinggi viewport */
      overflow-y: auto; /* Scrollable jika konten sidebar terlalu panjang */
      transition: width 0.3s ease-in-out, padding 0.3s ease-in-out; /* Transisi untuk lebar dan padding */
      flex-shrink: 0; /* Mencegah sidebar menyusut lebih jauh */
      z-index: 20; /* Pastikan sidebar di atas konten utama saat meluncur */
    }

    .sidebar.expanded {
      width: 200px; /* Lebar saat diperluas (diperkecil) */
      padding: 20px;
    }

    .sidebar .logo-container {
      text-align: center;
      margin-bottom: 30px;
      width: 100%; /* Memastikan logo container mengambil lebar penuh */
      padding: 0 10px; /* Padding untuk logo container saat collapsed */
      box-sizing: border-box;
    }

    .sidebar.expanded .logo-container {
      padding: 0; /* Hapus padding saat expanded */
    }

    .sidebar .logo {
      width: 50px; /* Ukuran logo di sidebar saat collapsed (diperkecil) */
      height: 50px; /* Ukuran logo di sidebar saat collapsed (diperkecil) */
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #3498db;
      padding: 3px;
      background-color: white;
      transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
    }

    .sidebar.expanded .logo {
      width: 70px; /* Ukuran logo saat diperluas (diperkecil) */
      height: 70px; /* Ukuran logo saat diperluas (diperkecil) */
    }

    .sidebar h2 {
      font-size: 1em; /* Ukuran font nama sekolah (disesuaikan) */
      margin-top: 10px;
      color: #ecf0f1;
      opacity: 0; /* Sembunyikan teks nama sekolah secara default */
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap; /* Mencegah teks patah baris */
      overflow: hidden; /* Sembunyikan overflow */
      height: 0; /* Sembunyikan tinggi */
    }

    .sidebar.expanded h2 {
      opacity: 1; /* Tampilkan teks nama sekolah saat diperluas */
      height: auto; /* Kembalikan tinggi */
    }

    .sidebar-nav {
      width: 100%;
      flex-grow: 1; /* Memungkinkan navigasi tumbuh */
    }

    .sidebar-nav button {
      background-color: transparent;
      color: white;
      border: none;
      padding: 12px 0; /* Padding vertikal, padding horizontal diatur oleh teks/ikon */
      margin-bottom: 10px;
      width: 100%;
      text-align: center; /* Pusatkan ikon saat collapsed */
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease, padding 0.3s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center; /* Pusatkan ikon saat collapsed */
      gap: 0; /* Tidak ada gap saat collapsed */
    }

    .sidebar-nav button:hover {
      background-color: #34495e;
      transform: translateX(5px);
    }

    .sidebar-nav button.active {
      background-color: #3498db;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .sidebar-nav button i {
      font-size: 18px;
      flex-shrink: 0; /* Mencegah ikon menyusut */
    }

    .sidebar-nav button span {
      opacity: 0; /* Sembunyikan teks menu secara default */
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
      max-width: 0; /* Sembunyikan lebar teks */
    }

    .sidebar.expanded .sidebar-nav button {
        justify-content: flex-start; /* Rata kiri saat diperluas */
        padding-left: 20px; /* Sesuaikan padding agar tidak terlalu mepet tepi */
        gap: 10px; /* Jarak antara ikon dan teks */
    }

    .sidebar.expanded .sidebar-nav button span {
      opacity: 1; /* Tampilkan teks menu saat diperluas */
      max-width: 150px; /* Beri lebar maksimum untuk teks */
    }

    .sidebar .footer {
      width: 100%;
      padding: 20px 10px;
      box-sizing: border-box;
      opacity: 0; /* Sembunyikan footer secara default */
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
      text-align: center;
    }

    .sidebar.expanded .footer {
      opacity: 1; /* Tampilkan footer saat diperluas */
    }

    /* Area konten utama */
    .main-content {
      flex-grow: 1; /* Mengisi sisa ruang */
      padding: 20px;
      background-color: #f4f7f6;
      display: flex;
      flex-direction: column;
      /* overflow-x: auto; Dikelola oleh .table-responsive di dalam */
      overflow-y: auto; /* Memungkinkan scroll vertikal */
      height: 100vh; /* Memastikan main-content mengisi sisa tinggi */
      box-sizing: border-box; /* Pastikan padding termasuk dalam tinggi */
    }

    /* Kontainer untuk bagian */
    .container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      width: 100%; /* Memastikan container mengisi lebar penuh */
      box-sizing: border-box;
    }

    /* Gaya input, select, textarea */
    input, select, textarea {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }

    /* Gaya tombol */
    button {
      padding: 12px 25px;
      margin: 10px auto;
      display: block;
      font-size: 16px;
      cursor: pointer;
      background-color: #3498db; /* Warna tombol utama */
      color: white;
      border: none;
      border-radius: 6px;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Gaya tombol teks baru */
    .text-button {
        padding: 10px 20px;
        margin: 5px; /* Sesuaikan margin agar tidak terlalu jauh */
        font-size: 15px;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-block; /* Agar bisa sejajar */
        text-align: center;
        white-space: nowrap; /* Pastikan teks tidak patah baris */
    }
    .text-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .text-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* Warna spesifik untuk tombol teks */
    .text-button.blue-gray { background-color: #607d8b; color: white; }
    .text-button.blue-gray:hover { background-color: #455a64; }
    .text-button.green { background-color: #4CAF50; color: white; }
    .text-button.green:hover { background-color: #43A047; }
    .text-button.red { background-color: #f44336; color: white; }
    .text-button.red:hover { background-color: #e53935; }
    .text-button.gray { background-color: #9e9e9e; color: white; }
    .text-button.gray:hover { background-color: #757575; }
    .text-button.light-blue { background-color: #2196F3; color: white; }
    .text-button.light-blue:hover { background-color: #1976D2; }
    .text-button.orange { background-color: #FF9800; color: white; }
    .text-button.orange:hover { background-color: #FB8C00; }


    /* Gaya pesan error */
    .error {
      color: #e74c3c;
      font-size: 14px;
      text-align: center;
      margin-top: 5px;
    }
    
    /* Gaya tabel responsif */
    .table-responsive {
        overflow-x: auto; /* Kunci untuk gulir horizontal */
        -webkit-overflow-scrolling: touch;
        border-radius: 8px; /* Sudut membulat untuk tabel */
        overflow-y: hidden; /* Pastikan tidak ada scroll vertikal di sini */
    }
    table {
      width: 100%; /* Agar tabel mengisi lebar container */
      border-collapse: collapse;
      font-size: 14px;
      /* min-width dihapus agar lebih responsif, akan diatur oleh konten */
    }
    /* Specific min-widths for tables that need to ensure content is visible */
    #tokenTable {
      min-width: 1300px; /* Lebar minimum yang lebih besar untuk tabel token */
    }
    #studentTable {
      min-width: 750px; /* Lebar minimum yang lebih besar untuk tabel siswa */
    }
    #lockSettingsTable, #locationSettingsTable { /* NEW: Lock and Location settings table */
        min-width: 500px;
    }


    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      word-wrap: break-word;
      text-align: left;
    }
    /* Default td max-width, overridden by specific rules */
    td {
        white-space: nowrap; /* Default untuk sel agar tidak patah baris */
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px; /* Batasi lebar sel agar tidak terlalu lebar */
    }

    th {
      background-color: #ecf0f1; /* Warna header tabel */
      text-align: center; /* Default center for headers */
      font-weight: bold;
      color: #2c3e50;
      white-space: nowrap; /* Pastikan header tidak patah baris */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- Gaya Khusus Tabel Nilai --- */
    #scoreTable {
        table-layout: auto; /* Allow column widths to adjust based on content */
        min-width: 900px; /* Ensure a minimum width for score table */
    }
    #scoreTableHeader th:nth-child(1),
    #scoreTableBody td:nth-child(1) { /* NO */
        width: 60px;
        min-width: 60px;
        max-width: 60px;
        text-align: center;
    }
    #scoreTableHeader th:nth-child(2) { /* NAMA SISWA Header */
        text-align: center; /* Diubah menjadi rata tengah */
        width: auto; /* Lebar otomatis */
        white-space: normal; /* Izinkan teks membungkus */
    }
    #scoreTableBody td:nth-child(2) { /* NAMA SISWA Body */
        text-align: left; /* Nama siswa tetap rata kiri */
        width: auto;
        white-space: normal; /* Izinkan teks membungkus */
    }
    #scoreTableHeader th:nth-child(3),
    #scoreTableBody td:nth-child(3) { /* KELAS */
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
    }
    /* Kolom Mata Pelajaran di Header Tabel Nilai (setelah NO, NAMA SISWA, KELAS) */
    #scoreTableHeader th:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)) {
        text-align: center; /* Rata tengah untuk singkatan mapel */
        font-style: italic; /* Teks miring */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        /* max-width dan width dihapus untuk fleksibilitas */
        min-width: 80px; /* Minimum width for abbreviation */
    }

    /* Kolom Nilai di Body Tabel Nilai (setelah NO, NAMA SISWA, KELAS) */
    #scoreTableBody td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)) { 
        text-align: center; /* Rata tengah untuk nilai */
        /* max-width dan width dihapus untuk fleksibilitas */
        min-width: 80px;
    }
    /* --- Akhir Gaya Khusus Tabel Nilai --- */


    tr:nth-child(even) {
        background-color: #f9f9f9; /* Warna zebra striping */
    }

    /* Penjajaran khusus untuk Tabel Pengaturan Lokasi */
    #locationSettingsTableBody td:nth-child(1) { text-align: center; }
    #locationSettingsTableBody td:nth-child(2) { text-align: center; }
    #locationSettingsTableBody td:nth-child(3) { text-align: center; }
    #locationSettingsTableBody td:nth-child(4) { text-align: center; }
    #locationSettingsTableBody td:nth-child(4) button {
      display: inline-block;
      margin: 0;
    }

    /* NEW: Penjajaran khusus untuk Tabel Atur Kunci */
    #lockSettingsTableBody td:nth-child(1) { text-align: center; } /* KUNCI */
    #lockSettingsTableBody td:nth-child(2) { text-align: center; } /* BATAS TOLERANSI */
    #lockSettingsTableBody td:nth-child(3) { text-align: center; } /* STATUS */
    #lockSettingsTableBody td:nth-child(4) { text-align: center; } /* AKSI */
    #lockSettingsTableBody td:nth-child(4) button {
      display: inline-block;
      margin: 0;
    }


    /* Penjajaran khusus untuk Tabel Daftar Token */
    #tokenTableBody td:nth-child(1) { text-align: center; } /* NO */
    #tokenTableBody td:nth-child(3) { text-align: center; } /* KELAS */
    #tokenTableBody td:nth-child(4) { text-align: center; } /* TOKEN */
    #tokenTableBody td:nth-child(6) { text-align: center; } /* KUNJAB (NEW) */
    #tokenTableBody td:nth-child(7) { text-align: center; } /* TOKEN DIBUKA (shifted from 6) */
    #tokenTableBody td:nth-child(8) { text-align: center; } /* TOKEN DITUTUP (shifted from 7) */
    #tokenTableBody td:nth-child(9) { text-align: center; } /* DURASI (MENIT) (shifted from 8) */
    #tokenTableBody td:nth-child(10) { text-align: center; } /* STATUS (shifted from 9) */
    #tokenTableBody td:nth-child(11) { text-align: center; } /* AKSES (shifted from 10) */
    #tokenTableBody td:nth-child(12) { text-align: center; } /* SUBMIT (shifted from 11) */
    #tokenTableBody td:nth-child(13) { text-align: center; } /* AKSI (shifted from 12) */

    /* Penjajaran khusus untuk Tabel Daftar Siswa */
    #studentTableBody td:nth-child(1) { text-align: center; } /* NO */
    #studentTableBody td:nth-child(2) { text-align: center; } /* ID SISWA */
    #studentTableBody td:nth-child(4) { text-align: center; } /* KELAS */
    #studentTableBody td:nth-child(5) { text-align: center; } /* RUANG */
    #studentTableBody td:nth-child(6) { text-align: center; } /* STATUS */
    #studentTableBody td:last-child { text-align: center; } /* AKSI */

    /* Gaya untuk tombol edit/hapus siswa agar sejajar */
    .student-action-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: nowrap; /* Pastikan tombol tidak patah baris */
        flex-shrink: 0; /* Mencegah container menyusut */
    }
    /* Base style for all icon buttons within tables */
    .icon-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px; /* Ukuran tombol */
      height: 28px; /* Ukuran tombol */
      border-radius: 50%; /* Membuat tombol bulat */
      transition: background-color 0.2s ease, transform 0.1s ease;
      flex-shrink: 0; /* Pastikan tombol tidak menyusut */
    }
    .icon-button:hover {
      background-color: #cfe2f3; /* Light blue on hover */
      transform: translateY(-1px);
    }
    .icon-button:active {
      transform: translateY(0);
    }
    .icon-button i { /* For font-awesome icons */
        font-size: 16px;
        color: #2c3e50; /* Darker color for visibility */
    }
    .icon-button:hover i {
        color: #2c3e50; /* Keep same color on hover */
    }
    /* Specific colors for action icons if needed, but aim for consistency */
    .icon-button.edit i { color: #3498db; } /* Blue for edit */
    .icon-button.delete i { color: #e74c3c; } /* Red for delete */
    .icon-button.reset i { color: #8e44ad; } /* Purple for reset */
    .icon-button.submit i { color: #27ae60; } /* Green for submit */
    .icon-button.erase i { color: #f39c12; } /* Orange for erase */


    /* Gaya footer */
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #7f8c8d;
      font-size: 13px;
    }
    .date-time {
      font-size: 14px;
      color: #555;
    }
    /* Gaya modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000; /* Lebih tinggi dari elemen lain */
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); /* Latar belakang modal lebih gelap */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 450px; /* Maks lebar modal */
      box-sizing: border-box;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      text-align: center;
    }
    .modal h4 {
        color: #2c3e50;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.5em;
    }
    .modal p {
        margin-bottom: 20px;
        color: #34495e;
    }
    .modal button {
      margin: 8px;
      display: inline-block;
      width: auto;
      min-width: 100px;
      padding: 10px 20px;
      font-size: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Tambahkan bayangan ke tombol modal */
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .modal button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .modal button:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .modal button.confirm-button {
        background-color: #28a745; /* Hijau untuk konfirmasi */
        color: white;
    }
    .modal button.confirm-button:hover {
        background-color: #218838;
    }
    .modal button.cancel-button {
        background-color: #dc3545; /* Merah untuk batal */
        color: white;
    }
    .modal button.cancel-button:hover {
        background-color: #c82333;
    }
    .modal button.warning-button { /* NEW: Warning button style */
        background-color: #ffc107;
        color: black;
    }
    .modal button.warning-button:hover {
        background-color: #e0a800;
    }
    .modal button.gray { /* For generic gray button in modals */
        background-color: #9e9e9e;
        color: white;
    }
    .modal button.gray:hover {
        background-color: #757575;
    }


    .login-link {
      color: #3498db;
      text-decoration: underline;
      font-weight: bold;
      transition: color 0.3s ease;
    }
    .login-link:hover {
      color: #2980b9;
      cursor: pointer;
    }
    .login-link:active {
      color: #e74c3c;
    }
    
    /* Removed .icon-button img specific styles as we are using <i> for Font Awesome */


    /* Penyesuaian khusus mobile */
    @media (max-width: 768px) {
      body {
        flex-direction: column; /* Tumpuk sidebar dan konten utama */
      }
      .sidebar {
        width: 100%; /* Lebar penuh untuk sidebar */
        height: auto; /* Tinggi otomatis */
        position: relative; /* Tidak sticky di mobile */
        border-radius: 0; /* Tanpa sudut di mobile */
        padding: 15px 10px;
      }
      .sidebar.expanded { /* Di mobile, expanded tetap lebar penuh */
        width: 100%;
      }
      .sidebar .logo-container {
        padding: 0; /* Hapus padding di mobile */
      }
      .sidebar .logo {
        width: 40px; /* Lebih kecil di mobile */
        height: 40px;
      }
      .sidebar.expanded .logo { /* Logo tetap ukuran mobile saat expanded di mobile */
        width: 40px;
        height: 40px;
      }
      .sidebar h2 {
        font-size: 0.9em; /* Lebih kecil di mobile */
        height: auto; /* Selalu tampil di mobile */
        opacity: 1;
      }
      .sidebar-nav {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 15px;
      }
      .sidebar-nav button {
        width: auto; /* Lebar otomatis */
        padding: 10px 12px;
        font-size: 14px;
        flex-grow: 1; /* Biarkan tombol tumbuh */
        justify-content: center; /* Pusatkan teks dan ikon */
      }
      .sidebar-nav button span {
        display: none; /* Sembunyikan teks menu di mobile sangat kecil */
      }
      .sidebar-nav button i {
        margin-right: 0; /* Hapus margin ikon */
      }
      .sidebar.expanded .sidebar-nav button span { /* Teks menu tetap tersembunyi di mobile */
        display: none;
      }
      .sidebar .footer {
        opacity: 1; /* Selalu tampil di mobile */
        height: auto;
      }
      /* Tidak ada tombol sidebar-toggle di mobile */

      .main-content {
        padding: 15px;
        height: auto; /* Izinkan tinggi menyesuaikan berdasarkan konten */
        min-height: 100vh; /* Pastikan mengambil setidaknya tinggi viewport penuh */
      }
      /* Header-content dihapus, jadi tidak perlu penyesuaian mobile */
      .container {
        padding: 15px;
      }

      input, select, textarea {
        font-size: 14px;
        padding: 10px;
      }
      button {
        font-size: 14px;
        padding: 10px 20px;
      }
      table {
        font-size: 11px;
        /* min-width diatur di luar media query agar tetap lebar */
      }
      th, td {
        padding: 8px;
      }
      /* Hapus semua display: none untuk kolom di mobile */
      /* Tabel akan mengandalkan overflow-x: auto pada .table-responsive */

      /* Responsiveness for student action buttons */
      .student-action-buttons {
          flex-wrap: wrap; /* Allow buttons to wrap */
          justify-content: center; /* Center buttons when wrapped */
          gap: 3px; /* Smaller gap on mobile */
      }
      .student-action-buttons .icon-button { /* Use the general icon-button class */
          width: 24px; /* Slightly smaller button size */
          height: 24px;
      }
      .student-action-buttons .icon-button i { /* Use the general icon-button class */
          font-size: 14px; /* Smaller icons */
      }

      /* Responsiveness for import/empty/print buttons */
      .main-content > div > div:nth-child(3) > div:nth-child(2) { /* Specific selector for this button group */
          flex-wrap: wrap;
          justify-content: center;
          gap: 8px;
      }
      .main-content > div > div:nth-child(3) > div:nth-child(2) button {
          flex-grow: 1; /* Allow buttons to grow and fill space */
          max-width: 100%; /* Ensure they don't exceed container width */
      }
    }

    @media (max-width: 480px) {
      .sidebar-nav button span {
        display: none; /* Pastikan teks menu hilang */
      }
      .sidebar-nav button {
        padding: 10px; /* Hanya ikon */
      }
    }

    /* Gaya notifikasi */
    #notification {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745; /* Warna notifikasi hijau */
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10000; /* Pastikan di atas semua modal */
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-weight: bold;
    }
    
    /* Overlay loading */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999; /* Sangat tinggi */
    }

    .spinner {
        border: 5px solid rgba(0, 0, 0, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border-left-color: #3498db; /* Warna spinner */
        animation: spin 1s ease infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Gaya untuk filter kelas di bagian nilai ujian */
    .score-filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
    }
    .score-filters-container button {
        flex-grow: 1;
        margin: 0;
        padding: 8px 15px;
        font-size: 14px;
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
        box-shadow: none;
    }
    .score-filters-container button.active {
        background-color: #3498db;
        color: white;
        border-color: #3498db;
    }
    .score-filters-container input[type="text"] {
        flex-grow: 1;
        max-width: 200px;
        margin: 0;
    }
    .score-filters-container .filter-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Gaya untuk input kunci jawaban yang dibagi 2 */
    .answer-key-input-group {
        display: flex;
        gap: 10px;
        align-items: flex-end; /* Align items to the bottom */
        margin: 8px 0;
    }
    .answer-key-input-group > div {
        display: flex;
        flex-direction: column;
    }
    .answer-key-input-group label {
        font-size: 0.8em;
        color: #555;
        margin-bottom: 2px; /* Small margin below label */
    }
    .answer-key-input-group input {
        margin: 0; /* Remove default margin */
        height: auto; /* Allow height to adjust */
    }
    .answer-key-input-group .count-input {
        flex-shrink: 0;
        width: 80px; /* Fixed width for count input */
        text-align: center;
        background-color: #e9ecef;
        cursor: default;
    }
    .answer-key-input-group .key-input {
        flex-grow: 1; /* Take remaining space */
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo SMPN 2 Pajangan" class="logo">
      <h2>SMPN 2 PAJANGAN</h2> </div>
    <nav class="sidebar-nav">
      <button id="tokenMenuBtn" data-section-id="tokenSection" onclick="handleMenuClick(this)">
        <i class="fas fa-key"></i> <span>Token</span>
      </button>
      <button id="pesertaMenuBtn" data-section-id="studentSection" onclick="handleMenuClick(this)">
        <i class="fas fa-users"></i> <span>Peserta</span>
      </button>
      <button id="scoreMenuBtn" data-section-id="scoreSection" onclick="handleMenuClick(this)">
        <i class="fas fa-chart-bar"></i> <span>Nilai Ujian</span>
      </button>
      <button id="aturanMenuBtn" data-section-id="rulesSection" onclick="handleMenuClick(this)">
        <i class="fas fa-cog"></i> <span>Aturan</span>
      </button>
      <button data-action="promptLogout" onclick="handleMenuClick(this)">
        <i class="fas fa-sign-out-alt"></i> <span>Keluar</span>
      </button>
    </nav>
    <div class="footer" style="margin-top: auto; padding-top: 20px;">
      <div>@Admin SMPN 2 Pajangan</div>
      <div id="adminDateTime" class="date-time" style="color: #bdc3c7;"></div>
    </div>
  </div>

  <div class="main-content" id="mainContent">
    <div class="container" id="loginSection">
      <h3 style="text-align: center; color: #2c3e50;">LOGIN ADMINISTRASI</h3>
      <p id="loginError" class="error"></p>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p style="text-align: center; font-size: 14px; margin-top: 10px;">
        Halaman login ujian siswa?
        <a href="http://smp2pajangan.github.io/loginujian" class="login-link">Loginujian</a>
      </p>
      <div class="footer">
        <div>@Admin SMPN 2 Pajangan</div>
        <div id="currentTime" class="date-time"></div>
      </div>
    </div>

    <div id="dashboardContent" style="display:none;">
      <div id="tokenSection" class="dashboard-section container">
        <h1 id="tokenSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Manajemen Token</h1>
        <h3>TAMBAH / EDIT TOKEN</h3>
        <form id="tokenForm">
          <label>Mata Pelajaran</label>
          <input type="text" id="subject" placeholder="Gunakan kapital" required />
          <label>Kelas</label>
          <input type="text" id="kelas" placeholder="Berupa angka saja (7)" required />
          <label>Token Ujian (Base Token)</label>
          <input type="text" id="token" placeholder="Berupa huruf/angka (gunakan kapital)" required />
          
          <label for="googleDriveUrl">Link Google Drive PDF Soal</label>
          <input type="url" id="googleDriveUrl" placeholder="Contoh: https://drive.google.com/file/d/FILE_ID/view?usp=sharing" required />
          <p id="googleDriveUrlError" class="error"></p>

          <div class="answer-key-input-group">
            <div class="count-input-container">
              <label for="answerKeyCount">Jumlah Soal</label>
              <input type="text" id="answerKeyCount" readonly class="count-input" value="0" />
            </div>
            <div class="key-input-container">
              <label for="answerKey">Kunci Jawaban</label>
              <input type="text" id="answerKey" placeholder="Contoh: A,B,C,D,D" required class="key-input" />
            </div>
          </div>
          <p id="answerKeyError" class="error"></p>

          <label>Waktu Token Dibuka</label>
          <input type="datetime-local" id="startTime" required />
          <label>Waktu Token Ditutup</labeL>
          <input type="datetime-local" id="endTime" required />
          <button type="submit">Tambah</button>
          <p id="errorMsg" class="error"></p>
        </form>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 30px;">
          <h3 style="margin-bottom: 0;">DAFTAR TOKEN</h3>
          <button class="text-button blue-gray" onclick="openCopyPrintModal('tokenTable', 'Cetak Daftar Token')">Cetak</button>
        </div>

        <p style="font-size: 11px; color: #555; margin-top: -10px; margin-bottom: 10px; text-align: center;">
          Token yang ditambahkan akan dihapus otomatis setelah 30 hari!
        </p>

        <div class="table-responsive">
          <table id="tokenTable">
            <thead>
              <tr>
                <th>NO</th>
                <th>MAPEL</th>
                <th>KELAS</th>
                <th>TOKEN</th>
                <th>PDF</th>
                <th>KUNJAB</th> <th>TOKEN DIBUKA</th>
                <th>TOKEN DITUTUP</th>
                <th>DURASI</th>
                <th>STATUS</th>
                <th>AKSES</th>
                <th>SUBMIT</th>
                <th>AKSI</th>
              </tr>
            </thead>
            <tbody id="tokenTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="rulesSection" class="dashboard-section container">
        <h1 id="rulesSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Pengaturan Lokasi dan Penguncian</h1>
        
        <div style="margin-bottom: 20px;">
          <h3>ATUR AKSES LOKASI</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Aturan akses lokasi digunakan untuk mengatur akses login siswa hanya sesuai radius lokasi saja.
          </p>
          <div class="table-responsive">
            <table id="locationSettingsTable">
              <thead>
                <tr>
                  <th>KOORDINAT LOKASI</th>
                  <th>RADIUS</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="locationSettingsTableBody">
                </tbody>
            </table>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h3>ATUR KUNCI</h3>
          <p style="text-align: left; font-size: 0.9em; color: #555; margin-top: 5px; margin-bottom: 15px;">
            Aturan kunci digunakan untuk mengatur kunci yang harus dimasukkan siswa ketika mereka sedang terkunci karena keluar dalam mode fullscreen dengan melebihi batas toleransi.
          </p>
          <div class="table-responsive">
            <table id="lockSettingsTable">
              <thead>
                <tr>
                  <th>KUNCI</th>
                  <th>BATAS TOLERANSI</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="lockSettingsTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="studentSection" class="dashboard-section container">
        <h1 id="studentSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Manajemen Peserta</h1>
        <div style="margin-bottom: 20px;">
          <h3>MANAJEMEN SISWA</h3>
          <form id="studentForm">
            <label>ID Siswa</label>
            <input type="text" id="studentId" placeholder="Contoh: 001" required />
            <label>Nama Siswa</label>
            <input type="text" id="studentName" placeholder="Nama Lengkap Siswa" required />
            <label>Kelas</label>
            <input type="text" id="studentClass" placeholder="Contoh: 7A, 7B, 7C" required />
            <label>Ruang</label>
            <input type="text" id="studentRoom" placeholder="Contoh: 01, 02, dsb" required /> 
            <button type="submit" id="addStudentButton">Tambah Siswa</button>
            <button type="button" id="updateStudentButton" style="display:none;">Perbarui Siswa</button>
            <p id="studentErrorMsg" class="error"></p>
          </form>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 10px;">
            <h3 style="margin-bottom: 0;">DAFTAR SISWA</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
              <button class="text-button green" onclick="openImportStudentModal()">Impor Siswa</button>
              <button class="text-button red" onclick="openEmptyStudentsModal()">Kosongkan Daftar</button>
              <button class="text-button gray" onclick="showPrintInfoModal()">Cetak Kartu</button>
            </div>
          </div>

          <div class="student-filters-container">
              <div>
                  <label for="classFilterDropdownSelect">KELAS:</label>
                  <select id="classFilterDropdownSelect" onchange="filterStudentsByClass(this.value)">
                      <option value="">SEMUA KELAS</option>
                      </select>
              </div>
              <div>
                  <label for="examStatusFilter">STATUS UJIAN:</label>
                  <select id="examStatusFilter" onchange="filterStudentsByExamStatus(this.value)">
                      <option value="">TOKEN SAAT INI</option>
                      </select>
              </div>
          </div>

          <div class="table-responsive">
            <table id="studentTable">
              <thead>
                <tr>
                  <th>NO</th>
                  <th>ID SISWA</th>
                  <th>NAMA</th>
                  <th>KELAS</th>
                  <th>RUANG</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
            <tbody id="studentTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="scoreSection" class="dashboard-section container">
        <h1 id="scoreSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Daftar Nilai Ujian</h1>
        <div class="score-filters-container">
            <div class="filter-group">
                <button id="filterClass7" onclick="filterScoresByGrade(7)">Kelas 7</button>
                </div>
            <input type="text" id="scoreSearchName" placeholder="Cari Nama Siswa" onkeyup="renderScoreTable()" />
            <input type="text" id="scoreSearchClass" placeholder="Cari Kelas (misal: 7A)" onkeyup="renderScoreTable()" />
            <div style="display: flex; gap: 10px;">
                <button class="text-button light-blue" onclick="openCopyPrintModal('scoreTable', 'Cetak Daftar Nilai')">Cetak</button>
            </div>
        </div>
        <div class="table-responsive">
          <table id="scoreTable">
            <thead>
              <tr id="scoreTableHeader">
                <th>NO</th>
                <th>NAMA SISWA</th>
                <th>KELAS</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody"></tbody>
          </table>
        </div>
      </div>
      </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h4>Edit Token</h4>
      <form id="modalForm">
        <label>Mata Pelajaran</label>
        <input type="text" id="editSubject" required />
        <label>Kelas</label>
        <input type="text" id="editKelas" placeholder="Berupa angka saja (7)" required />
        <label>Token Ujian</label>
        <input type="text" id="editToken" required />
        
        <label for="editGoogleDriveUrl">Link Google Drive PDF Soal</label>
        <input type="url" id="editGoogleDriveUrl" placeholder="Contoh: https://drive.google.com/file/d/FILE_ID/view?usp=sharing" required />
        <p id="editGoogleDriveUrlError" class="error"></p>

        <div class="answer-key-input-group">
          <div class="count-input-container">
            <label for="editAnswerKeyCount">Jumlah Soal</label>
            <input type="text" id="editAnswerKeyCount" readonly class="count-input" value="0" />
          </div>
          <div class="key-input-container">
            <label for="editAnswerKey">Kunci Jawaban</label>
            <input type="text" id="editAnswerKey" placeholder="Hanya A,B,C,D dipisah koma" required class="key-input" />
          </div>
        </div>
        <p id="editAnswerKeyError" class="error"></p>

        <label>Waktu Token Dibuka</label>
        <input type="datetime-local" id="editStartTime" required />
        <label>Waktu Token Ditutup</labeL>
        <input type="datetime-local" id="editEndTime" required />
        <p id="editErrorMsg" class="error"></p>
        <button type="submit">Simpan</button>
        <button type="button" onclick="closeEditModal()" class="cancel-button">Batal</button>
      </form>
    </div>
  </div>

  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <p>Yakin ingin menghapus token ini?</p>
      <button onclick="confirmDelete()" class="confirm-button">Hapus</button>
      <button onclick="closeDeleteModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="forceActiveModal" class="modal">
    <div class="modal-content">
      <p>Apakah Anda yakin ingin <b>mengaktifkan token secara paksa</b>? Hal ini akan membuat token dapat diakses kapanpun!</p>
      <div>
        <label for="forceActivePassword">Password:</label>
        <input type="password" id="forceActivePassword">
        <p id="forceActivePasswordError" class="error"></p>
      </div>
      <button onclick="confirmForceActive()" class="confirm-button">Mengaktifkan</button>
      <button onclick="closeForceActiveModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="forceInactiveModal" class="modal">
    <div class="modal-content">
      <p>Apakah Anda yakin ingin <b>menonaktifkan token secara paksa</b>? Hal ini akan membuat token kembali ke pengaturan jadwal!</p>
      <button onclick="confirmForceInactive()" class="confirm-button">Nonaktifkan</button>
      <button onclick="closeForceInactiveModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="notification">
    <span id="notificationMessage"></span>
  </div>

  <div id="copyPrintModal" class="modal">
    <div class="modal-content">
      <h4 id="copyPrintModalTitle"></h4>
      <button onclick="copyTableToClipboard()" class="confirm-button">Salin Tabel</button>
      <p style="font-size: 0.9em; color: #555; margin-top: 15px;">
        Salin tabel kemudian paste ke word atau excel.
      </p>
      <button onclick="closeCopyPrintModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="printInfoModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closePrintInfoModal()">×</span>
        <p style="margin-bottom: 20px;">
            Maaf, sementara cetak kartu belum bisa. Silahkan download 2 file excel dan word dibawah ini:
        </p>
        <p style="margin-bottom: 10px;">
            <a href="https://drive.google.com/uc?export=download&id=1rLFyKUzQloJi7LAnO-x7Q-lK0BzdxQv3" target="_blank">File Word (disini)</a>
        </p>
        <p style="margin-bottom: 20px;">
            <a href="https://drive.google.com/uc?export=download&id=14uoOXQScECxd9hXD4AIMJjFBlmbSAgxS" target="_blank">File Excel (disini)</a>
        </p>
        <p style="font-size: 14px; color: #555;">
            **Catatan:** ISI ID_SISWA SESUAI DENGAN TEMPLATE CSV!
        </p>
    </div>
  </div>

  <div id="setlokasiModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h4>Pengaturan Lokasi</h4>
      <button onclick="aktifkanLokasi()" class="confirm-button">Aktifkan</button>
      <button onclick="openGantiRadiusModal()" class="warning-button">Ganti Radius</button>
      <button onclick="nonaktifkanLokasi()" class="cancel-button">Nonaktifkan</button>
      <button onclick="closeSetlokasiModal()" class="gray text-button" style="margin-top: 10px;">Batal</button>
    </div>
  </div>

  <div id="gantiRadiusModal" class="modal">
    <div class="modal-content">
      <h4>Ganti Radius Lokasi (meter)</h4>
      <label for="radiusMeter">Radius (meter):</label>
      <input type="number" id="radiusMeter" placeholder="Contoh: 75" required />
      <div style="text-align: center; margin-top: 10px;">
        <button onclick="gantiRadiusDanAktifkan()" class="confirm-button">Ganti & Aktifkan</button>
        <button onclick="closeGantiRadiusModal()" class="cancel-button">Batal</button>
      </div>
    </div>
  </div>

  <div id="setLockModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h4>Pengaturan Kunci</h4>
      <button onclick="aktifkanKunci()" class="confirm-button">Aktifkan</button>
      <button onclick="openGantiKunciBatasModal()" class="warning-button">Ganti Kunci/Batas</button>
      <button onclick="nonaktifkanKunci()" class="cancel-button">Nonaktifkan</button>
      <button onclick="closeSetLockModal()" class="gray text-button" style="margin-top: 10px;">Batal</button>
    </div>
  </div>

  <div id="gantiKunciBatasModal" class="modal">
    <div class="modal-content">
      <h4>Ganti Kunci dan Batas Toleransi</h4>
      <label for="lockKeyInput">Kunci:</label>
      <input type="text" id="lockKeyInput" placeholder="Contoh: KUNCIAMAN" required />
      <label for="toleranceLimitInput">Batas Toleransi:</label>
      <input type="number" id="toleranceLimitInput" placeholder="Contoh: 3" required />
      <p id="lockSettingsError" class="error"></p>
      <div style="text-align: center; margin-top: 10px;">
        <button onclick="gantiKunciDanBatas()" class="confirm-button">Ganti & Aktifkan</button>
        <button onclick="closeGantiKunciBatasModal()" class="cancel-button">Batal</button>
      </div>
    </div>
  </div>


  <div id="accessDetailModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <h4 id="accessDetailTokenTitle">Detail Akses Token: [Token]</h4>
      <div class="table-responsive">
        <table id="accessDetailTable">
          <thead>
            <tr>
              <th>NO</th>
              <th>ID SISWA</th>
              <th>NAMA SISWA</th>
              <th>KELAS</th>
              <th>STATUS AKSES</th>
              <th>WAKTU AKSES PERTAMA</th>
            </tr>
          </thead>
          <tbody id="accessDetailTableBody">
            </tbody>
        </table>
      </div>
      <button onclick="closeAccessDetailModal()" style="margin-top: 20px;">Tutup</button>
    </div>
  </div>

  <div id="editStudentModal" class="modal">
    <div class="modal-content">
      <h4>Edit Data Siswa</h4>
      <p id="editStudentErrorMsg" class="error"></p>
      <label for="modalStudentId">ID Siswa</label>
      <input type="text" id="modalStudentId" required />
      <label for="modalStudentName">Nama Siswa</label>
      <input type="text" id="modalStudentName" required />
      <label for="modalStudentClass">Kelas</label>
      <input type="text" id="modalStudentClass" placeholder="Contoh: 7A, 7B, 7C" required />
      <label for="modalStudentRoom">Ruang</label>
      <input type="text" id="modalStudentRoom" placeholder="Contoh: 01, 02, dsb" required /> 
      <button onclick="confirmEditStudent()">Simpan</button>
      <button type="button" onclick="closeEditStudentModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="deleteStudentConfirmModal" class="modal">
    <div class="modal-content">
      <p>Yakin ingin menghapus siswa ini?</p>
      <button onclick="confirmDeleteStudent()" class="confirm-button">Hapus</button>
      <button onclick="closeDeleteStudentConfirmModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="importStudentModal" class="modal">
    <div class="modal-content">
      <h4>Import Data Peserta dari CSV</h4>
      <p style="font-size: 0.9em; color: #555; text-align: left;">
        Perhatikan hal-hal berikut!<br>
        1. Siapkan data peserta dengan 4 kolom: ID Peserta (angka), Nama Lengkap, Kelas, dan Ruang<br>
        2. Simpan file dengan format *.csv (comma delimited)<br>
        3. Pastikan tidak ada kolom tambahan
      </p>
      <a href="https://drive.google.com/uc?export=download&id=16rzsLjQ3AVm0wIPqWnzsauzbrwGfO7An" target="_blank" style="display: block; text-align: center; margin: 15px 0; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">Unduh Template CSV</a> 
      <input type="file" id="csvFileInput" accept=".csv" style="margin-top: 15px; margin-bottom: 10px;" />
      <p id="importFileError" class="error"></p>
      <button onclick="processCsvFile()">Mulai Impor</button>
      <button onclick="closeImportStudentModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="importResultModal" class="modal">
    <div class="modal-content">
      <h4>Hasil Impor Data Siswa</h4>
      <p id="importResultSummary"></p>
      <ul id="importResultDetails" style="text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px;"></ul>
      <button onclick="closeImportResultModal()">Tutup</button>
    </div>
  </div>

  <div id="emptyStudentsModal" class="modal">
    <div class="modal-content">
      <h4>Kosongkan Daftar Peserta</h4>
      <p>Anda yakin ingin menghapus <b>SEMUA</b> data peserta? Tindakan ini tidak dapat dibatalkan.</p>
      <div>
        <label for="emptyStudentsPassword">Password Admin:</label>
        <input type="password" id="emptyStudentsPassword">
        <p id="emptyStudentsPasswordError" class="error"></p>
      </div>
      <button onclick="confirmEmptyStudents()" class="confirm-button">Konfirmasi Hapus Semua</button>
      <button onclick="closeEmptyStudentsModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="logoutConfirmModal" class="modal">
    <div class="modal-content">
      <h4>Konfirmasi Logout</h4>
      <p>Anda yakin ingin keluar dari panel admin?</p>
      <button onclick="confirmLogout()" class="confirm-button">Ya, Keluar</button>
      <button onclick="closeLogoutModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="resetStudentModal" class="modal">
    <div class="modal-content">
      <h4>Reset Status Login Siswa</h4>
      <p>Anda yakin ingin mereset status login siswa <b id="resetStudentNameDisplay"></b> (ID: <b id="resetStudentIdDisplay"></b>)?</p>
      <p style="font-size: 0.9em; color: #555;">Ini akan memaksa siswa untuk login ulang jika mereka sedang dalam sesi.</p>
      <button onclick="confirmResetStudent()" class="confirm-button">Reset</button>
      <button onclick="closeResetStudentModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="submitAnswerModal" class="modal">
    <div class="modal-content">
      <h4>Kirim Jawaban Siswa (Manual)</h4>
      <p>Anda yakin ingin menandai semua ujian yang sedang dikerjakan siswa <b id="submitStudentNameDisplay"></b> (ID: <b id="submitStudentIdDisplay"></b>) sebagai 'Sudah submit'?</p>
      <p style="font-size: 0.9em; color: #555;">Tindakan ini akan mengunci jawaban siswa untuk ujian yang relevan.</p>
      <button onclick="confirmSubmitAnswer()" class="confirm-button">Kirim Jawaban</button>
      <button onclick="closeSubmitAnswerModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="deleteAnswerModal" class="modal">
    <div class="modal-content">
      <h4>Hapus Semua Jawaban Siswa</h4>
      <p>Anda yakin ingin menghapus <b>SEMUA</b> jawaban dan status submit untuk siswa <b id="deleteAnswerStudentNameDisplay"></b> (ID: <b id="deleteAnswerStudentIdDisplay"></b>)?</p>
      <p style="font-size: 0.9em; color: #e74c3c; font-weight: bold;">Tindakan ini tidak dapat dibatalkan!</p>
      <div>
        <label for="deleteAnswerPassword">Password Admin:</label>
        <input type="password" id="deleteAnswerPassword">
        <p id="deleteAnswerPasswordError" class="error"></p>
      </div>
      <button onclick="confirmDeleteAnswer()" class="confirm-button">Hapus Jawaban</button>
      <button onclick="closeDeleteAnswerModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>


  <script type="module">
    // Import fungsi yang dibutuhkan dari SDK yang dibutuhkan
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    // --- Konfigurasi Firebase untuk setiap kelas (Diperbarui untuk hanya Kelas 7) ---
    const allFirebaseConfigs = {
        '7ABC': {
            apiKey: "AIzaSyBJBl_HWsOsnBBI1EPs1yQlJd0Hso8HcSo",
            authDomain: "ujianpdf-7abc.firebaseapp.com",
            projectId: "ujianpdf-7abc",
            storageBucket: "ujianpdf-7abc.firebasestorage.app",
            messagingSenderId: "1035978389542",
            appId: "1:1035978389542:web:413eb32b04c0d09bc48ee7"
        },
        '7DEF': {
            apiKey: "AIzaSyDQKdbwaG0Tg7_tfHs0hCbNR3xlqT3vWLA",
            authDomain: "ujianpdf-7def.firebaseapp.com",
            projectId: "ujianpdf-7def",
            storageBucket: "ujianpdf-7def.firebasestorage.app",
            messagingSenderId: "210211262444",
            appId: "1:210211262444:web:a06a988913ede65369bac9"
        }
    };

    // Global map to store initialized Firebase app and database instances
    const dbInstances = {};

    // Initialize all Firebase apps and get database instances
    for (const groupKey in allFirebaseConfigs) {
        if (allFirebaseConfigs.hasOwnProperty(groupKey)) {
            const config = allFirebaseConfigs[groupKey];
            // Use groupKey as app name to avoid "already exists" errors
            const appInstance = initializeApp(config, groupKey); 
            dbInstances[groupKey] = getDatabase(appInstance);
        }
    }

    // Pemetaan kelas ke grup database (untuk token) - Hanya untuk Kelas 7
    const gradeToDbGroupMap = {
        '7': ['7ABC', '7DEF']
    };

    // Pemetaan rombel ke database spesifik (untuk siswa) - Hanya untuk Kelas 7
    const rombelToDbMap = {
        '7A': '7ABC', '7B': '7ABC', '7C': '7ABC',
        '7D': '7DEF', '7E': '7DEF', '7F': '7DEF'
    };

    // Kredensial Admin
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "12345678";
    let currentTokenId = null;
    let currentStudentKey = null; // Untuk mengedit/menghapus siswa
    let deleteStudentKey = null; // Untuk konfirmasi penghapusan siswa
    let tokenCache = []; // Cache terpadu untuk semua token dari semua kelas (raw Firebase entries)
    let consolidatedTokensMap = new Map(); // Map untuk token yang dikonsolidasi (untuk tampilan)
    let currentConsolidatedTokenInfo = null; // Menyimpan info token yang dikonsolidasi untuk operasi edit/hapus
    let studentCache = []; // Cache terpadu untuk semua siswa dari semua kelas
    let tokenAccessStatus = {}; // Cache untuk status akses token per siswa (terpadu)
    let submittedExamsCache = {}; // Cache untuk status pengiriman ujian (terpadu)
    let studentAnswersCache = {}; // Cache untuk jawaban siswa (terpadu)
    const THIRTY_DAYS_IN_MS = 30 * 24 * 60 * 60 * 1000; // 30 hari dalam milidetik
    let inactivityTimer;
    const INACTIVITY_TIMEOUT = 60 * 60 * 1000; // Batas waktu tidak aktif 1 jam
    let currentForceActiveTokenId = null;
    let isImporting = false; // Flag untuk mencegah impor ganda
    let currentStudentClassFilter = null; // Filter untuk daftar siswa (misalnya, '7A', '7_all', atau null untuk semua)
    let currentExamStatusFilterToken = null; // Filter untuk status ujian (kunci token)

    // Referensi ke node 'setlokasi' di Firebase (untuk semua database yang aktif)
    const allSetlokasiRefs = Object.values(dbInstances).map(db => ref(db, 'setlokasi'));
    // NEW: Referensi ke node 'lock_settings' di Firebase (untuk semua database yang aktif)
    const allLockSettingsRefs = Object.values(dbInstances).map(db => ref(db, 'lock_settings'));


    // Variabel untuk menyimpan status lokasi dan radius
    let isLocationEnabledAdmin = false;
    let allowedRadiusMeterAdmin = 75; // Default dalam meter
    // Koordinat default untuk akses lokasi (misalnya, titik pusat di Yogyakarta)
    const defaultLocationCoordinate = "-7.8589546,110.2655596"; // Koordinat diperbarui

    // NEW: Variabel untuk menyimpan status kunci dan batas toleransi
    let isLockEnabledAdmin = false;
    let currentLockKeyAdmin = "KUNCI"; // Default key
    let toleranceLimitAdmin = 3; // Default tolerance limit

    // Elemen HTML
    const locationSettingsTableBody = document.getElementById('locationSettingsTableBody');
    const setlokasiModalElement = document.getElementById('setlokasiModal');
    const gantiRadiusModalElement = document.getElementById('gantiRadiusModal');
    const radiusMeterInputElement = document.getElementById('radiusMeter');

    // NEW: Elemen HTML untuk Pengaturan Kunci
    const lockSettingsTableBody = document.getElementById('lockSettingsTableBody');
    const setLockModalElement = document.getElementById('setLockModal');
    const gantiKunciBatasModalElement = document.getElementById('gantiKunciBatasModal');
    const lockKeyInput = document.getElementById('lockKeyInput');
    const toleranceLimitInput = document.getElementById('toleranceLimitInput');
    const lockSettingsError = document.getElementById('lockSettingsError');


    // Elemen HTML untuk Manajemen Siswa
    const studentForm = document.getElementById('studentForm');
    const studentIdInput = document.getElementById('studentId');
    const studentNameInput = document.getElementById('studentName');
    const studentClassInput = document.getElementById('studentClass');
    const studentRoomInput = document.getElementById('studentRoom');
    const addStudentButton = document.getElementById('addStudentButton');
    const updateStudentButton = document.getElementById('updateStudentButton');
    const studentErrorMsg = document.getElementById('studentErrorMsg');
    const studentTableBody = document.getElementById('studentTableBody');
    const accessDetailModal = document.getElementById('accessDetailModal');
    const accessDetailTableBody = document.getElementById('accessDetailTableBody');
    const accessDetailTokenTitle = document.getElementById('accessDetailTokenTitle');
    const examStatusFilterDropdown = document.getElementById('examStatusFilter');
    const classFilterDropdownSelect = document.getElementById('classFilterDropdownSelect');

    // Elemen HTML untuk Modal Edit Siswa
    const editStudentModal = document.getElementById('editStudentModal');
    const modalStudentIdInput = document.getElementById('modalStudentId');
    const modalStudentNameInput = document.getElementById('modalStudentName');
    const modalStudentClassInput = document.getElementById('modalStudentClass');
    const modalStudentRoomInput = document.getElementById('modalStudentRoom');
    const editStudentErrorMsg = document.getElementById('editStudentErrorMsg');

    // Elemen HTML untuk Modal Konfirmasi Penghapusan Siswa
    const deleteStudentConfirmModal = document.getElementById('deleteStudentConfirmModal');
    const emptyStudentsModal = document.getElementById('emptyStudentsModal');
    const emptyStudentsPasswordInput = document.getElementById('emptyStudentsPassword');
    const emptyStudentsPasswordError = document.getElementById('emptyStudentsPasswordError');

    // Elemen HTML untuk Modal Impor Siswa
    const importStudentModal = document.getElementById('importStudentModal');
    const csvFileInput = document.getElementById('csvFileInput');
    const importFileError = document.getElementById('importFileError');
    const importResultModal = document.getElementById('importResultModal');
    const importResultSummary = document.getElementById('importResultSummary');
    const importResultDetails = document.getElementById('importResultDetails');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Elemen HTML untuk Modal Logout
    const logoutConfirmModal = document.getElementById('logoutConfirmModal');

    // Elemen HTML untuk Modal Info Cetak Kartu
    const printInfoModal = document.getElementById('printInfoModal');

    // Tombol navigasi dan elemen header
    const sidebar = document.getElementById('sidebar');
    const loginSection = document.getElementById('loginSection');
    const dashboardContent = document.getElementById('dashboardContent');
    const tokenMenuBtn = document.getElementById('tokenMenuBtn');
    const rulesMenuBtn = document.getElementById('aturanMenuBtn'); // Renamed from lokasiMenuBtn
    const pesertaMenuBtn = document.getElementById('pesertaMenuBtn');
    const scoreMenuBtn = document.getElementById('scoreMenuBtn'); // NEW: Score menu button
    
    // Variabel global untuk melacak status sidebar
    let isSidebarExpanded = false; // Status awal


    // BARU: Elemen input URL Google Drive dan Kunci Jawaban
    const googleDriveUrlInput = document.getElementById('googleDriveUrl');
    const googleDriveUrlError = document.getElementById('googleDriveUrlError');
    const answerKeyInput = document.getElementById('answerKey'); // Re-added
    const answerKeyCountInput = document.getElementById('answerKeyCount'); // NEW: Count input
    const answerKeyError = document.getElementById('answerKeyError'); // Re-added


    // BARU: Elemen input URL Google Drive dan Kunci Jawaban di modal edit
    const editGoogleDriveUrlInput = document.getElementById('editGoogleDriveUrl');
    const editGoogleDriveUrlError = document.getElementById('editGoogleDriveUrlError');
    const editAnswerKeyInput = document.getElementById('editAnswerKey'); // Re-added
    const editAnswerKeyCountInput = document.getElementById('editAnswerKeyCount'); // NEW: Count input
    const editAnswerKeyError = document.getElementById('editAnswerKeyError'); // Re-added

    // Elemen HTML untuk Bagian Nilai Ujian
    const scoreTableHeader = document.getElementById('scoreTableHeader');
    const scoreTableBody = document.getElementById('scoreTableBody');
    const scoreSearchNameInput = document.getElementById('scoreSearchName');
    const scoreSearchClassInput = document.getElementById('scoreSearchClass');
    
    // Elemen HTML untuk Modal Cetak/Salin Generik
    const copyPrintModal = document.getElementById('copyPrintModal');
    const copyPrintModalTitle = document.getElementById('copyPrintModalTitle');
    let currentTableIdToCopy = ''; // Variabel untuk menyimpan ID tabel yang akan disalin


    let currentScoreGradeFilter = null; // Filter untuk nilai ujian (7, 8, 9, atau null untuk semua)

    // Variabel global untuk fitur reset/submit/hapus jawaban siswa
    let studentKeyForAction = null;
    let studentIdForAction = null;
    let studentNameForAction = null;
    let studentClassForAction = null; // Ini akan menjadi rombel (misal: 7A)

    // Elemen modal untuk fitur baru
    const resetStudentModal = document.getElementById('resetStudentModal');
    const resetStudentNameDisplay = document.getElementById('resetStudentNameDisplay');
    const resetStudentIdDisplay = document.getElementById('resetStudentIdDisplay');

    const submitAnswerModal = document.getElementById('submitAnswerModal');
    const submitStudentNameDisplay = document.getElementById('submitStudentNameDisplay');
    const submitStudentIdDisplay = document.getElementById('submitStudentIdDisplay');

    const deleteAnswerModal = document.getElementById('deleteAnswerModal');
    const deleteAnswerStudentNameDisplay = document.getElementById('deleteAnswerStudentNameDisplay');
    const deleteAnswerStudentIdDisplay = document.getElementById('deleteAnswerStudentIdDisplay');
    const deleteAnswerPasswordInput = document.getElementById('deleteAnswerPassword');
    const deleteAnswerPasswordError = document.getElementById('deleteAnswerPasswordError');

    // Daftar rombel yang valid (Diperbarui untuk hanya Kelas 7)
    const VALID_ROMBELS = [
        '7A', '7B', '7C', '7D', '7E', '7F'
    ];

    // Fungsi pembantu untuk mengisi ID siswa dengan nol di depan
    function padStudentId(id) {
        return String(id).padStart(3, '0');
    }

    // Fungsi pembantu untuk mengisi nomor ruangan dengan nol di depan (2 digit)
    function padRoomNumber(room) {
        if (!room) return '-'; // Tangani ruangan kosong atau null
        // Coba konversi ke angka dan isi, jika tidak, kembalikan apa adanya
        const numRoom = parseInt(room, 10);
        if (!isNaN(numRoom)) {
            return String(numRoom).padStart(2, '0');
        }
        return String(room).toUpperCase(); // Kembalikan apa adanya jika bukan angka, pastikan huruf besar
    }

    /**
     * Fungsi pembantu untuk memformat objek Date menjadi string datetime lokal (YYYY-MM-DDTHH:mm).
     * Ini digunakan untuk menyimpan nilai input datetime-local secara konsisten tanpa masalah zona waktu.
     * @param {Date} date - Objek Date yang akan diformat.
     * @returns {string} String datetime lokal yang diformat.
     */
    function formatLocalDateTime(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    /**
     * Fungsi pembantu untuk mendapatkan kelas numerik dari string kelas (misalnya, "7A" -> "7").
     * @param {string} classString - String kelas (misalnya, "7A", "8", "9C").
     * @returns {string|null} Kelas numerik sebagai string (misalnya, "7", "8", "9") atau null jika tidak ditemukan.
     */
    function getNumericClass(classString) {
        const match = String(classString || '').match(/^(\d+)/);
        return match ? match[1] : null;
    }

    /**
     * Fungsi pembantu untuk mendapatkan instance database berdasarkan kelas atau rombel.
     * @param {string} classIdentifier - Nomor kelas (misalnya, '7') atau rombel (misalnya, '7A', '7F').
     * @returns {object|object[]|null} Instance database Firebase, array instance database, atau null jika tidak ditemukan.
     */
    function getDbForClass(classIdentifier) {
        const numericClass = getNumericClass(classIdentifier);

        // Jika identifier adalah rombel spesifik (e.g., '7A')
        if (rombelToDbMap[classIdentifier]) {
            const dbName = rombelToDbMap[classIdentifier];
            return dbInstances[dbName]; // Mengembalikan satu instance DB
        }
        // Jika identifier adalah angkatan numerik (e.g., '7')
        else if (gradeToDbGroupMap[numericClass]) {
            return gradeToDbGroupMap[numericClass].map(dbName => dbInstances[dbName]); // Mengembalikan array instance DB
        }
        console.error(`Instance database tidak ditemukan untuk identifier: ${classIdentifier}`);
        return null; // Identifier tidak valid
    }

    /**
     * Fungsi pembantu untuk meng-escape string agar aman digunakan dalam atribut HTML
     * yang berisi JavaScript string literal yang diapit oleh TANDA KUTIP TUNGGAL.
     * Ini mengganti tanda kutip tunggal dengan entitas HTML-nya.
     * @param {string} s - String yang akan di-escape.
     * @returns {string} String yang sudah di-escape.
     */
    function escapeHtmlAttributeForJsString(s) {
        return String(s)
            .replace(/&/g, '&amp;')   // Escape ampersands first
            .replace(/'/g, '&#39;')   // Escape single quotes
            .replace(/"/g, '&quot;')  // Escape double quotes
            .replace(/</g, '&lt;')    // Escape less than
            .replace(/>/g, '&gt;')   // Escape greater than
    }

    // Fungsi untuk memperluas sidebar
    window.expandSidebar = () => {
        sidebar.classList.add('expanded');
        isSidebarExpanded = true;
    };

    // Fungsi untuk menyembunyikan sidebar
    window.collapseSidebar = () => {
        sidebar.classList.remove('expanded');
        isSidebarExpanded = false;
    };

    // Fungsi untuk menampilkan/menyembunyikan bagian dashboard
    window.showSection = (sectionId) => {
        // Sembunyikan semua bagian konten dashboard
        document.querySelectorAll('.dashboard-section').forEach(section => {
            section.style.display = 'none';
        });
        // Tampilkan bagian yang dipilih
        document.getElementById(sectionId).style.display = 'block';

        // Atur gaya tombol navigasi
        document.querySelectorAll('.sidebar-nav button').forEach(button => {
            button.classList.remove('active');
        });
        // Tambahkan kelas aktif ke tombol yang sesuai
        const activeBtn = document.querySelector(`.sidebar-nav button[data-section-id="${sectionId}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }

        if (sectionId === 'tokenSection') {
            renderTokenTable();
        } else if (sectionId === 'rulesSection') { // Updated sectionId
            updateSetlokasiStatusDisplay();
            renderLockSettingsTable(); // NEW: Render lock settings table
        } else if (sectionId === 'studentSection') {
            populateClassFilter();
            populateExamStatusFilter();
            renderStudentTable();
        } else if (sectionId === 'scoreSection') { // NEW: Handle score section
            renderScoreTable();
        }
    };

    // Handler utama untuk klik menu sidebar
    window.handleMenuClick = (buttonElement) => {
        const sectionId = buttonElement.dataset.sectionId;
        const action = buttonElement.dataset.action; // Untuk logout

        if (!isSidebarExpanded) {
            // Jika sidebar disembunyikan, perluas dan kemudian lakukan tindakan
            expandSidebar();
            // Gunakan sedikit penundaan untuk memungkinkan transisi CSS dimulai sebelum konten berubah
            setTimeout(() => {
                if (action === 'promptLogout') {
                    promptLogout();
                } else {
                    showSection(sectionId);
                }
            }, 100); // Sesuaikan penundaan sesuai kebutuhan untuk UX yang lebih halus
        } else {
            // Jika sidebar sudah diperluas
            if (action === 'promptLogout') {
                promptLogout();
                // Sidebar tetap diperluas untuk modal logout, akan menyembunyikan pada confirmLogout
            } else {
                const currentActiveSection = document.querySelector('.dashboard-section[style*="display: block"]');
                const currentActiveSectionId = currentActiveSection ? currentActiveSection.id : null;

                if (sectionId === currentActiveSectionId) {
                    // Mengklik bagian yang sedang aktif, tidak melakukan apa-apa (sidebar tetap diperluas)
                    console.log('Sudah di bagian ini, tidak melakukan apa-apa.');
                } else {
                    // Mengklik bagian yang berbeda, ubah konten tetapi biarkan sidebar diperluas
                    showSection(sectionId);
                }
            }
        }
    };

    // Listener klik global untuk menyembunyikan sidebar saat mengklik di luar
    document.addEventListener('click', (event) => {
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickInsideModal = event.target.closest('.modal'); // Periksa apakah klik berada di dalam modal apa pun

        if (isSidebarExpanded && !isClickInsideSidebar && !isClickInsideModal) {
            collapseSidebar();
        }
    });


    // Fungsi untuk menampilkan notifikasi
    function showNotification(message) {
      const n = document.getElementById('notification');
      n.innerText = message;
      n.style.display = 'block';
      setTimeout(() => {
        n.style.display = 'none';
      }, 3000);
    }

    // Fungsi untuk menangani login pengguna
    window.login = () => {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      if(u === ADMIN_USER && p === ADMIN_PASS) {
        localStorage.setItem('isAdminLoggedIn', 'true');
        loginSection.style.display = 'none'; // Sembunyikan bagian login
        sidebar.style.display = 'flex'; // Tampilkan sidebar
        dashboardContent.style.display = 'flex'; // Tampilkan konten dashboard
        
        // Memuat data dengan listener real-time
        loadTokens(); 
        loadStudents(); 
        loadTokenAccessStatus(); 
        loadSubmittedExamsStatus(); 
        loadSetlokasiSettings(); 
        loadStudentAnswers(); // NEW: Load student answers
        loadLockSettings(); // NEW: Load lock settings

        showSection('tokenSection'); // Tampilkan bagian token secara default
        resetInactivityTimer(); // Mulai timer tidak aktif setelah login berhasil
        collapseSidebar(); // Pastikan sidebar disembunyikan setelah login
      } else {
        document.getElementById("loginError").innerText = "Username atau password salah.";
      }
    };

    // Fungsi untuk menampilkan modal konfirmasi logout
    window.promptLogout = () => {
        logoutConfirmModal.style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi logout
    window.confirmLogout = () => {
      localStorage.removeItem('isAdminLoggedIn');
      dashboardContent.style.display = 'none'; // Sembunyikan konten dashboard
      sidebar.style.display = 'none'; // Sembunyikan sidebar
      loginSection.style.display = 'block'; // Tampilkan bagian login
      document.getElementById('password').value = ''; // Hapus kata sandi saat logout
      showNotification('Anda telah logout.');
      closeLogoutModal();
      collapseSidebar(); // Pastikan sidebar disembunyikan setelah logout
    };

    // Fungsi untuk menutup modal konfirmasi logout
    window.closeLogoutModal = () => {
        logoutConfirmModal.style.display = 'none';
    };

    // Fungsi untuk merender/memperbarui tabel token
    function renderTokenTable() {
        const tbody = document.getElementById('tokenTableBody');
        tbody.innerHTML = ''; // Hapus baris yang ada

        consolidatedTokensMap.clear(); // Clear the map before repopulating

        // Populate the consolidated map from tokenCache (raw Firebase entries)
        tokenCache.forEach(tokenData => {
            const consolidatedKey = `${tokenData.token}_${tokenData.kelas}`; // Unique key for consolidated token
            if (!consolidatedTokensMap.has(consolidatedKey)) {
                consolidatedTokensMap.set(consolidatedKey, {
                    subject: tokenData.subject,
                    kelas: tokenData.kelas,
                    token: tokenData.token,
                    googleDriveUrl: tokenData.googleDriveUrl,
                    originalGoogleDriveUrl: tokenData.originalGoogleDriveUrl,
                    answerKey: tokenData.answerKey,
                    startTime: tokenData.startTime,
                    endTime: tokenData.endTime,
                    durationMinutes: tokenData.durationMinutes,
                    createdAt: tokenData.createdAt,
                    isActive: tokenData.isActive,
                    isForceActive: tokenData.isForceActive,
                    firebaseKeys: new Set([tokenData.key]), // Store all Firebase keys for this consolidated token
                    firebaseGroups: new Set([tokenData.firebaseGroup]) // Store all Firebase groups for this consolidated token
                });
            } else {
                const existing = consolidatedTokensMap.get(consolidatedKey);
                existing.firebaseKeys.add(tokenData.key);
                existing.firebaseGroups.add(tokenData.firebaseGroup);
                // If any of the underlying tokens are force active, the consolidated one is force active
                existing.isForceActive = existing.isForceActive || tokenData.isForceActive;
                // If any of the underlying tokens are active, the consolidated one is active (unless force active overrides)
                existing.isActive = existing.isActive || tokenData.isActive;
            }
        });

        // Convert map values to array for sorting and rendering
        const consolidatedTokens = Array.from(consolidatedTokensMap.values()).sort((a, b) => {
            const timeA = new Date(a.startTime).getTime();
            const timeB = new Date(b.startTime).getTime();
            if (timeA !== timeB) {
                return timeA - timeB;
            }
            const kelasA = String(a.kelas || '');
            const kelasB = String(b.kelas || '');
            const numKelasA = parseInt(kelasA);
            const numKelasB = parseInt(kelasB);
            if (!isNaN(numKelasA) && !isNaN(numKelasB)) {
                return numKelasA - numKelasB;
            } else {
                return kelasA.localeCompare(kelasB);
            }
        });

        let sortedCounter = 0;
        consolidatedTokens.forEach(data => {
            sortedCounter++;
            const row = document.createElement('tr');
            
            const startTimeFormatted = data.startTime ? new Date(data.startTime).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
            const endTimeFormatted = data.endTime ? new Date(data.endTime).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
            
            let tokenDisplay = data.token;
            if (data.isForceActive) {
                tokenDisplay = `<strong style="color: #0066cc;">${data.token}</strong>`;
            } else if (data.isActive) {
                tokenDisplay = `<strong style="color: green;">${data.token}</strong>`;
            }
            
            let forceActiveIconsHTML = '';
            // For force active/inactive, we can use any of the firebaseKeys, as the action will iterate through all
            const representativeKey = Array.from(data.firebaseKeys)[0]; // Just pick the first one for the onclick parameter

            if (data.isForceActive) {
                forceActiveIconsHTML = `<button class="icon-button" onclick="promptForceInactive('${escapeHtmlAttributeForJsString(representativeKey)}')" title="Nonaktifkan Paksa"><i class="fas fa-lock"></i></button>`;
            } else {
                if (data.isActive) {
                    forceActiveIconsHTML = `<button class="icon-button" onclick="promptForceInactive('${escapeHtmlAttributeForJsString(representativeKey)}')" title="Nonaktifkan Paksa"><i class="fas fa-lock-open"></i></button>`;
                } else {
                    forceActiveIconsHTML = `<button class="icon-button" onclick="promptForceActive('${escapeHtmlAttributeForJsString(representativeKey)}')" title="Aktifkan Paksa"><i class="fas fa-unlock"></i></button>`;
                }
            }

            // Calculate aggregated accessed and submitted students across all firebaseKeys
            let totalAccessedStudents = 0;
            const accessedUniqueStudentIds = new Set();
            const submittedUniqueStudentIds = new Set();

            data.firebaseKeys.forEach(fbKey => {
                if (tokenAccessStatus[fbKey]) {
                    Object.keys(tokenAccessStatus[fbKey]).forEach(studentId => {
                        accessedUniqueStudentIds.add(studentId);
                    });
                }
                if (submittedExamsCache[fbKey]) {
                    Object.keys(submittedExamsCache[fbKey]).forEach(studentId => {
                        if (submittedExamsCache[fbKey][studentId] && submittedExamsCache[fbKey][studentId].isSubmitted === true) {
                            submittedUniqueStudentIds.add(studentId);
                        }
                    });
                }
            });
            totalAccessedStudents = accessedUniqueStudentIds.size;
            const totalSubmittedStudents = submittedUniqueStudentIds.size;


            const displayAnswerKey = data.answerKey ? data.answerKey.substring(0, 10) + (data.answerKey.length > 10 ? '...' : '') : '-';

            row.innerHTML = `
                <td>${sortedCounter}</td>
                <td>${escapeHtmlAttributeForJsString(data.subject)}</td>
                <td>${escapeHtmlAttributeForJsString(data.kelas)}</td>
                <td><a href="#" onclick="openAccessDetailModal('${escapeHtmlAttributeForJsString(representativeKey)}', '${escapeHtmlAttributeForJsString(data.token)}')">${tokenDisplay}</a></td>
                <td>${data.googleDriveUrl ? `<a href="${escapeHtmlAttributeForJsString(data.googleDriveUrl)}" target="_blank">Lihat PDF</a>` : '-'}</td>
                <td>${displayAnswerKey}</td> <td>${startTimeFormatted}</td>
                <td>${endTimeFormatted}</td>
                <td>${data.durationMinutes !== undefined ? data.durationMinutes : '-'}</td>
                <td style="text-align: center;">
                  <span style="color: ${data.isActive ? 'green' : 'grey'}; font-weight: bold;">${data.isActive ? 'ON' : 'OFF'}</span>
                  ${forceActiveIconsHTML}
                </td>
                <td style="text-align: center;">${totalAccessedStudents}</td>
                <td style="text-align: center;">${totalSubmittedStudents}</td> <td style="text-align: center;">
                  <div class="student-action-buttons">
                    <button class="icon-button edit" onclick="editTokenConsolidated('${escapeHtmlAttributeForJsString(data.token)}', '${escapeHtmlAttributeForJsString(data.kelas)}')" title="Edit Token">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-button delete" onclick="promptDeleteConsolidated('${escapeHtmlAttributeForJsString(data.token)}', '${escapeHtmlAttributeForJsString(data.kelas)}')" title="Hapus Token">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        populateExamStatusFilter(); // Pastikan filter status ujian diperbarui saat token berubah
    }

    // Fungsi untuk memuat token dari semua proyek Firebase (dengan real-time listener)
    function loadTokens() {
        tokenCache = []; // Reset cache awal
        Object.keys(gradeToDbGroupMap).forEach(gradeNum => { // Iterasi per angkatan
            const dbNames = gradeToDbGroupMap[gradeNum];
            dbNames.forEach(dbName => { // Untuk setiap DB dalam grup angkatan
                const dbInstance = dbInstances[dbName];
                if (dbInstance) {
                    onValue(ref(dbInstance, 'tokens'), (snapshot) => {
                        console.log(`[Real-time Update] Tokens for Firebase group ${dbName} (grade ${gradeNum}) updated.`);
                        const groupTokens = [];
                        snapshot.forEach(child => {
                            const data = child.val();
                            data.key = child.key;
                            data.firebaseGrade = gradeNum; // Simpan angkatan dari proyek Firebase mana asalnya
                            data.firebaseGroup = dbName; // Simpan grup DB spesifik (e.g., '7ABC')
                            // Hapus token yang lebih lama dari 30 hari
                            if (data.createdAt && (Date.now() - data.createdAt) > THIRTY_DAYS_IN_MS) {
                                remove(ref(dbInstance, 'tokens/' + data.key))
                                    .then(() => console.log(`Token ${data.key} dari grup ${dbName} dihapus otomatis.`))
                                    .catch(error => console.error(`Gagal hapus otomatis ${data.key} dari grup ${dbName}: `, error));
                                return;
                            }
                            groupTokens.push(data);
                        });

                        // Perbarui tokenCache global dengan data terbaru dari grup ini
                        tokenCache = tokenCache.filter(t => t.firebaseGroup !== dbName);
                        tokenCache.push(...groupTokens);
                        
                        renderTokenTable(); // Render ulang tabel setiap kali data token berubah
                        periksaAndUpdateStatusToken(); // Periksa status token juga
                    }, (error) => {
                        console.error(`Error memuat token dari grup ${dbName}:`, error);
                    });
                }
            });
        });
    }

    // Listener untuk status akses token per siswa (terpadu dari semua DB)
    function loadTokenAccessStatus() {
        tokenAccessStatus = {}; // Bersihkan cache sebelum memuat
        Object.keys(dbInstances).forEach(dbName => { // Iterasi semua DB yang aktif
            const dbInstance = dbInstances[dbName];
            if (dbInstance) {
                onValue(ref(dbInstance, 'exam_access_status'), (snapshot) => {
                    console.log(`[Real-time Update] Exam access status for Firebase group ${dbName} updated.`);
                    const groupAccessData = snapshot.val() || {};
                    // Gabungkan ke tokenAccessStatus global
                    // Penting: Pastikan tidak ada duplikasi kunci token jika token yang sama ada di beberapa DB
                    // Dalam skenario ini, token untuk angkatan yang sama harus memiliki key yang sama di kedua DB
                    // Jadi, cukup gabungkan. Jika ada konflik, yang terakhir akan menimpa (yang seharusnya OK jika data konsisten)
                    Object.assign(tokenAccessStatus, groupAccessData);
                    renderTokenTable(); // Render ulang tabel token untuk memperbarui jumlah akses
                    renderStudentTable(); // Juga perbarui tabel siswa untuk status akses
                    renderScoreTable(); // Perbarui tabel nilai juga
                }, (error) => {
                    console.error(`Error memuat exam_access_status dari grup ${dbName}:`, error);
                });
            }
        });
    }

    // Listener untuk status pengiriman ujian per siswa (terpadu dari semua DB)
    function loadSubmittedExamsStatus() {
        submittedExamsCache = {}; // Bersihkan cache sebelum memuat
        Object.keys(dbInstances).forEach(dbName => { // Iterasi semua DB yang aktif
            const dbInstance = dbInstances[dbName];
            if (dbInstance) {
                onValue(ref(dbInstance, 'submitted_exams'), (snapshot) => {
                    console.log(`[Real-time Update] Submitted exams for Firebase group ${dbName} updated.`);
                    const groupSubmissionData = snapshot.val() || {};
                    // Gabungkan ke submittedExamsCache global
                    Object.assign(submittedExamsCache, groupSubmissionData);
                    renderStudentTable(); // Render ulang tabel siswa
                    renderScoreTable(); // Perbarui tabel nilai juga
                }, (error) => {
                    console.error(`Error memuat submitted_exams dari grup ${dbName}:`, error);
                });
            }
        });
    }

    // NEW: Listener untuk jawaban siswa (terpadu dari semua DB)
    function loadStudentAnswers() {
        studentAnswersCache = {}; // Bersihkan cache sebelum memuat
        Object.keys(dbInstances).forEach(dbName => { // Iterasi semua DB yang aktif
            const dbInstance = dbInstances[dbName];
            if (dbInstance) {
                onValue(ref(dbInstance, 'student_answers'), (snapshot) => {
                    console.log(`[Real-time Update] Student answers for Firebase group ${dbName} updated.`);
                    const groupAnswersData = snapshot.val() || {};
                    // Gabungkan ke studentAnswersCache global
                    Object.assign(studentAnswersCache, groupAnswersData);
                    renderScoreTable(); // Perbarui tabel nilai
                }, (error) => {
                    console.error(`Error memuat student_answers dari grup ${dbName}:`, error);
                });
            }
        });
    }


    /**
     * Fungsi untuk memvalidasi format kunci jawaban.
     * @param {string} key - String kunci jawaban.
     * @returns {boolean} True jika format valid, false jika tidak.
     */
    function validateAnswerKey(key) {
        if (!key) return true; // Izinkan string kosong (tidak ada kunci jawaban)
        // Regex: ^[A-D]$ or ^[A-D](,[A-D])*$
        const regex = /^[A-D](,[A-D])*$/;
        return regex.test(key);
    }

    /**
     * Fungsi untuk menghitung waktu mulai yang disesuaikan berdasarkan kelas.
     * @param {string} kelas - Kelas token (misalnya, "7").
     * @param {Date} originalStartTime - Objek Date dari waktu mulai asli.
     * @returns {Date} Waktu mulai yang disesuaikan.
     */
    function calculateAdjustedStartTime(kelas, originalStartTime) {
        let delaySeconds = 0;
        // Pastikan kelas adalah string dan ambil hanya digit pertama jika tersedia
        const kelasNumeric = String(kelas).trim().charAt(0);

        switch (kelasNumeric) {
            case '7':
                delaySeconds = 30; // Kelas 7 ditunda 30 detik
                break;
            // Removed cases for '8' and '9' as per new requirements
            default:
                delaySeconds = 0; // Default tidak ada penundaan jika kelas tidak dikenali
                console.warn(`Kelas '${kelas}' tidak dikenali untuk penyesuaian waktu. Menggunakan 0 detik penundaan.`);
        }
        
        const adjustedTime = new Date(originalStartTime.getTime() + delaySeconds * 1000);
        return adjustedTime;
    }

    /**
     * Fungsi untuk mengonversi URL Google Drive dari view menjadi preview.
     * @param {string} url - URL Google Drive.
     * @returns {string} URL yang sudah dikonversi ke format preview.
     */
    function convertToPreviewLink(url) {
        if (!url || typeof url !== 'string') {
            return url;
        }
        // Ganti '/view?usp=sharing' atau '/view' dengan '/preview'
        // Ini menangani kasus umum dan juga link yang mungkin hanya '/view'
        let convertedUrl = url.replace(/\/view(\?usp=sharing)?$/, '/preview');
        return convertedUrl;
    }


    // Fungsi untuk mencatat akses tautan dan membukanya (DEMO untuk panel admin)
    window.trackAndOpenLinkDemo = async (tokenId, googleDriveUrl) => { // Mengubah pdfUrl menjadi googleDriveUrl
        const studentIdDemo = prompt("Masukkan ID Siswa untuk simulasi akses (misal: 001, 002):");
        if (!studentIdDemo) {
            showNotification("Akses dibatalkan. ID Siswa diperlukan untuk simulasi.");
            return;
        }

        const student = studentCache.find(s => s.id === padStudentId(studentIdDemo)); // Isi ID input
        if (!student) {
            showNotification(`ID Siswa '${padStudentId(studentIdDemo)}' tidak ditemukan. Harap tambahkan siswa terlebih dahulu.`);
            return;
        }

        const token = tokenCache.find(t => t.key === tokenId);
        if (!token) {
            showNotification("Token tidak ditemukan."); // Seharusnya tidak terjadi jika tokenId valid
            return;
        }

        // Ekstrak bagian numerik dari kelas siswa (misalnya, '7' dari '7A')
        const studentClassNumeric = getNumericClass(student.class);
        const tokenClassNumeric = getNumericClass(token.kelas);

        // Bandingkan bagian numerik dari kelas siswa dengan kelas token umum
        if (!studentClassNumeric || studentClassNumeric !== tokenClassNumeric) { // Bandingkan kelas numerik
            showNotification(`Akses ditolak: Siswa dari kelas ${student.class} tidak dapat mengakses token untuk kelas ${token.kelas}.`);
            return;
        }

        // Tentukan database target untuk status akses berdasarkan rombel siswa
        const targetDbForAccess = getDbForClass(student.class); // Gunakan rombel siswa untuk menentukan DB
        if (!targetDbForAccess || Array.isArray(targetDbForAccess)) { // Pastikan ini satu DB, bukan array
            showNotification("Gagal mencatat akses: Database untuk rombel siswa tidak ditemukan atau ambigu.");
            return;
        }

        const tokenAccessRef = ref(targetDbForAccess, `exam_access_status/${tokenId}/${student.id}`); // Gunakan DB rombel siswa

        runTransaction(tokenAccessRef, (currentAccess) => {
            const now = Date.now();
            const SPAM_THRESHOLD_MS = 5000; // 5 detik

            if (currentAccess === null) {
                // Akses pertama oleh siswa ini untuk token ini
                return {
                    firstAccessTime: now,
                    lastAccessTime: now,
                    accessCount: 1,
                    isLoggedIn: true // Set isLoggedIn true on first access
                };
            } else {
                // Akses berikutnya oleh siswa ini untuk token ini
                if (now - (currentAccess.lastAccessTime || 0) > SPAM_THRESHOLD_MS) { // Pastikan lastAccessTime ada
                    // Bukan klik spam, tingkatkan hitungan
                    currentAccess.accessCount = (currentAccess.accessCount || 0) + 1;
                    currentAccess.lastAccessTime = now;
                } else {
                    // Klik spam, hanya perbarui lastAccessTime tetapi jangan tingkatkan hitungan
                    currentAccess.lastAccessTime = now;
                }
                currentAccess.isLoggedIn = true; // Ensure isLoggedIn is true on subsequent access
                return currentAccess;
            }
        })
        .then(() => {
            console.log(`Akses token ${tokenId} oleh siswa ${student.id} berhasil dicatat di DB grup ${targetDbForAccess.app.name}.`);
            showNotification(`Siswa ${student.id} dari kelas ${student.class} berhasil mengakses token ${token.token} (kelas ${token.kelas}).`);
            window.open(googleDriveUrl, '_blank'); // Buka URL Google Drive
        })
        .catch(error => {
            console.error("Gagal mencatat akses token:", error);
            showNotification('Gagal mencatat akses token, namun ujian akan tetap dibuka.');
            window.open(googleDriveUrl, '_blank'); // Tetap buka URL Google Drive meskipun perekaman gagal
        });
    };


    // Event listener untuk pengiriman formulir token
    document.getElementById('tokenForm').addEventListener('submit', async function(e) { // Jadikan async
      e.preventDefault();
      const s = document.getElementById('subject').value.trim().toUpperCase();
      const k = document.getElementById('kelas').value.trim(); // Dapatkan kelas sebagai string (misalnya, "7")
      const t = document.getElementById('token').value.trim().toUpperCase(); // Ini adalah token dasar
      const originalGoogleDriveUrl = googleDriveUrlInput.value.trim(); // Simpan URL asli
      const googleDriveUrlPreview = convertToPreviewLink(originalGoogleDriveUrl); // Konversi ke link preview
      const answerKey = answerKeyInput.value.trim().toUpperCase(); // Re-added
      const startTimeInput = document.getElementById('startTime').value; // Dapatkan string waktu mulai secara langsung
      const endTimeInput = document.getElementById('endTime').value; // Dapatkan string waktu akhir secara langsung
      const em= document.getElementById('errorMsg');
      em.innerText = "";
      googleDriveUrlError.innerText = ""; // Hapus kesalahan URL Google Drive
      answerKeyError.innerText = ""; // Re-added

      // Validasi input kelas token (hanya 7)
      if (!['7'].includes(k)) { // Updated to only allow '7'
          em.innerText = "Kelas harus berupa 7.";
          return;
      }

      // Dapatkan array database target berdasarkan angkatan
      const targetDbs = getDbForClass(k);
      if (!targetDbs || !Array.isArray(targetDbs) || targetDbs.length === 0) {
          em.innerText = "Kelas tidak valid atau konfigurasi Firebase belum lengkap untuk kelas ini.";
          return;
      }

      if (!s || !k || !t || !originalGoogleDriveUrl || !answerKey || !startTimeInput || !endTimeInput) { // answerKey re-added to validation
        em.innerText = "Semua field harus diisi!";
        return;
      }

      const originalStartTime = new Date(startTimeInput); // Parse sebagai waktu lokal
      const originalEndTime = new Date(endTimeInput); // Parse sebagai waktu lokal

      if (originalStartTime >= originalEndTime) {
        em.innerText = "Waktu token dibuka harus sebelum waktu token ditutup!";
        return;
      }

      if (!validateAnswerKey(answerKey)) { // Re-added
          answerKeyError.innerText = "Format kunci jawaban tidak valid. Gunakan A,B,C,D dipisah koma (contoh: A,B,C,D,D).";
          return;
      }

      // Validasi URL dasar untuk tautan Google Drive
      if (!originalGoogleDriveUrl.startsWith('http')) {
          googleDriveUrlError.innerText = "URL Google Drive tidak valid.";
          return;
      }

      // Periksa token dasar duplikat di semua database target untuk angkatan ini
      const isTokenDup = tokenCache.some(item => item.token === t && getNumericClass(item.kelas) === getNumericClass(k));
      if (isTokenDup) {
        em.innerText = "Token (Base Token) sudah ada untuk kelas ini!";
        return;
      }

      loadingOverlay.style.display = 'flex'; // Tampilkan loading

      // Hitung waktu mulai yang disesuaikan
      const adjustedStartTime = calculateAdjustedStartTime(k, originalStartTime);
      // Hitung durasi dalam menit
      const durationMinutes = Math.round((originalEndTime.getTime() - adjustedStartTime.getTime()) / (1000 * 60));

      const data = {
          subject: s,
          kelas: k, // Simpan kelas sesuai yang diberikan (misalnya, "7")
          token: t,
          googleDriveUrl: googleDriveUrlPreview, // Simpan link preview
          originalGoogleDriveUrl: originalGoogleDriveUrl, // Simpan link asli
          answerKey: answerKey, // Re-added
          startTime: formatLocalDateTime(adjustedStartTime), // Simpan waktu yang disesuaikan dalam format lokal
          endTime: endTimeInput, // Simpan waktu akhir apa adanya (format lokal)
          durationMinutes: durationMinutes, // Simpan durasi
          createdAt: Date.now(),
          isActive: false,
          isForceActive: false
      };

      try {
          const pushPromises = targetDbs.map(db => push(ref(db, 'tokens'), data));
          await Promise.all(pushPromises);

          this.reset();
          googleDriveUrlError.innerText = ''; // Hapus kesalahan URL Google Drive
          answerKeyInput.value = ''; // Clear answer key input
          answerKeyCountInput.value = '0'; // Reset count
          answerKeyError.innerText = ''; // Re-added
          showNotification('Token berhasil ditambahkan ke semua database yang relevan! Status akan otomatis aktif sesuai waktu.');
      } catch (err) {
          em.innerText = "Gagal menyimpan token: " + err.message;
          console.error("Error saving token:", err);
      } finally {
          loadingOverlay.style.display = 'none';
      }
    });

    // Fungsi untuk membuka modal edit token
    window.editTokenConsolidated = (baseToken, kelas) => {
      const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === baseToken && t.kelas === kelas);
      if (!consolidatedToken) return;

      currentConsolidatedTokenInfo = consolidatedToken; // Store the consolidated object

      document.getElementById('editSubject').value = consolidatedToken.subject;
      document.getElementById('editKelas').value = consolidatedToken.kelas;
      document.getElementById('editToken').value = consolidatedToken.token;
      editGoogleDriveUrlInput.value = consolidatedToken.originalGoogleDriveUrl || consolidatedToken.googleDriveUrl || '';
      editGoogleDriveUrlError.innerText = ''; // Clear errors

      editAnswerKeyInput.value = consolidatedToken.answerKey || '';
      updateAnswerKeyCount(editAnswerKeyInput, editAnswerKeyCountInput); // Update count for edit modal
      editAnswerKeyError.innerText = ''; // Clear errors

      document.getElementById('editStartTime').value = consolidatedToken.startTime;
      document.getElementById('editEndTime').value = consolidatedToken.endTime;
      document.getElementById('editErrorMsg').innerText = "";
      document.getElementById('editModal').style.display = 'flex';
    };

    // Event listener untuk pengiriman formulir modal (edit token)
    document.getElementById('modalForm').addEventListener('submit', async function(e) { // Jadikan async
      e.preventDefault();
      const s = document.getElementById('editSubject').value.trim().toUpperCase();
      const newKelas = document.getElementById('editKelas').value.trim(); // Kelas baru
      const t = document.getElementById('editToken').value.trim().toUpperCase();
      const originalGoogleDriveUrl = editGoogleDriveUrlInput.value.trim(); // Simpan URL asli dari input edit
      const googleDriveUrlPreview = convertToPreviewLink(originalGoogleDriveUrl); // Konversi ke link preview
      const answerKey = editAnswerKeyInput.value.trim().toUpperCase(); // Re-added
      const startTimeInput = document.getElementById('editStartTime').value;
      const endTimeInput = document.getElementById('editEndTime').value;
      const em = document.getElementById('editErrorMsg');
      em.innerText = "";
      editGoogleDriveUrlError.innerText = "";
      editAnswerKeyError.innerText = ""; // Re-added

      // Validasi input kelas token (hanya 7)
      if (!['7'].includes(newKelas)) { // Updated to only allow '7'
          em.innerText = "Kelas harus berupa 7.";
          return;
      }

      if (!currentConsolidatedTokenInfo) {
          em.innerText = "Error: Informasi token tidak ditemukan untuk pengeditan.";
          return;
      }

      const oldKelas = currentConsolidatedTokenInfo.kelas;
      const oldBaseToken = currentConsolidatedTokenInfo.token;
      const oldFirebaseKeys = Array.from(currentConsolidatedTokenInfo.firebaseKeys);

      if (!s || !newKelas || !t || !originalGoogleDriveUrl || !answerKey || !startTimeInput || !endTimeInput) { // answerKey re-added
        em.innerText = "Semua field harus diisi!";
        return;
      }

      const originalStartTime = new Date(startTimeInput);
      const originalEndTime = new Date(endTimeInput);

      if (originalStartTime >= originalEndTime) {
        em.innerText = "Waktu token dibuka harus sebelum waktu token ditutup!";
        return;
      }

      if (!validateAnswerKey(answerKey)) { // Re-added
          editAnswerKeyError.innerText = "Format kunci jawaban tidak valid. Gunakan A,B,C,D dipisah koma (contoh: A,B,C,D,D).";
          return;
      }

      if (!originalGoogleDriveUrl.startsWith('http')) {
          editGoogleDriveUrlError.innerText = "URL Google Drive tidak valid.";
          return;
      }

      // Periksa token dasar duplikat, kecuali untuk token yang sedang diedit
      const isTokenDup = Array.from(consolidatedTokensMap.values()).some(item => 
          item.token === t && 
          item.kelas === newKelas && // Check against the new class
          !(item.token === oldBaseToken && item.kelas === oldKelas) // Exclude the current consolidated token
      );
      if (isTokenDup) {
        em.innerText = "Token (Base Token) sudah ada untuk kelas ini!";
        return;
      }

      loadingOverlay.style.display = 'flex'; // Tampilkan loading

      const adjustedStartTime = calculateAdjustedStartTime(newKelas, originalStartTime);
      const durationMinutes = Math.round((originalEndTime.getTime() - adjustedStartTime.getTime()) / (1000 * 60));

      const updatedData = {
          subject: s,
          kelas: newKelas,
          token: t,
          googleDriveUrl: googleDriveUrlPreview, // Simpan link preview
          originalGoogleDriveUrl: originalGoogleDriveUrl, // Simpan link asli
          answerKey: answerKey, // Re-added
          startTime: formatLocalDateTime(adjustedStartTime),
          endTime: endTimeInput,
          durationMinutes: durationMinutes,
          createdAt: currentConsolidatedTokenInfo.createdAt // Pertahankan waktu pembuatan asli
      };

      try {
          if (getNumericClass(oldKelas) !== getNumericClass(newKelas) || oldBaseToken !== t) {
              // Kelas atau base token berubah, lakukan operasi "pindah" atau buat token baru
              console.log(`Token ${oldBaseToken} (Kelas ${oldKelas}) dipindahkan/diubah menjadi ${t} (Kelas ${newKelas}).`);

              // 1. Hapus token lama dan data terkait dari semua instance Firebase lama
              const deletePromises = [];
              for (const fbKey of oldFirebaseKeys) {
                  const tokenFromCache = tokenCache.find(tok => tok.key === fbKey);
                  if (tokenFromCache) {
                      const db = dbInstances[tokenFromCache.firebaseGroup];
                      if (db) {
                          deletePromises.push(remove(ref(db, 'tokens/' + fbKey)));
                          deletePromises.push(remove(ref(db, `exam_access_status/${fbKey}`)));
                          deletePromises.push(remove(ref(db, `submitted_exams/${fbKey}`)));
                          deletePromises.push(remove(ref(db, `student_answers/${fbKey}`)));
                      }
                  }
              }
              await Promise.all(deletePromises);
              console.log(`Token lama dan data terkait dihapus dari DB yang relevan.`);

              // 2. Tambahkan token baru ke semua instance Firebase baru yang relevan
              const newTargetDbs = getDbForClass(newKelas);
              const addPromises = newTargetDbs.map(db => push(ref(db, 'tokens'), updatedData));
              await Promise.all(addPromises);
              showNotification(`Token berhasil dipindahkan/diubah ke kelas ${newKelas}! Riwayat akses/pengiriman token lama telah direset.`);
          } else {
              // Kelas dan base token tidak berubah, cukup perbarui di instance Firebase yang ada
              const updatePromises = [];
              for (const fbKey of oldFirebaseKeys) {
                  const tokenFromCache = tokenCache.find(tok => tok.key === fbKey);
                  if (tokenFromCache) {
                      const db = dbInstances[tokenFromCache.firebaseGroup];
                      if (db) {
                          updatePromises.push(update(ref(db, 'tokens/' + fbKey), updatedData));
                      }
                  }
              }
              await Promise.all(updatePromises);
              showNotification('Token berhasil diedit!');
          }
          closeEditModal();
      } catch (err) {
          em.innerText = "Gagal menyimpan perubahan token: " + err.message;
          console.error("Error saving token changes:", err);
      } finally {
          loadingOverlay.style.display = 'none';
          currentConsolidatedTokenInfo = null; // Clear consolidated info
        }
    });

    // Fungsi untuk menutup modal edit token
    window.closeEditModal = () => {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('editErrorMsg').innerText = "";
      editGoogleDriveUrlError.innerText = ""; // Hapus kesalahan URL Google Drive
      editAnswerKeyError.innerText = ""; // Re-added
      currentConsolidatedTokenInfo = null; // Reset consolidated info
    };

    let deleteId = null;
    // Fungsi untuk menampilkan konfirmasi penghapusan token
    window.promptDeleteConsolidated = (baseToken, kelas) => {
      const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.token === baseToken && t.kelas === kelas);
      if (!consolidatedToken) return;
      currentConsolidatedTokenInfo = consolidatedToken; // Store for deletion
      document.getElementById('deleteModal').style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi penghapusan token
    window.confirmDelete = async () => { // Jadikan async
      if (currentConsolidatedTokenInfo) {
        loadingOverlay.style.display = 'flex'; // Tampilkan loading
        try {
            const deletePromises = [];
            for (const fbKey of Array.from(currentConsolidatedTokenInfo.firebaseKeys)) {
                const tokenFromCache = tokenCache.find(tok => tok.key === fbKey);
                if (tokenFromCache) {
                    const db = dbInstances[tokenFromCache.firebaseGroup];
                    if (db) {
                        deletePromises.push(remove(ref(db, 'tokens/' + fbKey)));
                        deletePromises.push(remove(ref(db, `exam_access_status/${fbKey}`)));
                        deletePromises.push(remove(ref(db, `submitted_exams/${fbKey}`)));
                        deletePromises.push(remove(ref(db, `student_answers/${fbKey}`)));
                    }
                }
            }
            await Promise.all(deletePromises);
            showNotification('Token berhasil dihapus dari semua database yang relevan!');
        } catch (err) {
            console.error("Gagal menghapus token:", err); // Pesan disesuaikan
            showNotification("Gagal menghapus token: " + err.message);
        } finally {
            loadingOverlay.style.display = 'none'; // Sembunyikan loading
            closeDeleteModal();
            currentConsolidatedTokenInfo = null; // Reset consolidated info
        }
      }
    };

    // Fungsi untuk menutup modal penghapusan token
    window.closeDeleteModal = () => {
      document.getElementById('deleteModal').style.display = 'none';
      deleteId = null;
    };

    // Opsional: Tutup modal saat mengklik di luar konten modal
    window.onclick = function(event) {
        // Hanya tutup jika klik berada di latar belakang modal itu sendiri, bukan kontennya
        if (event.target == printInfoModal) {
            printInfoModal.style.display = 'none';
        }
        if (event.target == editModal) {
            closeEditModal();
        }
        if (event.target == deleteModal) {
            closeDeleteModal();
        }
        if (event.target == forceActiveModal) {
            closeForceActiveModal();
        }
        if (event.target == forceInactiveModal) {
            closeForceInactiveModal();
        }
        if (event.target == copyPrintModal) { // Handle generic print modal
            closeCopyPrintModal();
        }
        if (event.target == setlokasiModalElement) {
            closeSetlokasiModal();
        }
        if (event.target == gantiRadiusModalElement) {
            closeGantiRadiusModal();
        }
        // NEW: Lock settings modals
        if (event.target == setLockModalElement) {
            closeSetLockModal();
        }
        if (event.target == gantiKunciBatasModalElement) {
            closeGantiKunciBatasModal();
        }

        if (event.target == accessDetailModal) {
            closeAccessDetailModal();
        }
        if (event.target == editStudentModal) {
            closeEditStudentModal();
        }
        if (event.target == deleteStudentConfirmModal) {
            closeDeleteStudentConfirmModal();
        }
        if (event.target == importStudentModal) {
            closeImportStudentModal();
        }
        if (event.target == importResultModal) {
            closeImportResultModal();
        }
        if (event.target == emptyStudentsModal) {
            closeEmptyStudentsModal();
        }
        if (event.target == logoutConfirmModal) {
            closeLogoutModal();
        }
        // New modals for student actions
        if (event.target == resetStudentModal) {
            closeResetStudentModal();
        }
        if (event.target == submitAnswerModal) {
            closeSubmitAnswerModal();
        }
        if (event.target == deleteAnswerModal) {
            closeDeleteAnswerModal();
        }
    };

    // Fungsi untuk menampilkan konfirmasi token paksa aktif
    window.promptForceActive = (representativeKey) => {
      const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.firebaseKeys.has(representativeKey));
      if (!consolidatedToken) return;
      currentConsolidatedTokenInfo = consolidatedToken; // Store for action
      document.getElementById('forceActivePassword').value = ''; // Bersihkan kata sandi sebelumnya
      document.getElementById('forceActivePasswordError').innerText = ''; // Bersihkan pesan kesalahan sebelumnya
      document.getElementById('forceActiveModal').style.display = 'flex';
    };

    // Fungsi untuk menampilkan konfirmasi token paksa tidak aktif
    window.promptForceInactive = (representativeKey) => {
      const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => t.firebaseKeys.has(representativeKey));
      if (!consolidatedToken) return;
      currentConsolidatedTokenInfo = consolidatedToken;
      document.getElementById('forceInactiveModal').style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi token paksa aktif
    window.confirmForceActive = async () => {
      const password = document.getElementById('forceActivePassword').value;
      const passwordError = document.getElementById('forceActivePasswordError');

      if (password !== ADMIN_PASS) {
        passwordError.innerText = "Password salah!";
        return;
      }

      if (currentConsolidatedTokenInfo) {
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = [];
            for (const fbKey of Array.from(currentConsolidatedTokenInfo.firebaseKeys)) {
                const tokenFromCache = tokenCache.find(tok => tok.key === fbKey);
                if (tokenFromCache) {
                    const db = dbInstances[tokenFromCache.firebaseGroup];
                    if (db) {
                        updatePromises.push(update(ref(db, 'tokens/' + fbKey), { isForceActive: true, isActive: true }));
                    }
                }
            }
            await Promise.all(updatePromises);
            showNotification('Token dipaksa aktif di semua database yang relevan!');
            // Render ulang tabel akan ditangani oleh listener onValue untuk 'tokens'
        } catch (error) {
            console.error("Gagal mengaktifkan status paksa: ", error);
            showNotification("Gagal mengaktifkan status paksa.");
        } finally {
            closeForceActiveModal();
            currentConsolidatedTokenInfo = null;
        }
      } else {
        closeForceActiveModal();
        currentConsolidatedTokenInfo = null;
      }
    };

    // Fungsi untuk menutup modal paksa aktif
    window.closeForceActiveModal = () => {
      document.getElementById('forceActiveModal').style.display = 'none';
      document.getElementById('forceActivePassword').value = '';
      document.getElementById('forceActivePasswordError').innerText = '';
      currentForceActiveTokenId = null;
    };

    // Fungsi untuk mengkonfirmasi token paksa tidak aktif
    window.confirmForceInactive = async () => {
      if (currentConsolidatedTokenInfo) {
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = [];
            for (const fbKey of Array.from(currentConsolidatedTokenInfo.firebaseKeys)) {
                const tokenFromCache = tokenCache.find(tok => tok.key === fbKey);
                if (tokenFromCache) {
                    const db = dbInstances[tokenFromCache.firebaseGroup];
                    if (db) {
                        updatePromises.push(update(ref(db, 'tokens/' + fbKey), { isForceActive: false }));
                    }
                }
            }
            await Promise.all(updatePromises);
            showNotification('Token paksa aktif dinonaktifkan di semua database yang relevan!');
            // Render ulang tabel akan ditangani oleh listener onValue untuk 'tokens'
        } catch (error) {
            console.error("Gagal menonaktifkan status paksa: ", error);
            showNotification("Gagal menonaktifkan token paksa.");
        } finally {
            closeForceInactiveModal();
            currentConsolidatedTokenInfo = null;
        }
      }
    };

    // Fungsi untuk menutup modal paksa tidak aktif
    window.closeForceInactiveModal = () => {
      document.getElementById('forceInactiveModal').style.display = 'none';
      currentForceActiveTokenId = null;
    };

    // Fungsi untuk memeriksa dan memperbarui status token di semua database
    async function periksaAndUpdateStatusToken() {
      const now = new Date();
      for (const tokenData of tokenCache) { // Iterate through original tokenCache
        let newIsActive;
        if (tokenData.isForceActive) {
          newIsActive = true; // Jika dipaksa aktif, selalu aktif
        } else {
          const startTime = new Date(tokenData.startTime);
          const endTime = new Date(tokenData.endTime);
          newIsActive = now >= startTime && now < endTime;
        }

        if (tokenData.isActive !== newIsActive) {
          // Dapatkan DB spesifik tempat token ini berada (berdasarkan firebaseGroup)
          const targetDb = dbInstances[tokenData.firebaseGroup];
          if (targetDb) {
            try {
              await update(ref(targetDb, 'tokens/' + tokenData.key), { isActive: newIsActive });
              console.log(`Token ${tokenData.key} from group ${tokenData.firebaseGroup} status updated to ${newIsActive ? 'active' : 'inactive'}.`);
              // Render ulang tabel akan ditangani oleh listener onValue untuk 'tokens'
            } catch (error) {
              console.error(`Failed to update token status ${tokenData.key} from group ${tokenData.firebaseGroup}: `, error);
            }
          } else {
            console.warn(`Could not find database for token ${tokenData.key} (group ${tokenData.firebaseGroup}) to update status.`);
          }
        }
      }
    }

    // Fungsi untuk memperbarui tampilan waktu saat ini
    function updateTime() {
      const now = new Date();
      const dateOptions = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const tanggal = now.toLocaleDateString('id-ID', dateOptions);
      const waktu = now.toLocaleTimeString('id-ID', timeOptions).replace(/\./g, ':');
      const display = `${tanggal} pukul ${waktu}`;
      const ct = document.getElementById("currentTime");
      if (ct) ct.innerText = display;
      const adt = document.getElementById("adminDateTime");
      if (adt) adt.innerText = display;
    }

    setInterval(updateTime, 1000);
    updateTime();

    // Fungsi untuk mereset timer tidak aktif
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(logoutDueToInactivity, INACTIVITY_TIMEOUT);
    }

    // Fungsi untuk menangani logout karena tidak aktif
    function logoutDueToInactivity() {
      localStorage.removeItem('isAdminLoggedIn');
      dashboardContent.style.display = 'none';
      sidebar.style.display = 'none';
      loginSection.style.display = 'block';
      document.getElementById('password').value = '';
      showNotification('Anda telah logout karena tidak ada aktivitas, masukan password kembali!.');
    }

    // Event listener untuk aktivitas pengguna untuk mereset timer tidak aktif
    window.addEventListener('mousemove', resetInactivityTimer);
    window.addEventListener('keypress', resetInactivityTimer);
    window.addEventListener('scroll', resetInactivityTimer);
    window.addEventListener('click', resetInactivityTimer);

    // Logika pemuatan halaman awal
    window.onload = function() {
      if (localStorage.getItem('isAdminLoggedIn') === 'true') {
        loginSection.style.display = 'none';
        sidebar.style.display = 'flex'; // Tampilkan sidebar saat dimuat jika sudah login
        dashboardContent.style.display = 'flex';
        
        // Memuat data dengan listener real-time
        loadTokens(); 
        loadStudents(); 
        loadTokenAccessStatus(); 
        loadSubmittedExamsStatus(); 
        loadSetlokasiSettings(); 
        loadStudentAnswers(); // NEW: Load student answers
        loadLockSettings(); // NEW: Load lock settings

        showSection('tokenSection'); // Tampilkan bagian token secara default
        resetInactivityTimer();
        collapseSidebar(); // Pastikan sidebar disembunyikan setelah login
      } else {
        loginSection.style.display = 'block';
        sidebar.style.display = 'none'; // Sembunyikan sidebar jika belum login
        dashboardContent.style.display = 'none';
        collapseSidebar(); // Pastikan sidebar disembunyikan di halaman login
      }
    };

    let statusCheckInterval;
    statusCheckInterval = setInterval(periksaAndUpdateStatusToken, 10000);

    // Fungsi untuk memperbarui tampilan tabel pengaturan lokasi
    function updateSetlokasiStatusDisplay() {
      locationSettingsTableBody.innerHTML = ''; // Hapus baris yang ada
      const row = document.createElement('tr');
      const statusText = isLocationEnabledAdmin ? 'ON' : 'OFF';
      const statusColor = isLocationEnabledAdmin ? 'green' : 'red';

      row.innerHTML = `
        <td><a href="http://maps.google.com/maps?q=$$$$$${escapeHtmlAttributeForJsString(defaultLocationCoordinate)}" target="_blank">${defaultLocationCoordinate}</a></td>
        <td>${allowedRadiusMeterAdmin}m</td>
        <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
        <td>
          <button class="icon-button" onclick="openSetlokasiModal()" title="Atur Lokasi">
            <i class="fas fa-map-marker-alt"></i>
          </button>
        </td>
      `;
      locationSettingsTableBody.appendChild(row);
    }

    // Fungsi untuk membuka modal pengaturan lokasi
    window.openSetlokasiModal = () => {
      setlokasiModalElement.style.display = 'flex';
    };

    // Fungsi untuk menutup modal pengaturan lokasi
    window.closeSetlokasiModal = () => {
      setlokasiModalElement.style.display = 'none';
    };

    // Fungsi untuk membuka modal ganti radius
    window.openGantiRadiusModal = () => {
      gantiRadiusModalElement.style.display = 'flex';
      radiusMeterInputElement.value = allowedRadiusMeterAdmin;
      closeSetlokasiModal();
    };

    // Fungsi untuk menutup modal ganti radius
    window.closeGantiRadiusModal = () => {
      gantiRadiusModalElement.style.display = 'none';
    };

    // Fungsi untuk mengaktifkan fitur lokasi (menggunakan semua db yang aktif)
    window.aktifkanLokasi = async () => {
      loadingOverlay.style.display = 'flex';
      try {
          const updatePromises = allSetlokasiRefs.map(dbRef => update(dbRef, { isLocationEnabled: true }));
          await Promise.all(updatePromises);
          isLocationEnabledAdmin = true;
          updateSetlokasiStatusDisplay();
          showNotification('Fitur lokasi berhasil diaktifkan di semua database.');
      } catch (error) {
          console.error("Gagal mengaktifkan lokasi:", error);
          showNotification('Gagal mengaktifkan fitur lokasi.');
      } finally {
          loadingOverlay.style.display = 'none';
          closeSetlokasiModal();
      }
    };

    // Fungsi untuk menonaktifkan fitur lokasi (menggunakan semua db yang aktif)
    window.nonaktifkanLokasi = async () => {
      loadingOverlay.style.display = 'flex';
      try {
          const updatePromises = allSetlokasiRefs.map(dbRef => update(dbRef, { isLocationEnabled: false }));
          await Promise.all(updatePromises);
          isLocationEnabledAdmin = false;
          updateSetlokasiStatusDisplay();
          showNotification('Fitur lokasi berhasil dinonaktifkan di semua database.');
      } catch (error) {
          console.error("Gagal menonaktifkan lokasi:", error);
          showNotification('Gagal menonaktifkan fitur lokasi.');
      } finally {
          loadingOverlay.style.display = 'none';
          closeSetlokasiModal();
      }
    };

    // Fungsi untuk mengubah radius dan mengaktifkan lokasi (menggunakan semua db yang aktif)
    window.gantiRadiusDanAktifkan = async () => {
      const radiusMeter = parseInt(radiusMeterInputElement.value);
      if (isNaN(radiusMeter) || radiusMeter <= 0) {
        showNotification('Masukkan radius yang valid dalam meter.');
        return;
      }
      const radiusKm = radiusMeter / 1000;

      loadingOverlay.style.display = 'flex';
      try {
          const updatePromises = allSetlokasiRefs.map(dbRef => update(dbRef, { allowedRadiusKm: radiusKm, isLocationEnabled: true }));
          await Promise.all(updatePromises);
          allowedRadiusMeterAdmin = radiusMeter;
          isLocationEnabledAdmin = true;
          updateSetlokasiStatusDisplay();
          showNotification(`Radius lokasi diubah menjadi ${radiusMeter} meter dan fitur lokasi diaktifkan di semua database.`);
      } catch (error) {
          console.error("Gagal mengganti radius:", error);
          showNotification('Gagal mengganti radius lokasi.');
      } finally {
          loadingOverlay.style.display = 'none';
          closeGantiRadiusModal();
      }
    };

    // Fungsi untuk memuat pengaturan lokasi dari Firebase (menggunakan 7ABC sebagai sumber utama)
    function loadSetlokasiSettings() {
      // Hanya mendengarkan dari satu database untuk menampilkan status di UI
      // Asumsi bahwa semua setlokasi di semua DB akan disinkronkan oleh fungsi aktifkan/nonaktifkan/gantiRadius
      onValue(ref(dbInstances['7ABC'], 'setlokasi'), (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
          isLocationEnabledAdmin = settings.isLocationEnabled !== undefined ? settings.isLocationEnabled : false; // Default ke false
          allowedRadiusMeterAdmin = (settings.allowedRadiusKm !== undefined ? settings.allowedRadiusKm : 0.075) * 1000;
          updateSetlokasiStatusDisplay();
        } else {
          // Jika node 'setlokasi' tidak ada, inisialisasi dengan nilai default
          // Ini akan membuat node di 7ABC jika belum ada
          update(ref(dbInstances['7ABC'], 'setlokasi'), { isLocationEnabled: false, allowedRadiusKm: 0.075 })
            .then(() => console.log("Node 'setlokasi' di 7ABC diinisialisasi."))
            .catch(error => console.error("Gagal menginisialisasi 'setlokasi' di 7ABC:", error));
          updateSetlokasiStatusDisplay(); // Tampilkan default sampai data dimuat
        }
      }, (error) => {
          console.error("Error memuat pengaturan lokasi:", error);
      });
    }

    // NEW: Fungsi untuk memperbarui tampilan tabel pengaturan kunci
    function renderLockSettingsTable() {
        lockSettingsTableBody.innerHTML = ''; // Hapus baris yang ada
        const row = document.createElement('tr');
        const statusText = isLockEnabledAdmin ? 'ON' : 'OFF';
        const statusColor = isLockEnabledAdmin ? 'green' : 'red';

        row.innerHTML = `
            <td>${escapeHtmlAttributeForJsString(currentLockKeyAdmin)}</td>
            <td>${toleranceLimitAdmin}</td>
            <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
            <td>
              <button class="icon-button edit" onclick="openSetLockModal()" title="Atur Kunci">
                <i class="fas fa-edit"></i>
              </button>
            </td>
        `;
        lockSettingsTableBody.appendChild(row);
    }

    // NEW: Fungsi untuk memuat pengaturan kunci dari Firebase
    function loadLockSettings() {
        // Hanya mendengarkan dari satu database untuk menampilkan status di UI
        onValue(ref(dbInstances['7ABC'], 'lock_settings'), (snapshot) => {
            const settings = snapshot.val();
            if (settings) {
                isLockEnabledAdmin = settings.isLockEnabled !== undefined ? settings.isLockEnabled : false;
                currentLockKeyAdmin = settings.lockKey !== undefined ? settings.lockKey : "KUNCI";
                toleranceLimitAdmin = settings.toleranceLimit !== undefined ? settings.toleranceLimit : 3;
                renderLockSettingsTable();
            } else {
                // Jika node 'lock_settings' tidak ada, inisialisasi dengan nilai default
                update(ref(dbInstances['7ABC'], 'lock_settings'), { isLockEnabled: false, lockKey: "KUNCI", toleranceLimit: 3 })
                    .then(() => console.log("Node 'lock_settings' di 7ABC diinisialisasi."))
                    .catch(error => console.error("Gagal menginisialisasi 'lock_settings' di 7ABC:", error));
                renderLockSettingsTable(); // Tampilkan default sampai data dimuat
            }
        }, (error) => {
            console.error("Error memuat pengaturan kunci:", error);
        });
    }

    // NEW: Fungsi untuk membuka modal pengaturan kunci
    window.openSetLockModal = () => {
        setLockModalElement.style.display = 'flex';
    };

    // NEW: Fungsi untuk menutup modal pengaturan kunci
    window.closeSetLockModal = () => {
        setLockModalElement.style.display = 'none';
    };

    // NEW: Fungsi untuk mengaktifkan kunci (menggunakan semua db yang aktif)
    window.aktifkanKunci = async () => {
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = allLockSettingsRefs.map(dbRef => update(dbRef, { isLockEnabled: true }));
            await Promise.all(updatePromises);
            isLockEnabledAdmin = true;
            renderLockSettingsTable();
            showNotification('Fitur kunci berhasil diaktifkan di semua database.');
        } catch (error) {
            console.error("Gagal mengaktifkan kunci:", error);
            showNotification('Gagal mengaktifkan fitur kunci.');
        } finally {
            loadingOverlay.style.display = 'none';
            closeSetLockModal();
        }
    };

    // NEW: Fungsi untuk menonaktifkan kunci (menggunakan semua db yang aktif)
    window.nonaktifkanKunci = async () => {
        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = allLockSettingsRefs.map(dbRef => update(dbRef, { isLockEnabled: false }));
            await Promise.all(updatePromises);
            isLockEnabledAdmin = false;
            renderLockSettingsTable();
            showNotification('Fitur kunci berhasil dinonaktifkan di semua database.');
        } catch (error) {
            console.error("Gagal menonaktifkan kunci:", error);
            showNotification('Gagal menonaktifkan fitur kunci.');
        } finally {
            loadingOverlay.style.display = 'none';
            closeSetLockModal();
        }
    };

    // NEW: Fungsi untuk membuka modal ganti kunci dan batas toleransi
    window.openGantiKunciBatasModal = () => {
        gantiKunciBatasModalElement.style.display = 'flex';
        lockKeyInput.value = currentLockKeyAdmin;
        toleranceLimitInput.value = toleranceLimitAdmin;
        lockSettingsError.innerText = ''; // Clear any previous error
        closeSetLockModal(); // Close the parent modal
    };

    // NEW: Fungsi untuk menutup modal ganti kunci dan batas toleransi
    window.closeGantiKunciBatasModal = () => {
        gantiKunciBatasModalElement.style.display = 'none';
        lockSettingsError.innerText = '';
    };

    // NEW: Fungsi untuk mengganti kunci dan batas toleransi (menggunakan semua db yang aktif)
    window.gantiKunciDanBatas = async () => {
        const newLockKey = lockKeyInput.value.trim().toUpperCase();
        const newToleranceLimit = parseInt(toleranceLimitInput.value);

        if (!newLockKey) {
            lockSettingsError.innerText = 'Kunci tidak boleh kosong.';
            return;
        }
        if (isNaN(newToleranceLimit) || newToleranceLimit < 0) {
            lockSettingsError.innerText = 'Batas toleransi harus berupa angka non-negatif.';
            return;
        }

        loadingOverlay.style.display = 'flex';
        try {
            const updatePromises = allLockSettingsRefs.map(dbRef => update(dbRef, { 
                lockKey: newLockKey, 
                toleranceLimit: newToleranceLimit,
                isLockEnabled: true // Aktifkan kunci secara otomatis saat diganti
            }));
            await Promise.all(updatePromises);
            currentLockKeyAdmin = newLockKey;
            toleranceLimitAdmin = newToleranceLimit;
            isLockEnabledAdmin = true; // Update status
            renderLockSettingsTable();
            showNotification(`Kunci diubah menjadi '${newLockKey}' dan batas toleransi menjadi ${newToleranceLimit} di semua database.`);
        } catch (error) {
            console.error("Gagal mengganti kunci/batas toleransi:", error);
            showNotification('Gagal mengganti kunci/batas toleransi.');
        } finally {
            loadingOverlay.style.display = 'none';
            closeGantiKunciBatasModal();
        }
    };


    // Fungsi untuk membuka modal detail akses token
    window.openAccessDetailModal = async (representativeKey, tokenValue) => {
        accessDetailTokenTitle.innerText = `Detail Akses Token: ${tokenValue}`;
        accessDetailTableBody.innerHTML = '<tr><td colspan="6">Memuat data...</td></tr>';
        accessDetailModal.style.display = 'flex';

        // Find the original token data using the representative key
        const tokenData = tokenCache.find(t => t.key === representativeKey);
        if (!tokenData) {
            accessDetailTableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Token tidak ditemukan.</td></tr>';
            return;
        }

        // Use the firebaseGroup from the found tokenData to get the specific database
        const targetDb = dbInstances[tokenData.firebaseGroup];
        if (!targetDb) {
            accessDetailTableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Database untuk token ini tidak ditemukan.</td></tr>';
            return;
        }

        try {
            const accessSnapshot = await get(ref(targetDb, `exam_access_status/${tokenData.key}`)); // Use tokenData.key here
            const accessData = accessSnapshot.val();

            accessDetailTableBody.innerHTML = '';

            if (accessData) {
                let counter = 0;
                const sortedStudentIds = Object.keys(accessData).sort((a, b) => a.localeCompare(b));

                for (const studentId of sortedStudentIds) {
                    counter++;
                    const studentInfo = studentCache.find(s => s.id === studentId);
                    const studentSubmissionData = submittedExamsCache[tokenData.key] && submittedExamsCache[tokenData.key][studentId]; // Use tokenData.key
                    
                    const studentName = studentInfo ? studentInfo.name : 'Tidak Ditemukan';
                    const studentClass = studentInfo ? studentInfo.class : 'Tidak Ditemukan';
                    const firstAccessTime = accessData[studentId].firstAccessTime ? new Date(accessData[studentId].firstAccessTime).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
                    const accessCount = accessData[studentId].accessCount || 0;
                    const isLoggedIn = accessData[studentId].isLoggedIn === true;
                    const isSubmitted = studentSubmissionData && studentSubmissionData.isSubmitted === true;

                    let displayStatus = 'Belum Mengakses';
                    let statusColor = '';
                    if (isSubmitted) {
                        displayStatus = 'Sudah submit';
                        statusColor = 'green';
                    } else if (isLoggedIn) {
                        if (accessCount > 0) {
                            displayStatus = `Sedang mengerjakan (${accessCount})`;
                            statusColor = 'orange'; // Kuning/Oranye
                        } else {
                            displayStatus = 'Sedang mengerjakan'; // Login (Belum Akses)
                            statusColor = 'orange';
                        }
                    } else if (accessCount > 0) {
                        displayStatus = 'Belum login (reset)';
                        statusColor = 'purple';
                    } else {
                        displayStatus = 'Belum login';
                        statusColor = 'red';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${counter}</td>
                        <td>${escapeHtmlAttributeForJsString(studentId)}</td>
                        <td>${escapeHtmlAttributeForJsString(studentName)}</td>
                        <td>${escapeHtmlAttributeForJsString(studentClass)}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${displayStatus}</td>
                        <td>${firstAccessTime}</td>
                    `;
                    accessDetailTableBody.appendChild(row);
                }
            } else {
                accessDetailTableBody.innerHTML = '<tr><td colspan="6">Tidak ada data akses untuk token ini.</td></tr>';
            }
        } catch (error) {
            console.error("Error memuat detail akses:", error);
            accessDetailTableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Gagal memuat detail akses.</td></tr>';
        }
    };

    // Fungsi untuk menutup modal detail akses token
    window.closeAccessDetailModal = () => {
        accessDetailModal.style.display = 'none';
        accessDetailTableBody.innerHTML = '';
    };

    /* --- Fungsi Manajemen Siswa --- */

    // Fungsi pembantu untuk mengekstrak bagian numerik dan abjad untuk penyortiran kelas
    const extractClassParts = (className) => {
        const match = className.match(/^(\d+)([A-Z]+)?$/);
        if (match) {
            return { num: parseInt(match[1]), char: match[2] || '' }; // Tangani kasus seperti '7' tanpa karakter rombel
        }
        return { num: 0, char: String(className || '') }; // Fallback untuk format yang tidak terduga, pastikan string
    };

    // Fungsi untuk merender/memperbarui tabel siswa
    async function renderStudentTable() {
        studentTableBody.innerHTML = '';
        let counter = 0;
        const now = new Date();

        let studentsToDisplay = studentCache;

        // Terapkan filter kelas terlebih dahulu
        if (currentStudentClassFilter) {
            if (currentStudentClassFilter.endsWith('_all')) {
                const classPrefix = currentStudentClassFilter.split('_')[0];
                studentsToDisplay = studentsToDisplay.filter(student => String(student.class || '').startsWith(classPrefix));
            } else {
                studentsToDisplay = studentsToDisplay.filter(student => String(student.class || '') === currentStudentClassFilter);
            }
        }

        let selectedTokenForStatus = null;
        if (currentExamStatusFilterToken) {
            selectedTokenForStatus = tokenCache.find(t => t.key === currentExamStatusFilterToken);
            if (selectedTokenForStatus) {
                const tokenClassNumeric = getNumericClass(selectedTokenForStatus.kelas); 
                // Filter siswa lebih lanjut hanya untuk siswa yang kelasnya dimulai dengan kelas token
                studentsToDisplay = studentsToDisplay.filter(student => getNumericClass(student.class) === tokenClassNumeric);
            } else {
                // Token tidak ditemukan, mungkin dihapus? Bersihkan filter internal tetapi pertahankan pilihan visual
                currentExamStatusFilterToken = null; // Bersihkan filter internal
                showNotification("Token ujian yang dipilih tidak ditemukan atau telah dihapus. Menampilkan status saat ini.");
            }
        }

        // Logika penyortiran
        studentsToDisplay.sort((a, b) => {
            // Urutan utama: Berdasarkan status akses (Tidak Diakses/Tidak Aktif diprioritaskan)
            // HANYA JIKA token tertentu dipilih dalam filter status ujian
            if (currentExamStatusFilterToken) {
                let isAccessedA = (tokenAccessStatus[currentExamStatusFilterToken] && tokenAccessStatus[currentExamStatusFilterToken][a.id] && (tokenAccessStatus[currentExamStatusFilterToken][a.id].accessCount || 0) > 0);
                let isAccessedB = (tokenAccessStatus[currentExamStatusFilterToken] && tokenAccessStatus[currentExamStatusFilterToken][b.id] && (tokenAccessStatus[currentExamStatusFilterToken][b.id].accessCount || 0) > 0);

                if (!isAccessedA && isAccessedB) return -1;
                if (isAccessedA && !isAccessedB) return 1;
            }

            // Urutan kedua: Berdasarkan kelas (numerik kemudian abjad)
            const classA = extractClassParts(a.class);
            const classB = extractClassParts(b.class);

            if (classA.num !== classB.num) {
                return classA.num - classB.num;
            }
            // Pastikan penyortiran abjad untuk karakter kelas (misalnya, A, B, C)
            if (classA.char !== classB.char) {
                return classA.char.localeCompare(classB.char);
            }

            // Urutan ketiga: Berdasarkan nama
            return String(a.name || '').localeCompare(String(b.name || '')); // Bandingkan nama dengan aman
        });

        // Loop rendering
        for (const student of studentsToDisplay) {
            counter++;
            const row = document.createElement('tr');
            let studentStatus = '';
            let statusColor = '';

            // Dapatkan kelas numerik siswa
            const studentNumericClass = getNumericClass(student.class);

            // Temukan semua token yang relevan untuk kelas siswa ini
            const relevantTokensForStudent = tokenCache.filter(token => 
                getNumericClass(token.kelas) === studentNumericClass
            );

            let hasSubmittedAnyRelevantToken = false;
            let hasActiveRelevantToken = false;
            let hasAccessedAnyRelevantToken = false;
            let hasPastActiveRelevantToken = false;
            let isLoggedInForAnyRelevantToken = false;
            let isResetForAnyRelevantToken = false;
            let totalAccessCount = 0;

            for (const token of relevantTokensForStudent) {
                const tokenAccessData = tokenAccessStatus[token.key] && tokenAccessStatus[token.key][student.id];
                // Menggunakan token.key sebagai parent node untuk submitted_exams
                const studentSubmissionData = submittedExamsCache[token.key] && submittedExamsCache[token.key][student.id];

                const isSubmitted = studentSubmissionData && studentSubmissionData.isSubmitted; // Check if isSubmitted is true
                const isTokenCurrentlyActive = token.isActive || token.isForceActive;
                const hasTokenStarted = new Date() >= new Date(token.startTime);
                const hasAccessEntry = !!tokenAccessData; // Apakah ada entri di exam_access_status

                if (isSubmitted) {
                    hasSubmittedAnyRelevantToken = true;
                }
                if (isTokenCurrentlyActive) {
                    hasActiveRelevantToken = true;
                }
                if (hasTokenStarted) {
                    hasPastActiveRelevantToken = true;
                }
                if (hasAccessEntry) {
                    if (tokenAccessData.accessCount > 0) {
                        hasAccessedAnyRelevantToken = true;
                        totalAccessCount += tokenAccessData.accessCount;
                    }
                    if (tokenAccessData.isLoggedIn) { // Check if isLoggedIn is true
                        isLoggedInForAnyRelevantToken = true;
                    }
                    if (tokenAccessData.isLoggedIn === false) { // Check if isLoggedIn is explicitly false (reset)
                        isResetForAnyRelevantToken = true;
                    }
                }
            }

            if (hasSubmittedAnyRelevantToken) {
                studentStatus = 'Sudah submit';
                statusColor = 'green';
            } else if (hasActiveRelevantToken) {
                if (isLoggedInForAnyRelevantToken) {
                    if (hasAccessedAnyRelevantToken) {
                        studentStatus = `Sedang mengerjakan (${totalAccessCount})`;
                        statusColor = 'orange'; // Kuning/Oranye
                    } else {
                        studentStatus = 'Sedang mengerjakan'; // Login (Belum Akses)
                        statusColor = 'orange';
                    }
                } else if (isResetForAnyRelevantToken) {
                    studentStatus = 'Belum login (reset)';
                    statusColor = 'purple';
                } else { // Token aktif, tetapi tidak ada entri akses atau isLoggedIn false
                    studentStatus = 'Belum login';
                    statusColor = 'red';
                }
            } else if (hasPastActiveRelevantToken) { // Token sudah berlalu
                if (hasAccessedAnyRelevantToken) {
                    studentStatus = 'Belum submit'; // Pernah akses tapi belum submit
                    statusColor = 'red';
                } else {
                    studentStatus = 'Belum mengerjakan'; // Token sudah berlalu, belum pernah akses
                    statusColor = 'red';
                }
            } else { // Tidak ada token yang relevan atau token belum aktif
                studentStatus = '-';
                statusColor = 'black';
            }

            row.innerHTML = `
                <td>${counter}</td>
                <td>${escapeHtmlAttributeForJsString(student.id)}</td>
                <td>${escapeHtmlAttributeForJsString(student.name)}</td>
                <td>${escapeHtmlAttributeForJsString(student.class)}</td>
                <td>${padRoomNumber(student.room)}</td> <td style="color: ${statusColor}; font-weight: bold;">${studentStatus}</td>
                <td>
                    <div class="student-action-buttons">
                        <button class="icon-button edit" onclick="openEditStudentModal('${escapeHtmlAttributeForJsString(student.key)}')" title="Edit Data Siswa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-button delete" onclick="openDeleteStudentConfirmModal('${escapeHtmlAttributeForJsString(student.key)}')" title="Hapus Siswa">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="icon-button reset" onclick="promptResetStudent('${escapeHtmlAttributeForJsString(student.key)}', '${escapeHtmlAttributeForJsString(student.id)}', '${escapeHtmlAttributeForJsString(student.name)}', '${escapeHtmlAttributeForJsString(student.class)}')" title="Reset Status Login">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="icon-button submit" onclick="promptSubmitAnswer('${escapeHtmlAttributeForJsString(student.key)}', '${escapeHtmlAttributeForJsString(student.id)}', '${escapeHtmlAttributeForJsString(student.name)}', '${escapeHtmlAttributeForJsString(student.class)}')" title="Kirim Jawaban Manual">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="icon-button erase" onclick="promptDeleteAnswer('${escapeHtmlAttributeForJsString(student.key)}', '${escapeHtmlAttributeForJsString(student.id)}', '${escapeHtmlAttributeForJsString(student.name)}', '${escapeHtmlAttributeForJsString(student.class)}')" title="Hapus Semua Jawaban">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>
                </td>
            `;
            studentTableBody.appendChild(row);
        }
    }

    // Fungsi untuk memuat data siswa dari semua proyek Firebase (dengan real-time listener)
    function loadStudents() {
        studentCache = []; // Reset cache awal
        Object.keys(dbInstances).forEach(dbName => { // Iterasi semua DB yang aktif
            const dbInstance = dbInstances[dbName];
            if (dbInstance) {
                onValue(ref(dbInstance, 'students'), (snapshot) => {
                    console.log(`[Real-time Update] Students for Firebase group ${dbName} updated.`);
                    const groupStudents = [];
                    snapshot.forEach(child => {
                        const data = child.val();
                        data.key = child.key;
                        data.firebaseGroup = dbName; // Simpan dari proyek Firebase mana asalnya
                        groupStudents.push(data);
                    });

                    // Perbarui studentCache global dengan data terbaru dari grup ini
                    studentCache = studentCache.filter(s => s.firebaseGroup !== dbName);
                    studentCache.push(...groupStudents);

                    // Tambahkan penyortiran ke studentCache untuk memastikan urutan dasar yang konsisten
                    studentCache.sort((a, b) => {
                        const classA = extractClassParts(a.class);
                        const classB = extractClassParts(b.class);

                        if (classA.num !== classB.num) {
                            return classA.num - classB.num;
                        }
                        if (classA.char !== classB.char) {
                            return classA.char.localeCompare(classB.char);
                        }
                        return String(a.name || '').localeCompare(String(b.name || '')); // Bandingkan nama dengan aman
                    });
                    
                    populateClassFilter(); // Isi filter kelas setelah siswa dimuat
                    renderStudentTable(); // Render ulang tabel setiap kali data siswa berubah
                    renderScoreTable(); // Perbarui tabel nilai juga
                }, (error) => {
                    console.error(`Error memuat siswa dari grup ${dbName}:`, error);
                });
            }
        });
    }

    // Event listener untuk formulir tambah/edit siswa
    studentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const studentId = padStudentId(studentIdInput.value.trim()); // Isi ID
        const studentName = studentNameInput.value.trim().toUpperCase().replace(/'/g, ''); // Huruf besar otomatis & hapus tanda petik
        const studentClass = studentClassInput.value.trim().toUpperCase(); // Huruf besar otomatis
        const studentRoom = padRoomNumber(studentRoomInput.value.trim()); // Dapatkan nilai ruangan dan isi
        studentErrorMsg.innerText = "";

        // Validasi input kelas siswa (rombel)
        if (!VALID_ROMBELS.includes(studentClass)) {
            studentErrorMsg.innerText = "Kelas siswa tidak valid. Gunakan format seperti 7A, 7B, 7C."; // Updated message
            return;
        }

        const targetDb = getDbForClass(studentClass); // Dapatkan satu DB berdasarkan rombel
        if (!targetDb || Array.isArray(targetDb)) { // Pastikan ini satu DB, bukan array
            studentErrorMsg.innerText = "Kelas siswa tidak valid atau konfigurasi Firebase belum lengkap untuk rombel ini.";
            return;
        }

        // Validasi ID Siswa (harus numerik)
        if (!/^\d+$/.test(studentId)) {
            studentErrorMsg.innerText = "ID Siswa harus berupa angka!";
            return;
        }

        // Periksa ID siswa duplikat dalam cache database target
        const isIdDup = studentCache.some(s => s.id === studentId && s.key !== currentStudentKey && s.firebaseGroup === targetDb.app.name);
        if (isIdDup) {
            studentErrorMsg.innerText = "ID Siswa sudah ada untuk kelas ini!";
            return;
        }

        // Bagian ini untuk menambahkan siswa baru.
        // Pengeditan sekarang ditangani oleh modal dan fungsi confirmEditStudent.
        push(ref(targetDb, 'students'), { id: studentId, name: studentName, class: studentClass, room: studentRoom, isLoggedIn: false }) // Tambahkan isLoggedIn: false secara default
            .then(() => {
                showNotification('Siswa berhasil ditambahkan.');
                studentForm.reset();
            })
            .catch(error => {
                studentErrorMsg.innerText = "Gagal menambahkan siswa: " + error.message;
            });
    });

    // Fungsi untuk membuka modal edit siswa
    window.openEditStudentModal = (key) => {
      const student = studentCache.find(s => s.key === key);
      if (!student) return;

      currentStudentKey = key; // Simpan kunci siswa yang sedang diedit
      modalStudentIdInput.value = student.id;
      modalStudentNameInput.value = student.name;
      modalStudentClassInput.value = student.class;
      modalStudentRoomInput.value = student.room || ''; // Isi input ruangan di modal edit, tangani jika tidak terdefinisi
      editStudentErrorMsg.innerText = ""; // Bersihkan pesan kesalahan sebelumnya
      editStudentModal.style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi edit siswa dari modal
    window.confirmEditStudent = async () => { // Jadikan async
        const studentId = padStudentId(modalStudentIdInput.value.trim()); // Isi ID
        const studentName = modalStudentNameInput.value.trim().toUpperCase().replace(/'/g, ''); // Hapus tanda petik
        const newStudentClass = modalStudentClassInput.value.trim().toUpperCase();
        const studentRoom = padRoomNumber(modalStudentRoomInput.value.trim()); // Dapatkan nilai ruangan dari modal dan isi
        editStudentErrorMsg.innerText = "";

        // Validasi input kelas siswa (rombel)
        if (!VALID_ROMBELS.includes(newStudentClass)) {
            editStudentErrorMsg.innerText = "Kelas siswa tidak valid. Gunakan format seperti 7A, 7B, 7C."; // Updated message
            return;
        }

        const originalStudentData = studentCache.find(s => s.key === currentStudentKey);
        if (!originalStudentData) {
            editStudentErrorMsg.innerText = "Data siswa asli tidak ditemukan.";
            return;
        }
        const oldStudentClass = originalStudentData.class;
        const oldDb = getDbForClass(oldStudentClass);
        const newDb = getDbForClass(newStudentClass);

        // Pastikan oldDb dan newDb adalah instance tunggal, bukan array
        if (!oldDb || Array.isArray(oldDb) || !newDb || Array.isArray(newDb)) {
            editStudentErrorMsg.innerText = "Kelas siswa tidak valid atau konfigurasi Firebase belum lengkap untuk rombel ini.";
            return;
        }

        if (!studentId || !studentName || !newStudentClass || !studentRoom) {
            editStudentErrorMsg.innerText = "Semua field harus diisi!";
            return;
        }

        if (!/^\d+$/.test(studentId)) {
            editStudentErrorMsg.innerText = "ID Siswa harus berupa angka!";
            return;
        }

        // Periksa ID siswa duplikat di database target (jika kelas berubah)
        // Atau dalam database yang sama (jika kelas tidak berubah)
        const isIdDup = studentCache.some(s => 
            s.id === studentId && 
            s.key !== currentStudentKey && // Kecualikan siswa yang sedang diedit
            s.firebaseGroup === newDb.app.name // Periksa terhadap nama grup DB baru
        );
        if (isIdDup) {
            editStudentErrorMsg.innerText = "ID Siswa sudah ada untuk kelas ini!";
            return;
        }

        loadingOverlay.style.display = 'flex'; // Tampilkan loading

        const updatedStudentData = {
            id: studentId,
            name: studentName,
            class: newStudentClass,
            room: studentRoom,
            isLoggedIn: originalStudentData.isLoggedIn !== undefined ? originalStudentData.isLoggedIn : false // Pertahankan status isLoggedIn
        };

        try {
            if (oldDb.app.name !== newDb.app.name) { // Periksa perubahan grup DB
                // Kelas telah berubah, lakukan operasi "pindah"
                console.log(`Siswa ${originalStudentData.id} dipindahkan dari grup ${oldDb.app.name} ke grup ${newDb.app.name}.`);

                // 1. Hapus siswa dari database lama
                await remove(ref(oldDb, 'students/' + currentStudentKey));
                console.log(`Siswa ${currentStudentKey} dihapus dari DB grup ${oldDb.app.name}.`);

                // 2. Hapus exam_access_status terkait untuk siswa ini dari database lama
                // Hanya perlu mencari token di DB lama karena siswa pindah ke DB baru
                const tokensInOldGroup = tokenCache.filter(t => t.firebaseGroup === oldDb.app.name);
                for (const token of tokensInOldGroup) {
                    const accessPath = `exam_access_status/${token.key}/${originalStudentData.id}`;
                    const accessSnapshot = await get(ref(oldDb, accessPath)); // Periksa apakah jalur ada di targetDb
                    if (accessSnapshot.exists()) {
                        await remove(ref(oldDb, accessPath));
                    }
                }

                // 3. Hapus submitted_exams terkait untuk siswa ini dari database lama (menggunakan token.key)
                for (const token of tokensInOldGroup) {
                    const submittedPath = `submitted_exams/${token.key}/${originalStudentData.id}`; 
                    const submittedSnapshot = await get(ref(oldDb, submittedPath)); 
                    if (submittedSnapshot.exists()) {
                        await remove(ref(oldDb, submittedPath));
                    }
                }

                // NEW: 4. Hapus student_answers terkait untuk siswa ini dari database lama (menggunakan token.key)
                for (const token of tokensInOldGroup) {
                    const studentAnswersPath = `student_answers/${token.key}/${originalStudentData.id}`; 
                    const studentAnswersSnapshot = await get(ref(oldDb, studentAnswersPath)); 
                    if (studentAnswersSnapshot.exists()) {
                        await remove(ref(oldDb, studentAnswersPath));
                    }
                }

                // 5. Tambahkan siswa ke database baru
                await push(ref(newDb, 'students'), updatedStudentData);
                showNotification(`Siswa berhasil dipindahkan ke kelas ${newStudentClass}! Riwayat akses/pengiriman siswa di kelas lama telah direset.`);
            } else {
                // Kelas tidak berubah (tetap di grup DB yang sama), cukup perbarui di database yang sama
                await update(ref(newDb, 'students/' + currentStudentKey), updatedStudentData);
                showNotification('Data siswa berhasil diperbarui.');
            }
            closeEditStudentModal();
        } catch (error) {
            editStudentErrorMsg.innerText = "Gagal memperbarui siswa: " + error.message;
            console.error("Error updating student:", error);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };

    // Fungsi untuk menutup modal edit siswa
    window.closeEditStudentModal = () => {
        editStudentModal.style.display = 'none';
        editStudentErrorMsg.innerText = "";
        currentStudentKey = null; // Reset kunci siswa yang sedang diedit
    };

    // Fungsi untuk membuka modal konfirmasi penghapusan siswa
    window.openDeleteStudentConfirmModal = (key) => {
        deleteStudentKey = key; // Simpan kunci siswa yang akan dihapus
        deleteStudentConfirmModal.style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi penghapusan siswa
    window.confirmDeleteStudent = async () => { // Jadikan async
        if (deleteStudentKey) {
            const studentToDelete = studentCache.find(s => s.key === deleteStudentKey);
            if (!studentToDelete) {
                showNotification("Siswa tidak ditemukan.");
                closeDeleteStudentConfirmModal();
                return;
            }
            const studentId = studentToDelete.id; // Dapatkan ID siswa yang diisi
            const targetDb = getDbForClass(studentToDelete.class); // Dapatkan db berdasarkan rombel siswa
            if (!targetDb || Array.isArray(targetDb)) { // Pastikan ini satu DB, bukan array
                showNotification("Gagal menghapus: Database untuk kelas siswa tidak ditemukan.");
                closeDeleteStudentConfirmModal();
                return;
            }

            loadingOverlay.style.display = 'flex'; // Tampilkan loading

            try {
                // 1. Hapus catatan siswa itu sendiri dari database spesifiknya
                await remove(ref(targetDb, 'students/' + deleteStudentKey));

                // 2. Hapus status akses terkait untuk siswa ini di semua token (dari database spesifiknya)
                // Iterasi melalui token *dari grup DB yang sama* dengan siswa
                const tokensInStudentGroup = tokenCache.filter(t => t.firebaseGroup === targetDb.app.name);
                for (const token of tokensInStudentGroup) {
                    const accessPath = `exam_access_status/${token.key}/${studentId}`;
                    const accessSnapshot = await get(ref(targetDb, accessPath)); // Periksa apakah jalur ada di targetDb
                    if (accessSnapshot.exists()) {
                        await remove(ref(targetDb, accessPath));
                    }
                }

                // 3. Hapus submitted_exams terkait untuk siswa ini di semua token (dari database spesifiknya)
                for (const token of tokensInStudentGroup) {
                    const submittedPath = `submitted_exams/${token.key}/${studentId}`; // Gunakan token.key di sini
                    const submittedSnapshot = await get(ref(targetDb, submittedPath)); 
                    if (submittedSnapshot.exists()) {
                        await remove(ref(targetDb, submittedPath));
                    }
                }

                // NEW: 4. Hapus student_answers terkait untuk siswa ini dari database spesifiknya
                for (const token of tokensInStudentGroup) {
                    const studentAnswersPath = `student_answers/${token.key}/${studentId}`; 
                    const studentAnswersSnapshot = await get(ref(targetDb, studentAnswersPath)); 
                    if (studentAnswersSnapshot.exists()) {
                        await remove(ref(targetDb, studentAnswersPath));
                    }
                }

                showNotification('Siswa dan semua data terkait berhasil dihapus.');
            } catch (error) {
                console.error("Gagal menghapus siswa dan data terkait:", error);
                showNotification("Gagal menghapus siswa dan data terkait: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none'; // Sembunyikan loading
                closeDeleteStudentConfirmModal();
            }
        }
    };

    // Fungsi untuk menutup modal konfirmasi penghapusan siswa
    window.closeDeleteStudentConfirmModal = () => {
        deleteStudentConfirmModal.style.display = 'none';
        deleteStudentKey = null; // Reset kunci siswa yang akan dihapus
    };

    // --- Fungsi Impor Siswa dari CSV ---

    // Fungsi untuk membuka modal impor siswa
    window.openImportStudentModal = () => {
        importStudentModal.style.display = 'flex';
        csvFileInput.value = ''; // Bersihkan input file
        importFileError.innerText = ''; // Bersihkan kesalahan pesan
    };

    // Fungsi untuk menutup modal impor siswa
    window.closeImportStudentModal = () => {
        importStudentModal.style.display = 'none';
    };

    // Fungsi untuk menutup modal hasil impor
    window.closeImportResultModal = () => {
        importResultModal.style.display = 'none';
        importResultSummary.innerText = '';
        importResultDetails.innerHTML = '';
    };

    // Fungsi untuk memproses file CSV
    window.processCsvFile = async () => {
        if (isImporting) {
            showNotification('Proses impor sedang berjalan, harap tunggu.');
            return;
        }

        const file = csvFileInput.files[0];
        if (!file) {
            importFileError.innerText = 'Pilih file CSV terlebih dahulu.';
            return;
        }

        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            importFileError.innerText = 'File harus berformat CSV.';
            return;
        }

        importFileError.innerText = '';
        isImporting = true; // Set flag menjadi true
        loadingOverlay.style.display = 'flex'; // Tampilkan spinner loading

        const reader = new FileReader();

        reader.onload = async (e) => {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');

            let importedCount = 0;
            let skippedCount = 0;
            let errorDetails = [];
            
            // Objek untuk menampung pembaruan untuk setiap database
            // Menggunakan nama grup DB sebagai kunci
            const batchUpdateMap = {
                '7ABC': {}, '7DEF': {} // Only for class 7
            };

            // Mulai membaca dari baris kedua (indeks 1) untuk melewati header
            const dataLines = lines.slice(1); 

            for (let i = 0; i < dataLines.length; i++) {
                const line = dataLines[i];
                // Coba pisahkan dengan koma terlebih dahulu
                let parts = line.split(',');
                let delimiter = ',';

                // Jika pemisahan koma tidak menghasilkan 4 bagian, coba titik koma
                if (parts.length !== 4) {
                    parts = line.split(';');
                    delimiter = ';';
                }

                const originalLineNumber = i + 2; // Nomor baris asli di file CSV (karena kita slice(1))

                if (parts.length !== 4) {
                    errorDetails.push(`Baris ${originalLineNumber}: Format tidak valid (diharapkan ID,Nama,Kelas,Ruang). Baris: "${escapeHtmlAttributeForJsString(line)}"`);
                    skippedCount++;
                    continue;
                }

                const id = padStudentId(parts[0].trim());
                const name = parts[1].trim().toUpperCase().replace(/'/g, ''); // Hapus tanda petik
                const studentClass = parts[2].trim().toUpperCase(); // Ini adalah rombel (e.g., 7A)
                const studentRoom = padRoomNumber(parts[3].trim());

                // Validasi rombel
                if (!VALID_ROMBELS.includes(studentClass)) {
                    errorDetails.push(`Baris ${originalLineNumber}: Kelas siswa '${escapeHtmlAttributeForJsString(studentClass)}' tidak valid. Gunakan format seperti 7A, 7B, 7C.`); // Updated message
                    skippedCount++;
                    continue;
                }

                const targetDbName = rombelToDbMap[studentClass]; // Dapatkan nama grup DB dari rombel
                const targetDb = dbInstances[targetDbName];
                const targetBatch = batchUpdateMap[targetDbName];

                if (!targetDb || !targetBatch) {
                    errorDetails.push(`Baris ${originalLineNumber}: Kelas siswa '${escapeHtmlAttributeForJsString(studentClass)}' tidak valid atau konfigurasi Firebase belum lengkap untuk rombel ini.`);
                    skippedCount++;
                    continue;
                }

                // Validasi ID Siswa (harus numerik)
                if (!/^\d+$/.test(id)) {
                    errorDetails.push(`Baris ${originalLineNumber}: ID Siswa '${escapeHtmlAttributeForJsString(id)}' tidak valid (harus angka).`);
                    skippedCount++;
                    continue;
                }

                // Validasi Nama Siswa (tidak boleh kosong)
                if (name === "") {
                    errorDetails.push(`Baris ${originalLineNumber}: Nama Siswa tidak boleh kosong.`);
                    skippedCount++;
                    continue;
                }

                // Periksa ID siswa duplikat di cache lokal (sebelum mendorong ke Firebase)
                const isIdDup = studentCache.some(s => s.id === id && s.firebaseGroup === targetDbName);
                if (isIdDup) {
                    errorDetails.push(`Baris ${originalLineNumber}: Siswa dengan ID '${escapeHtmlAttributeForJsString(id)}' sudah ada untuk kelas ${escapeHtmlAttributeForJsString(studentClass)}, dilewati.`);
                    skippedCount++;
                    continue;
                }

                // Hasilkan kunci baru dan tambahkan ke objek pembaruan batch yang sesuai
                const newRef = push(ref(targetDb, 'students')); // Dapatkan referensi baru dengan kunci unik untuk db tertentu
                targetBatch[newRef.key] = { id: id, name: name, class: studentClass, room: studentRoom, isLoggedIn: false }; // Inisialisasi isLoggedIn
                importedCount++; // Tingkatkan segera untuk tujuan tampilan
            }

            try {
                const batchPromises = [];
                Object.keys(batchUpdateMap).forEach(dbName => {
                    const batchData = batchUpdateMap[dbName];
                    if (Object.keys(batchData).length > 0) {
                        batchPromises.push(update(ref(dbInstances[dbName], 'students'), batchData));
                    }
                });
                
                await Promise.all(batchPromises);
                showNotification(`${importedCount} siswa berhasil diimpor!`);
            } catch (error) {
                console.error("Gagal melakukan impor batch:", error);
                showNotification(`Gagal mengimpor data: ${error.message}`);
                // Jika seluruh batch gagal, semua importedCount yang sebelumnya dihitung harus dianggap dilewati/gagal
                skippedCount += importedCount;
                importedCount = 0;
                errorDetails.push(`Kesalahan umum saat menyimpan ke Firebase: ${error.message}`);
            } finally {
                isImporting = false; // Reset flag setelah impor selesai
                loadingOverlay.style.display = 'none';
                closeImportStudentModal();
                displayImportResults(importedCount, skippedCount, errorDetails);
            }
        };

        reader.onerror = () => {
            isImporting = false; // Reset flag saat ada kesalahan juga
            loadingOverlay.style.display = 'none';
            importFileError.innerText = 'Gagal membaca file.';
        };

        reader.readAsText(file);
    };

    // Fungsi untuk menampilkan hasil impor
    function displayImportResults(importedCount, skippedCount, errorDetails) {
        importResultSummary.innerHTML = `Berhasil diimpor: <span style="font-weight: bold; color: green;">${importedCount}</span>, Dilewati/Gagal: <span style="font-weight: bold; color: orange;">${skippedCount}</span>.`;
        importResultDetails.innerHTML = '';

        if (errorDetails.length > 0) {
            errorDetails.forEach(detail => {
                const li = document.createElement('li');
                li.style.color = 'red';
                li.innerText = detail;
                importResultDetails.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.style.color = 'green';
            li.innerText = 'Semua data berhasil diimpor atau tidak ada masalah yang ditemukan.';
            importResultDetails.appendChild(li);
        }
        importResultModal.style.display = 'flex';
    }

    // --- Fungsi Kosongkan Daftar Siswa ---
    window.openEmptyStudentsModal = () => {
        emptyStudentsPasswordInput.value = ''; // Bersihkan kata sandi
        emptyStudentsPasswordError.innerText = ''; // Bersihkan kesalahan
        emptyStudentsModal.style.display = 'flex';
    };

    window.closeEmptyStudentsModal = () => {
        emptyStudentsModal.style.display = 'none';
    };

    window.confirmEmptyStudents = async () => {
        const password = emptyStudentsPasswordInput.value;
        if (password !== ADMIN_PASS) {
            emptyStudentsPasswordError.innerText = "Password salah!";
            return;
        }

        loadingOverlay.style.display = 'flex'; // Tampilkan spinner loading
        try {
            const deletePromises = [];
            Object.keys(dbInstances).forEach(dbName => { // Iterasi semua DB yang aktif
                const dbInstance = dbInstances[dbName];
                if (dbInstance) {
                    deletePromises.push(remove(ref(dbInstance, 'students'))); // Hapus semua data siswa untuk setiap kelas
                    deletePromises.push(remove(ref(dbInstance, 'exam_access_status'))); // Hapus status akses untuk setiap kelas
                    deletePromises.push(remove(ref(dbInstance, 'submitted_exams'))); // Hapus status pengiriman untuk setiap kelas
                    deletePromises.push(remove(ref(dbInstance, 'student_answers'))); // NEW: Hapus jawaban siswa untuk setiap kelas
                }
            });
            await Promise.all(deletePromises);
            
            showNotification('Semua data peserta berhasil dikosongkan!');
        } catch (error) {
            console.error("Gagal mengosongkan daftar peserta:", error);
            showNotification('Gagal mengosongkan daftar peserta: ' + error.message);
        } finally {
            loadingOverlay.style.display = 'none'; // Sembunyikan spinner loading
            closeEmptyStudentsModal();
        }
    };

    // --- Fungsi Filter Siswa (berdasarkan kelas) ---
    window.filterStudentsByClass = (filterValue) => {
        currentStudentClassFilter = filterValue === "" ? null : filterValue; // null untuk "SEMUA KELAS"
        renderStudentTable();
    };

    // Fungsi untuk mengisi dropdown filter kelas
    function populateClassFilter() {
        classFilterDropdownSelect.innerHTML = '<option value="">SEMUA KELAS</option>'; // Opsi default

        // Kumpulkan tingkat kelas unik (7) dan rombel (7A, 7B, dll.)
        const grades = new Set();
        const rombels = new Set();

        studentCache.forEach(student => {
            const classMatch = String(student.class || '').match(/^(\d+)([A-Z]+)?$/); // Akses student.class dengan aman
            if (classMatch) {
                const grade = classMatch[1];
                const rombel = classMatch[2];
                grades.add(parseInt(grade));
                if (rombel) {
                    rombels.add(student.class);
                }
            }
        });

        // Urutkan tingkat kelas secara numerik
        const sortedGrades = Array.from(grades).sort((a, b) => a - b);
        // Urutkan rombel secara abjad
        const sortedRombels = Array.from(rombels).sort((a, b) => {
            const classA = extractClassParts(a);
            const classB = extractClassParts(b);
            if (classA.num !== classB.num) {
                return classA.num - classB.num;
            }
            return classA.char.localeCompare(classB.char);
        });

        sortedGrades.forEach(grade => {
            // Tambahkan opsi "Semua Rombel X"
            const allRombelOption = document.createElement('option');
            allRombelOption.value = `${grade}_all`;
            allRombelOption.innerText = `KELAS ${grade} (SEMUA ROMBEL)`;
            classFilterDropdownSelect.appendChild(allRombelOption);

            // Tambahkan opsi rombel spesifik untuk tingkat kelas ini
            sortedRombels.filter(r => String(r || '').startsWith(String(grade))) // Akses r dengan aman
                         .forEach(rombel => {
                const rombelOption = document.createElement('option');
                rombelOption.value = rombel;
                rombelOption.innerText = rombel;
                classFilterDropdownSelect.appendChild(rombelOption);
            });
        });

        // Atur nilai yang dipilih jika filter aktif
        if (currentStudentClassFilter) {
            classFilterDropdownSelect.value = currentStudentClassFilter;
        } else {
            classFilterDropdownSelect.value = ""; // Pastikan "SEMUA KELAS" dipilih jika tidak ada filter
        }
    }


    // --- Fungsi Filter Siswa (berdasarkan status ujian/token) ---
    window.filterStudentsByExamStatus = (selectedTokenKey) => {
        currentExamStatusFilterToken = selectedTokenKey === "" ? null : selectedTokenKey;
        renderStudentTable();
    };

    // Fungsi untuk mengisi dropdown filter status ujian
    function populateExamStatusFilter() {
        examStatusFilterDropdown.innerHTML = '<option value="">TOKEN SAAT INI</option>'; // Teks diubah di sini
        // Only add consolidated tokens to the filter dropdown
        Array.from(consolidatedTokensMap.values()).forEach(token => {
            const option = document.createElement('option');
            option.value = Array.from(token.firebaseKeys)[0]; // Use a representative key for the value
            option.innerText = `${token.token} (${token.subject} Kelas ${token.kelas})`;
            examStatusFilterDropdown.appendChild(option);
        });
        // Atur nilai yang dipilih jika filter aktif
        if (currentExamStatusFilterToken) {
            examStatusFilterDropdown.value = currentExamStatusFilterToken;
        }
    }

    /* --- Fungsi Manajemen Nilai Ujian (BARU) --- */

    // Fungsi untuk menyingkat nama mata pelajaran
    function abbreviateSubject(subjectName) {
        if (!subjectName) return '';
        const words = subjectName.split(' ').filter(w => w.length > 0);
        if (words.length === 0) return '';
        if (words.length === 1) {
            return words[0].substring(0, 3).toUpperCase();
        } else if (words.length === 2) {
            // Ambil huruf pertama dari suku kata pertama + huruf pertama dari suku kata kedua + huruf terakhir dari suku kata kedua
            return (words[0].charAt(0) + words[1].charAt(0) + words[1].slice(-1)).toUpperCase();
        } else if (words.length === 3) {
            // Ambil huruf pertama dari setiap suku kata
            return (words[0].charAt(0) + words[1].charAt(0) + words[2].charAt(0)).toUpperCase();
        } else if (words.length >= 4) {
            // Ambil 3 huruf depan dari setiap suku kata (atau kurang jika suku kata pendek)
            return words.map(word => word.substring(0, Math.min(3, word.length))).join('').toUpperCase();
        }
        return subjectName.toUpperCase(); // Fallback
    }

    /**
     * Fungsi untuk menghitung nilai berdasarkan string jawaban siswa dan kunci jawaban.
     * @param {string} studentAnswersString - String jawaban siswa yang dipisahkan koma (contoh: "A,B,C,D").
     * @param {string} answerKeyString - String kunci jawaban yang dipisahkan koma (contoh: "A,B,C,D").
     * @returns {number} Nilai yang dihitung.
     */
    function calculateScore(studentAnswersString, answerKeyString) {
        if (!answerKeyString || !studentAnswersString) return 0; // Tidak ada kunci jawaban atau jawaban siswa, nilai 0

        const correctAnswers = answerKeyString.split(',');
        const studentAnswers = studentAnswersString.split(','); // Parse string jawaban siswa
        const totalQuestions = correctAnswers.length;

        if (totalQuestions === 0) return 0; // Tidak ada soal, nilai 0

        let correctCount = 0;
        for (let i = 0; i < totalQuestions; i++) {
            // Pastikan kedua jawaban ada dan bandingkan
            // Jika jawaban siswa tidak ada (misal: A,,B,C), maka dianggap salah
            if (i < studentAnswers.length && studentAnswers[i].trim().toUpperCase() === correctAnswers[i].trim().toUpperCase()) {
                correctCount++;
            }
        }

        let score;
        if (totalQuestions === 30) {
            score = (correctCount / 30) * 100;
        } else if (totalQuestions === 40) {
            score = (correctCount / 40) * 100;
        } else if (totalQuestions === 50) {
            score = (correctCount / 50) * 100;
        } else {
            // Rumus umum untuk soal selain 30/40/50, pastikan 0-100
            score = (correctCount / totalQuestions) * 100;
        }

        // Pastikan nilai antara 0 dan 100
        score = Math.max(0, Math.min(100, score));

        // Bulatkan ke 2 angka desimal
        return parseFloat(score.toFixed(2));
    }

    // Fungsi untuk merender tabel nilai ujian
    function renderScoreTable() {
        scoreTableHeader.innerHTML = '<th>NO</th><th>NAMA SISWA</th><th>KELAS</th>'; // Reset header
        scoreTableBody.innerHTML = ''; // Reset body

        const subjects = new Set();
        // Kumpulkan semua mata pelajaran unik dari token yang sudah disubmit
        Array.from(consolidatedTokensMap.values()).forEach(token => { // Iterate consolidated tokens
            // Check if any of the underlying Firebase keys for this consolidated token have submissions or answers
            let hasRelevantData = false;
            for (const fbKey of Array.from(token.firebaseKeys)) {
                if ((submittedExamsCache[fbKey] && Object.keys(submittedExamsCache[fbKey]).length > 0) ||
                    (studentAnswersCache[fbKey] && Object.keys(studentAnswersCache[fbKey]).length > 0)) {
                    hasRelevantData = true;
                    break;
                }
            }
            if (hasRelevantData) {
                subjects.add(token.subject);
            }
        });
        const sortedSubjects = Array.from(subjects).sort((a, b) => a.localeCompare(b));

        // Tambahkan kolom mata pelajaran ke header
        sortedSubjects.forEach(subject => {
            const abbr = abbreviateSubject(subject); // Gunakan singkatan
            scoreTableHeader.innerHTML += `<th>${abbr}</th>`;
        });

        let studentsToDisplay = studentCache;

        // Filter berdasarkan angkatan (kelas 7)
        if (currentScoreGradeFilter) {
            studentsToDisplay = studentsToDisplay.filter(student => 
                getNumericClass(student.class) === String(currentScoreGradeFilter)
            );
            // Update active state for grade filter buttons
            document.querySelectorAll('.score-filters-container button').forEach(btn => {
                // Only check for the 'Kelas 7' button now
                if (parseInt(btn.innerText.replace('Kelas ', '')) === currentScoreGradeFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        } else {
            // No filter, remove active class from all grade buttons
            document.querySelectorAll('.score-filters-container button').forEach(btn => btn.classList.remove('active'));
        }

        // Filter berdasarkan pencarian nama
        const searchName = scoreSearchNameInput.value.trim().toUpperCase();
        if (searchName) {
            studentsToDisplay = studentsToDisplay.filter(student => 
                String(student.name || '').toUpperCase().includes(searchName)
            );
        }

        // Filter berdasarkan pencarian kelas
        const searchClass = scoreSearchClassInput.value.trim().toUpperCase();
        if (searchClass) {
            studentsToDisplay = studentsToDisplay.filter(student => 
                String(student.class || '').toUpperCase().includes(searchClass)
            );
        }

        // Urutkan siswa (sama dengan tabel peserta)
        studentsToDisplay.sort((a, b) => {
            const classA = extractClassParts(a.class);
            const classB = extractClassParts(b.class);

            if (classA.num !== classB.num) {
                return classA.num - classB.num;
            }
            if (classA.char !== classB.char) {
                return classA.char.localeCompare(classB.char);
            }
            return String(a.name || '').localeCompare(String(b.name || ''));
        });

        let counter = 0;
        studentsToDisplay.forEach(student => {
            counter++;
            const row = document.createElement('tr');
            row.innerHTML = `<td>${counter}</td><td>${escapeHtmlAttributeForJsString(student.name)}</td><td>${escapeHtmlAttributeForJsString(student.class)}</td>`;

            sortedSubjects.forEach(subject => {
                let score = '-'; // Default jika tidak ada nilai
                // Find the consolidated token for this subject and student's class
                const consolidatedToken = Array.from(consolidatedTokensMap.values()).find(t => 
                    t.subject === subject && getNumericClass(t.kelas) === getNumericClass(student.class)
                );

                if (consolidatedToken) {
                    // Iterate through all firebaseKeys associated with this consolidated token
                    for (const fbKey of Array.from(consolidatedToken.firebaseKeys)) {
                        const studentSubmission = submittedExamsCache[fbKey] && submittedExamsCache[fbKey][student.id];
                        const studentAnswerData = studentAnswersCache[fbKey] && studentAnswersCache[fbKey][student.id];

                        if (studentSubmission && studentSubmission.isSubmitted) {
                            const relevantRawToken = tokenCache.find(t => t.key === fbKey); // Get the raw token for answerKey
                            if (relevantRawToken && relevantRawToken.answerKey && studentAnswerData && studentAnswerData.answers) {
                                score = calculateScore(studentAnswerData.answers, relevantRawToken.answerKey);
                                break; // Found a submitted score, no need to check other keys for this subject
                            } else {
                                score = 'N/A'; // Kunci jawaban atau jawaban siswa tidak tersedia
                            }
                        }
                    }
                }
                row.innerHTML += `<td>${score}</td>`;
            });
            scoreTableBody.appendChild(row);
        });
    }

    // Fungsi untuk filter nilai berdasarkan angkatan
    window.filterScoresByGrade = (grade) => {
        currentScoreGradeFilter = grade;
        renderScoreTable();
    };

    // Fungsi untuk membuka modal cetak/salin generik
    window.openCopyPrintModal = (tableId, modalTitle) => {
        currentTableIdToCopy = tableId; // Simpan ID tabel yang akan disalin
        copyPrintModalTitle.innerText = modalTitle;
        copyPrintModal.style.display = 'flex';
    };

    // Fungsi untuk menutup modal cetak/salin generik
    window.closeCopyPrintModal = () => {
        copyPrintModal.style.display = 'none';
        currentTableIdToCopy = ''; // Reset ID tabel
    };

    // Fungsi untuk menyalin tabel ke clipboard
    window.copyTableToClipboard = () => {
        const table = document.getElementById(currentTableIdToCopy);
        if (!table) {
            showNotification('Tabel tidak ditemukan.');
            return;
        }

        // Buat tabel sementara untuk disalin agar tidak mengganggu tampilan asli
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px'; // Pindahkan dari layar
        tempDiv.innerHTML = table.outerHTML;
        document.body.appendChild(tempDiv); 

        const range = document.createRange();
        range.selectNode(tempDiv);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            document.execCommand('copy');
            showNotification('Tabel berhasil disalin. Tempelkan ke Word atau Excel.');
        } catch (err) {
            console.error('Gagal menyalin tabel:', err);
            showNotification('Gagal menyalin tabel. Coba salin manual.');
        }
        window.getSelection().removeAllRanges();
        document.body.removeChild(tempDiv);
        closeCopyPrintModal();
    };

    // Fungsi untuk memperbarui jumlah soal berdasarkan input kunci jawaban
    function updateAnswerKeyCount(answerKeyInputElem, countInputElem) {
        const key = answerKeyInputElem.value.trim();
        const count = key === '' ? 0 : key.split(',').filter(v => v.trim() !== '').length;
        countInputElem.value = count;
    }

    // Event listener untuk input kunci jawaban di formulir tambah token
    answerKeyInput.addEventListener('input', () => {
        updateAnswerKeyCount(answerKeyInput, answerKeyCountInput);
    });

    // Event listener untuk input kunci jawaban di modal edit token
    editAnswerKeyInput.addEventListener('input', () => {
        updateAnswerKeyCount(editAnswerKeyInput, editAnswerKeyCountInput);
    });

    // Panggil update count saat halaman dimuat (untuk formulir tambah)
    document.addEventListener('DOMContentLoaded', () => {
        updateAnswerKeyCount(answerKeyInput, answerKeyCountInput);
    });

    /* --- Fungsi Reset Siswa --- */
    window.promptResetStudent = (key, id, name, studentClass) => {
        studentKeyForAction = key;
        studentIdForAction = id;
        studentNameForAction = name;
        studentClassForAction = studentClass; // Ini adalah rombel (misal: 7A)
        resetStudentNameDisplay.innerText = name;
        resetStudentIdDisplay.innerText = id;
        resetStudentModal.style.display = 'flex';
    };

    window.confirmResetStudent = async () => {
        if (studentKeyForAction && studentIdForAction && studentClassForAction) {
            const targetDb = getDbForClass(studentClassForAction); // Dapatkan satu DB berdasarkan rombel
            if (!targetDb || Array.isArray(targetDb)) {
                showNotification("Gagal mereset: Database untuk kelas siswa tidak ditemukan.");
                closeResetStudentModal();
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                // 1. Update isLoggedIn status for the specific student in 'students' node
                // Note: Per your request, the isLoggedIn status is now primarily driven by the exam_access_status node.
                // This update to the 'students' node might not be strictly necessary for the new status logic,
                // but keeping it for consistency if other parts of the app rely on it.
                await update(ref(targetDb, 'students/' + studentKeyForAction), { isLoggedIn: false });

                // 2. Update isLoggedIn status in 'exam_access_status' for all relevant tokens
                // Get numeric class of the student for filtering relevant tokens
                const studentNumericClass = getNumericClass(studentClassForAction);

                // Filter tokens that belong to the same numeric class as the student AND the same Firebase group
                const relevantTokens = tokenCache.filter(token => 
                    getNumericClass(token.kelas) === studentNumericClass && token.firebaseGroup === targetDb.app.name
                );

                for (const token of relevantTokens) {
                    const accessStatusPath = `exam_access_status/${token.key}/${studentIdForAction}`;
                    const accessSnapshot = await get(ref(targetDb, accessStatusPath));
                    if (accessSnapshot.exists()) {
                        // Only update if the node exists and has isLoggedIn property
                        const currentAccessData = accessSnapshot.val();
                        if (currentAccessData.isLoggedIn !== undefined) {
                            await update(ref(targetDb, accessStatusPath), { isLoggedIn: false });
                        }
                    }
                }

                showNotification(`Status login siswa ${studentIdForAction} berhasil direset.`);
            } catch (error) {
                console.error("Gagal mereset status login siswa:", error);
                showNotification("Gagal mereset status login siswa: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
                closeResetStudentModal();
            }
        }
    };

    window.closeResetStudentModal = () => {
        resetStudentModal.style.display = 'none';
        studentKeyForAction = null;
        studentIdForAction = null;
        studentClassForAction = null;
    };

    /* --- Fungsi Kirim Jawaban Siswa --- */
    window.promptSubmitAnswer = (key, id, name, studentClass) => {
        studentKeyForAction = key;
        studentIdForAction = id;
        studentNameForAction = name;
        studentClassForAction = studentClass;
        submitStudentNameDisplay.innerText = name;
        submitStudentIdDisplay.innerText = id;
        submitAnswerModal.style.display = 'flex';
    };

    window.confirmSubmitAnswer = async () => {
        if (studentIdForAction && studentClassForAction) {
            const targetDb = getDbForClass(studentClassForAction); // Dapatkan satu DB berdasarkan rombel
            if (!targetDb || Array.isArray(targetDb)) {
                showNotification("Gagal mengirim jawaban: Database untuk kelas siswa tidak ditemukan.");
                closeSubmitAnswerModal();
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                // Find all relevant tokens for this student's class AND the same Firebase group
                const studentNumericClass = getNumericClass(studentClassForAction);
                const relevantTokens = tokenCache.filter(token => 
                    getNumericClass(token.kelas) === studentNumericClass && token.firebaseGroup === targetDb.app.name
                );

                const updates = {};
                for (const token of relevantTokens) {
                    // Use token.key for the path to submitted_exams
                    const studentSubmissionPath = `submitted_exams/${token.key}/${studentIdForAction}`;
                    const submissionSnapshot = await get(ref(targetDb, studentSubmissionPath));
                    const submissionData = submissionSnapshot.val();

                    if (submissionData && submissionData.isSubmitted === false) {
                        // If exists and not yet submitted, update it
                        updates[studentSubmissionPath + '/isSubmitted'] = true;
                        updates[studentSubmissionPath + '/timestamp'] = Date.now(); // Use timestamp as requested
                    } else if (!submissionData) {
                        // If no submission data exists, create a basic one and mark as submitted
                        updates[studentSubmissionPath] = {
                            isSubmitted: true,
                            timestamp: Date.now(), // Use timestamp as requested
                            answers: {} // Initialize with empty answers if none exist
                        };
                    }
                    // Note: If submissionData.isSubmitted is already true, do nothing.
                }

                if (Object.keys(updates).length > 0) {
                    await update(ref(targetDb, '/'), updates); // Apply all updates in a single batch
                    showNotification(`Jawaban siswa ${studentIdForAction} untuk ujian yang relevan berhasil ditandai sebagai 'Sudah submit'.`);
                } else {
                    showNotification(`Tidak ada ujian yang relevan untuk siswa ${studentIdForAction} yang perlu disubmit atau sudah disubmit.`);
                }
            } catch (error) {
                console.error("Gagal mengirim jawaban siswa:", error);
                showNotification("Gagal mengirim jawaban siswa: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
                closeSubmitAnswerModal();
            }
        }
    };

    window.closeSubmitAnswerModal = () => {
        submitAnswerModal.style.display = 'none';
        studentKeyForAction = null;
        studentIdForAction = null;
        studentNameForAction = null;
        studentClassForAction = null;
    };

    /* --- Fungsi Hapus Jawaban Siswa --- */
    window.promptDeleteAnswer = (key, id, name, studentClass) => {
        studentKeyForAction = key;
        studentIdForAction = id;
        studentNameForAction = name;
        studentClassForAction = studentClass;
        deleteAnswerStudentNameDisplay.innerText = name;
        deleteAnswerStudentIdDisplay.innerText = id;
        deleteAnswerPasswordInput.value = ''; // Clear password
        deleteAnswerPasswordError.innerText = ''; // Clear error
        deleteAnswerModal.style.display = 'flex';
    };

    window.confirmDeleteAnswer = async () => {
        const password = deleteAnswerPasswordInput.value;
        if (password !== ADMIN_PASS) {
            deleteAnswerPasswordError.innerText = "Password salah!";
            return;
        }

        if (studentIdForAction && studentClassForAction) {
            const targetDb = getDbForClass(studentClassForAction); // Dapatkan satu DB berdasarkan rombel
            if (!targetDb || Array.isArray(targetDb)) {
                showNotification("Gagal menghapus jawaban: Database untuk kelas siswa tidak ditemukan.");
                closeDeleteAnswerModal();
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                // Find all relevant tokens for this student's class AND the same Firebase group
                const studentNumericClass = getNumericClass(studentClassForAction);
                const relevantTokens = tokenCache.filter(token => 
                    getNumericClass(token.kelas) === studentNumericClass && token.firebaseGroup === targetDb.app.name
                );

                for (const token of relevantTokens) {
                    // 1. Delete submitted_exams entry (using token.key)
                    const submissionPath = `submitted_exams/${token.key}/${studentIdForAction}`;
                    const submissionSnapshot = await get(ref(targetDb, submissionPath));
                    if (submissionSnapshot.exists()) {
                        await remove(ref(targetDb, submissionPath));
                        console.log(`Submitted exam for student ${studentIdForAction} and token ${token.token} deleted.`);
                    }

                    // 2. Delete student_answers entry (using token.key)
                    const studentAnswersPath = `student_answers/${token.key}/${studentIdForAction}`;
                    const studentAnswersSnapshot = await get(ref(targetDb, studentAnswersPath));
                    if (studentAnswersSnapshot.exists()) {
                        await remove(ref(targetDb, studentAnswersPath));
                        console.log(`Student answers for student ${studentIdForAction} and token ${token.token} deleted.`);
                    }

                    // 3. Delete exam_access_status entry (using token.key for path)
                    const accessStatusPath = `exam_access_status/${token.key}/${studentIdForAction}`;
                    const accessSnapshot = await get(ref(targetDb, accessStatusPath));
                    if (accessSnapshot.exists()) {
                        await remove(ref(targetDb, accessStatusPath));
                        console.log(`Exam access status for student ${studentIdForAction} and token ${token.token} deleted.`);
                    }
                }
                showNotification(`Semua jawaban dan status terkait siswa ${studentIdForAction} berhasil dihapus.`);
            } catch (error) {
                console.error("Gagal menghapus jawaban siswa:", error);
                showNotification("Gagal menghapus jawaban siswa: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
                closeDeleteAnswerModal();
            }
        }
    };

    window.closeDeleteAnswerModal = () => {
        deleteAnswerModal.style.display = 'none';
        studentKeyForAction = null;
        studentIdForAction = null;
        studentNameForAction = null;
        studentClassForAction = null;
    };

  </script>
</body>
</html>
